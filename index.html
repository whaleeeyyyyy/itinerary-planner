<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Voyageur — Travel Itinerary Planner</title>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root {
      /* Forest & Gold palette */
      --forest: #1a4a2e;
      --forest-mid: #235a3a;
      --forest-light: #2e6b47;
      --cream: #f5f0eb;
      --parchment: #f0ebe5;
      --terracotta: #235a3a;
      --terra-light: #2e6b47;
      --gold: #c9a84c;
      --ink: #1a1a1a;
      --ink-mid: #2b2b2b;
      --mist: #aaaaaa;
      --white: #ffffff;
      --shadow: rgba(26, 74, 46, 0.12);
      --shadow-strong: rgba(26, 74, 46, 0.22);
      --day-bar-bg: #1a4a2e;
      --day-bar-text: #f5f0eb;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }
    *::before, *::after { box-sizing: border-box; }
    img, svg, video, canvas { max-width: 100%; height: auto; }

    html, body {
      width: 100%;
      max-width: 100%;
      overflow-x: hidden;
    }

    body {
      font-family: 'DM Sans', sans-serif;
      background: var(--cream);
      color: var(--ink);
      min-height: 100vh;
      font-size: 16px;
      line-height: 1.5;
      overflow-x: hidden;
      -webkit-text-size-adjust: 100%;
    }

    /* ─── Layout ─── */
    .app { display: flex; min-height: 100vh; }
    .app, .main, .content, .panel, .tab-panel, #daysContainer { min-width: 0; }
    .app.sidebar-collapsed .sidebar {
      width: 0;
      transform: translateX(-100%);
      opacity: 0;
      pointer-events: none;
    }
    .app.sidebar-collapsed .main { margin-left: 0; }

    /* ─── Sidebar ─── */
    .sidebar {
      width: 260px;
      min-height: 100vh;
      background: var(--forest);
      display: flex;
      flex-direction: column;
      position: fixed;
      left: 0; top: 0; bottom: 0;
      z-index: 100;
      overflow-y: auto;
      overflow-x: hidden;
      transition: width 0.22s ease, transform 0.22s ease, opacity 0.18s ease;
    }
    .sidebar-backdrop {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(26,58,42,0.25);
      z-index: 90;
    }

    .sidebar-logo {
      padding: 32px 24px 20px;
      border-bottom: 1px solid rgba(255,255,255,0.08);
    }
    .sidebar-logo .wordmark {
      font-family: 'Playfair Display', serif;
      font-size: 22px;
      font-weight: 700;
      color: var(--gold);
      letter-spacing: 0.04em;
      white-space: nowrap;
    }
    .sidebar-logo .tagline {
      font-size: 11px;
      color: rgba(255,255,255,0.35);
      letter-spacing: 0.14em;
      text-transform: uppercase;
      margin-top: 2px;
      font-family: 'DM Sans', sans-serif;
    }

    .sidebar-section {
      padding: 20px 16px 8px;
      font-size: 10px;
      letter-spacing: 0.18em;
      text-transform: uppercase;
      color: rgba(255,255,255,0.28);
      font-family: 'DM Sans', sans-serif;
    }

    .sidebar-nav { padding: 0 12px; flex: 1; }
    .nav-item {
      display: flex; align-items: center; gap: 10px;
      padding: 10px 12px;
      border-radius: 8px;
      cursor: pointer;
      color: rgba(255,255,255,0.62);
      font-size: 15px;
      transition: all 0.2s;
      margin-bottom: 2px;
    }
    .nav-item:hover { background: rgba(255,255,255,0.07); color: rgba(255,255,255,0.9); }
    .nav-item.active { background: var(--terracotta); color: #fff; }
    .nav-item .icon { font-size: 16px; width: 20px; text-align: center; }

    .sidebar-trips { padding: 0 12px; margin-top: 8px; }
    .trip-chip {
      padding: 9px 12px;
      border-radius: 8px;
      cursor: pointer;
      color: rgba(255,255,255,0.55);
      font-size: 13.5px;
      transition: all 0.2s;
      margin-bottom: 2px;
      white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
      display: flex; align-items: center; gap: 8px;
    }
    .trip-chip:hover { background: rgba(255,255,255,0.07); color: rgba(255,255,255,0.85); }
    .trip-chip.active { background: rgba(201,168,76,0.2); color: var(--gold); }
    .trip-chip .dot { width: 6px; height: 6px; border-radius: 50%; background: var(--gold); opacity: 0.5; flex-shrink: 0; }
    .trip-chip.active .dot { opacity: 1; }

    .btn-new-trip {
      margin: 12px;
      padding: 10px 16px;
      background: rgba(255,255,255,0.07);
      border: 1px dashed rgba(255,255,255,0.2);
      border-radius: 8px;
      color: rgba(255,255,255,0.5);
      font-size: 13px;
      cursor: pointer;
      text-align: center;
      transition: all 0.2s;
      font-family: 'DM Sans', sans-serif;
      letter-spacing: 0.04em;
    }
    .btn-new-trip:hover { border-color: var(--gold); color: var(--gold); background: rgba(201,168,76,0.07); }

    /* ─── Main ─── */
    .main {
      margin-left: 260px;
      flex: 1;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      transition: margin-left 0.22s ease;
    }

    .topbar {
      background: var(--white);
      border-bottom: 1px solid var(--parchment);
      padding: 0 40px;
      height: 60px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      position: sticky;
      top: 0;
      z-index: 50;
    }

    .topbar-title {
      font-family: 'Playfair Display', serif;
      font-size: 18px;
      color: var(--ink);
      font-weight: 600;
      min-width: 0;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      overflow-wrap: anywhere;
    }

    .topbar-left { display: flex; align-items: center; gap: 10px; min-width: 0; }
    .sidebar-toggle {
      width: 44px;
      height: 44px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      border-radius: 8px;
      border: 1px solid #d8cfbe;
      background: transparent;
      color: var(--ink-mid);
      cursor: pointer;
      font-size: 18px;
      line-height: 1;
      transition: all 0.18s;
      flex-shrink: 0;
    }
    .sidebar-toggle:hover { background: var(--parchment); }

    .topbar-right { display: flex; gap: 10px; align-items: center; min-width: 0; }
    .topbar-actions { display: flex; gap: 10px; align-items: center; }
    .sync-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-family: 'DM Sans', sans-serif;
      font-size: 11px;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      border: 1px solid var(--parchment);
      border-radius: 999px;
      padding: 4px 10px;
      color: var(--mist);
      background: rgba(255,255,255,0.6);
      white-space: nowrap;
      max-width: 220px;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .sync-badge.online {
      color: var(--forest);
      border-color: rgba(26,58,42,0.2);
      background: rgba(26,58,42,0.06);
    }
    .sync-badge.offline {
      color: var(--terracotta);
      border-color: rgba(192,97,58,0.35);
      background: rgba(192,97,58,0.08);
    }
    .sync-badge.syncing {
      color: #a07820;
      border-color: rgba(201,168,76,0.45);
      background: rgba(201,168,76,0.14);
    }

    .btn {
      display: inline-flex; align-items: center; gap: 6px;
      padding: 8px 18px;
      border-radius: 6px;
      font-size: 14px;
      min-height: 44px;
      line-height: 1.2;
      cursor: pointer;
      transition: all 0.18s;
      font-family: 'DM Sans', sans-serif;
      border: none;
    }
    .btn-primary { background: var(--terracotta); color: #fff; }
    .btn-primary:hover { background: var(--terra-light); }
    .btn-secondary { background: var(--parchment); color: var(--ink-mid); border: 1px solid #d8cfbe; }
    .btn-secondary:hover { background: #e0d8c8; }
    .btn-ghost { background: transparent; color: var(--ink-mid); border: 1px solid #d8cfbe; }
    .btn-ghost:hover { background: var(--parchment); }
    .btn-danger { background: #fee; color: #c0392b; border: 1px solid #f5c6cb; }
    .btn-danger:hover { background: #fdd; }
    .btn-sm { padding: 8px 12px; font-size: 14px; min-height: 44px; }
    .btn-icon { padding: 0; width: 44px; height: 44px; border-radius: 6px; background: transparent; border: 1px solid #d8cfbe; color: var(--ink-mid); cursor: pointer; font-size: 16px; transition: all 0.18s; }
    .btn-icon:hover { background: var(--parchment); }

    /* ─── Content area ─── */
    .content { padding: 36px 40px; flex: 1; }

    /* ─── Panels ─── */
    .panel { display: none; }
    .panel.active { display: block; }

    /* ─── Dashboard ─── */
    .hero-banner {
      background: var(--forest);
      border-radius: 16px;
      padding: 40px 48px;
      color: var(--cream);
      margin-bottom: 36px;
      position: relative;
      overflow: hidden;
    }
    .hero-banner::before {
      content: '';
      position: absolute;
      right: -40px; top: -40px;
      width: 300px; height: 300px;
      background: radial-gradient(circle, rgba(201,168,76,0.18) 0%, transparent 70%);
    }
    .hero-banner::after {
      content: '';
      position: absolute;
      left: 40%; bottom: -60px;
      width: 200px; height: 200px;
      background: radial-gradient(circle, rgba(192,97,58,0.15) 0%, transparent 70%);
    }
    .hero-banner h1 {
      font-family: 'Playfair Display', serif;
      font-size: 32px;
      font-weight: 700;
      margin-bottom: 8px;
    }
    .hero-banner h1 em { color: var(--gold); font-style: italic; }
    .hero-banner p { color: rgba(245,240,235,0.76); font-size: 16px; max-width: 480px; }

    .stat-row { display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-bottom: 36px; }
    .stat-card {
      background: var(--white);
      border-radius: 10px;
      padding: 20px 22px;
      border: 1px solid var(--parchment);
    }
    .stat-card .num {
      font-family: 'Playfair Display', serif;
      font-size: 28px;
      font-weight: 700;
      color: var(--forest);
    }
    .stat-card .label { font-size: 13px; color: var(--mist); letter-spacing: 0.06em; }

    .section-head {
      display: flex; justify-content: space-between; align-items: baseline;
      margin-bottom: 18px;
      gap: 10px;
      flex-wrap: wrap;
    }
    .section-head h2 {
      font-family: 'Playfair Display', serif;
      font-size: 20px;
      font-weight: 600;
    }

    .trips-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; }
    .trip-card {
      background: var(--white);
      border-radius: 12px;
      overflow: hidden;
      border: 1px solid var(--parchment);
      cursor: pointer;
      transition: all 0.22s;
      box-shadow: 0 2px 8px var(--shadow);
    }
    .trip-card:hover { transform: translateY(-3px); box-shadow: 0 8px 24px var(--shadow-strong); }
    .trip-card-banner {
      height: 60px;
      background: linear-gradient(135deg, var(--forest) 0%, var(--forest-mid) 100%);
      position: relative;
      display: flex; align-items: flex-end;
      padding: 12px 16px;
    }
    .trip-card-flag {
      font-size: 28px;
      position: absolute;
      right: 14px; top: 14px;
    }
    .trip-card-dest {
      color: var(--gold);
      font-family: 'DM Sans', sans-serif;
      font-size: 11px;
      letter-spacing: 0.14em;
      text-transform: uppercase;
    }
    .trip-card-body { padding: 16px; }
    .trip-card-name {
      font-family: 'Playfair Display', serif;
      font-size: 17px;
      font-weight: 600;
      margin-bottom: 4px;
      overflow-wrap: anywhere;
    }
    .trip-card-dates { font-size: 13px; color: var(--mist); }
    .trip-card-footer {
      border-top: 1px solid var(--parchment);
      padding: 10px 16px;
      display: flex; gap: 8px; flex-wrap: wrap;
    }
    .badge {
      padding: 2px 8px;
      border-radius: 20px;
      font-size: 11px;
      font-family: 'DM Sans', sans-serif;
      letter-spacing: 0.04em;
    }
    .badge-forest { background: rgba(74,94,72,0.12); color: var(--forest); }
    .badge-terra { background: rgba(122,148,120,0.14); color: var(--forest-mid); }
    .badge-gold { background: rgba(212,168,83,0.16); color: #9a7631; }

    /* ─── Trip Detail ─── */
    .trip-header {
      background: var(--forest);
      border-radius: 14px;
      padding: 32px 36px;
      color: var(--cream);
      margin-bottom: 28px;
      display: flex; justify-content: space-between; align-items: flex-start;
    }
    .trip-header-title {
      font-family: 'Playfair Display', serif;
      font-size: 28px;
      font-weight: 700;
      overflow-wrap: anywhere;
    }
    .trip-header-meta { font-size: 14px; color: rgba(245,240,235,0.78); margin-top: 6px; }
    .trip-header-meta span { color: var(--gold); }
    .trip-header-eyebrow {
      font-size: 13px;
      color: rgba(245,240,235,0.75);
      margin-bottom: 4px;
      font-family: 'DM Sans', sans-serif;
      letter-spacing: 0.1em;
      text-transform: uppercase;
    }
    .trip-header-note {
      margin-top: 8px;
      font-size: 14px;
      color: rgba(245,240,235,0.75);
      font-style: italic;
    }
    .trip-header-actions {
      display: flex;
      gap: 10px;
      align-items: center;
      justify-content: flex-end;
      flex-wrap: wrap;
    }
    .header-kebab {
      position: relative;
    }
    .header-kebab-btn {
      width: 44px;
      height: 44px;
      min-height: 44px;
      border-radius: 10px;
      border: 1px solid rgba(255,255,255,0.3);
      background: rgba(255,255,255,0.2);
      color: #fff;
      font-size: 24px;
      line-height: 1;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.18s;
    }
    .header-kebab-btn:hover { background: rgba(255,255,255,0.28); }
    .header-kebab.open .header-kebab-btn {
      background: rgba(255,255,255,0.32);
      border-color: rgba(255,255,255,0.45);
    }
    .header-kebab-menu {
      position: absolute;
      top: calc(100% + 6px);
      right: 0;
      width: 190px;
      background: var(--white);
      border: 1px solid var(--parchment);
      border-radius: 12px;
      box-shadow: 0 12px 28px rgba(0,0,0,0.16);
      overflow: hidden;
      z-index: 26;
      display: none;
    }
    .header-kebab.open .header-kebab-menu { display: block; }
    .header-kebab-item {
      width: 100%;
      border: none;
      background: transparent;
      padding: 12px 14px;
      text-align: left;
      font-family: 'DM Sans', sans-serif;
      font-size: 16px;
      line-height: 1.25;
      color: var(--ink-mid);
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 10px;
      min-height: 44px;
    }
    .header-kebab-item + .header-kebab-item { border-top: 1px solid var(--parchment); }
    .header-kebab-item.edit:hover { background: rgba(26,58,42,0.06); color: var(--forest); }
    .header-kebab-item.delete { color: #b2454f; }
    .header-kebab-item.delete:hover { background: #fff2f4; }

    .tabs {
      display: flex; gap: 0;
      background: var(--white);
      border-radius: 10px;
      border: 1px solid var(--parchment);
      padding: 4px;
      margin-bottom: 28px;
      overflow-x: auto;
    }
    .tab {
      padding: 8px 18px;
      border-radius: 7px;
      cursor: pointer;
      font-size: 14px;
      color: var(--mist);
      transition: all 0.18s;
      white-space: nowrap;
      border: none;
      background: transparent;
      font-family: 'DM Sans', sans-serif;
    }
    .tab.active { background: var(--forest); color: #fff; }
    .tab:hover:not(.active) { background: var(--parchment); color: var(--ink); }

    .tab-panel { display: none; }
    .tab-panel.active { display: block; }

    .itinerary-filter-bar {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 6px;
      background: var(--white);
      border-radius: 10px;
      border: 1px solid var(--parchment);
      padding: 6px;
      margin-bottom: 20px;
      width: 100%;
    }
    .itinerary-filter-btn {
      border: none;
      background: transparent;
      color: var(--mist);
      border-radius: 7px;
      padding: 8px 18px;
      font-size: 14px;
      cursor: pointer;
      font-family: 'DM Sans', sans-serif;
      white-space: nowrap;
      width: 100%;
      text-align: center;
      transition: all 0.18s;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      min-height: 44px;
      line-height: 1.25;
    }
    .itinerary-filter-btn:hover { background: var(--parchment); color: var(--ink); }
    .itinerary-filter-btn.active {
      background: var(--forest);
      color: #fff;
    }

    /* ─── Day cards ─── */
    .day-card {
      background: var(--white);
      border-radius: 12px;
      border: 1px solid var(--parchment);
      margin-bottom: 20px;
      overflow: visible;
    }
    .day-card-head {
      background: var(--day-bar-bg);
      color: var(--day-bar-text);
      padding: 14px 20px;
      display: flex; justify-content: space-between; align-items: center;
      cursor: pointer;
      border-radius: 12px 12px 0 0;
    }
    .day-card.collapsed .day-card-head { border-radius: 12px; }
    .day-head-main { display:flex; align-items:flex-start; gap:10px; min-width:0; }
    .day-head-actions {
      display: flex;
      justify-content: flex-end;
      width: 100%;
      margin-top: 4px;
    }
    .day-head-actions .header-kebab { margin-left: auto; }
    .day-toggle {
      width: 18px;
      flex-shrink: 0;
      color: rgba(240,245,238,0.88);
      font-size: 14px;
      line-height: 1;
      margin-top: 1px;
    }
    .day-card-head .day-label {
      font-family: 'DM Sans', sans-serif;
      font-size: 11px;
      letter-spacing: 0.16em;
      text-transform: uppercase;
      color: var(--gold);
    }
    .day-card-head .day-title {
      font-family: 'Playfair Display', serif;
      font-size: 16px;
      margin-top: 2px;
      overflow-wrap: anywhere;
    }
    .day-card-body { padding: 0; }
    .day-card.collapsed .day-card-body { display: none; }

    .activity-row {
      display: flex; align-items: flex-start;
      padding: 14px 20px;
      border-bottom: 1px solid var(--parchment);
      gap: 16px;
      transition: background 0.15s;
    }
    .activity-row:last-child { border-bottom: none; }
    .activity-row:hover { background: var(--cream); }
    .activity-time {
      font-family: 'DM Sans', sans-serif;
      font-size: 11.5px;
      color: var(--mist);
      width: 56px;
      flex-shrink: 0;
      margin-top: 2px;
    }
    .activity-dot {
      width: 28px; height: 28px; border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      font-size: 13px;
      flex-shrink: 0;
    }
    .activity-dot.cat-food { background: rgba(201,168,76,0.15); }
    .activity-dot.cat-attraction { background: rgba(26,58,42,0.12); }
    .activity-dot.cat-transport { background: rgba(192,97,58,0.12); }
    .activity-dot.cat-hotel { background: rgba(100,100,180,0.12); }
    .activity-dot.cat-other { background: rgba(100,100,100,0.1); }
    .activity-info { flex: 1; }
    .activity-title { font-weight: 600; font-size: 15px; overflow-wrap: anywhere; }
    .activity-desc { font-size: 13.5px; color: var(--ink-mid); margin-top: 2px; }
    .activity-meta { display: flex; gap: 10px; margin-top: 6px; flex-wrap: wrap; }
    .activity-location { font-size: 12px; color: var(--mist); font-family: 'DM Sans', sans-serif; }
    .activity-cost { font-size: 12px; color: var(--terracotta); font-family: 'DM Sans', sans-serif; }
    .activity-actions {
      position: relative;
      margin-left: auto;
      flex-shrink: 0;
    }
    .activity-kebab-btn {
      width: 44px;
      height: 44px;
      min-height: 44px;
      border-radius: 10px;
      border: 1px solid #d8cfbe;
      background: var(--parchment);
      color: var(--ink-mid);
      font-size: 24px;
      line-height: 1;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.18s;
    }
    .activity-kebab-btn:hover { background: #e7e3da; }
    .activity-actions.open .activity-kebab-btn {
      background: #e0ddd4;
      border-color: #cbc5ba;
    }
    .activity-actions-menu {
      position: absolute;
      top: calc(100% + 6px);
      right: 0;
      width: 170px;
      background: var(--white);
      border: 1px solid var(--parchment);
      border-radius: 12px;
      box-shadow: 0 10px 26px rgba(0,0,0,0.15);
      overflow: hidden;
      z-index: 20;
      display: none;
    }
    .activity-actions.open .activity-actions-menu { display: block; }
    .activity-actions-item {
      width: 100%;
      border: none;
      background: transparent;
      padding: 12px 14px;
      text-align: left;
      font-family: 'DM Sans', sans-serif;
      font-size: 16px;
      line-height: 1.25;
      color: var(--ink-mid);
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 10px;
      min-height: 44px;
    }
    .activity-actions-item + .activity-actions-item { border-top: 1px solid var(--parchment); }
    .activity-actions-item.edit:hover { background: rgba(26,58,42,0.06); color: var(--forest); }
    .activity-actions-item.delete { color: #b2454f; }
    .activity-actions-item.delete:hover { background: #fff2f4; }

    .add-activity-bar {
      padding: 12px 20px;
      border-top: 1px dashed #d8cfbe;
    }

    /* ─── Budget ─── */
    .budget-overview {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 28px;
    }
    .budget-box {
      background: var(--white);
      border: 1px solid var(--parchment);
      border-radius: 12px;
      padding: 22px 24px;
    }
    .budget-box .b-label { font-size: 12px; letter-spacing: 0.1em; text-transform: uppercase; color: var(--mist); font-family: 'DM Sans', sans-serif; }
    .budget-box .b-val { font-family: 'Playfair Display', serif; font-size: 32px; font-weight: 700; color: var(--forest); }
    .budget-box .b-val.over { color: var(--terracotta); }
    .progress-bar { height: 6px; background: var(--parchment); border-radius: 99px; margin-top: 12px; overflow: hidden; }
    .progress-fill { height: 100%; border-radius: 99px; background: var(--forest); transition: width 0.4s; }
    .progress-fill.warn { background: var(--terracotta); }

    .expense-table {
      width: 100%;
      border-collapse: collapse;
      background: var(--white);
      border-radius: 12px;
      overflow: hidden;
      border: 1px solid var(--parchment);
    }
    .expense-table th {
      background: var(--forest);
      color: rgba(255,255,255,0.7);
      font-family: 'DM Sans', sans-serif;
      font-size: 11px;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      padding: 12px 16px;
      text-align: left;
      font-weight: 400;
    }
    .expense-table td {
      padding: 12px 16px;
      border-bottom: 1px solid var(--parchment);
      font-size: 14.5px;
    }
    .expense-table tr:last-child td { border-bottom: none; }
    .expense-table tr:hover td { background: rgba(245,240,232,0.5); }
    .table-scroll {
      width: 100%;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      border-radius: 12px;
    }
    .table-scroll .expense-table { min-width: 620px; }

    /* ─── Checklist ─── */
    .checklist-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
    .checklist-card {
      background: var(--white);
      border: 1px solid var(--parchment);
      border-radius: 12px;
      padding: 20px 22px;
    }
    .checklist-card h3 {
      font-family: 'Playfair Display', serif;
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 14px;
      padding-bottom: 10px;
      border-bottom: 1px solid var(--parchment);
    }
    .check-item {
      display: flex; align-items: center; gap: 10px;
      padding: 7px 0;
      cursor: pointer;
      border-radius: 6px;
      transition: background 0.15s;
      font-size: 14.5px;
    }
    .check-item:hover { background: rgba(245,240,232,0.5); padding: 7px 6px; margin: 0 -6px; }
    .check-item input[type="checkbox"] {
      accent-color: var(--forest);
      width: 15px; height: 15px;
      cursor: pointer;
    }
    .check-item.checked { text-decoration: line-through; color: var(--mist); }

    /* ─── Accom & Transport ─── */
    .info-card {
      background: var(--white);
      border: 1px solid var(--parchment);
      border-radius: 12px;
      padding: 20px 22px;
      margin-bottom: 16px;
      display: flex; justify-content: space-between; align-items: flex-start;
    }
    .info-card-left h3 { font-family: 'Playfair Display', serif; font-size: 16px; font-weight: 600; margin-bottom: 4px; }
    .info-card-left p { font-size: 13.5px; color: var(--ink-mid); }
    .info-card-meta { margin-top: 10px; display: flex; gap: 10px; flex-wrap: wrap; }
    .meta-pill {
      background: rgba(74,94,72,0.12);
      padding: 3px 10px;
      border-radius: 20px;
      font-size: 12px;
      font-family: 'DM Sans', sans-serif;
      color: var(--forest);
    }

    /* ─── Considerations ─── */
    .considerations-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; }
    .consider-card {
      background: var(--white);
      border: 1px solid var(--parchment);
      border-radius: 12px;
      padding: 20px;
    }
    .consider-card .c-icon { font-size: 26px; margin-bottom: 10px; }
    .consider-card h3 { font-family: 'Playfair Display', serif; font-size: 15px; font-weight: 600; margin-bottom: 8px; }
    .consider-card ul { list-style: none; }
    .consider-card ul li { font-size: 13.5px; color: var(--ink-mid); padding: 3px 0; display: flex; gap: 6px; align-items: flex-start; }
    .consider-card ul li::before { content: '·'; color: var(--terracotta); font-size: 18px; line-height: 1.2; flex-shrink: 0; }

    /* ─── Modals ─── */
    .modal-overlay {
      display: none;
      position: fixed; inset: 0;
      background: rgba(26,58,42,0.55);
      z-index: 200;
      align-items: center; justify-content: center;
    }
    .modal-overlay.open { display: flex; }
    .modal {
      background: var(--white);
      border-radius: 16px;
      width: 500px;
      max-width: 95vw;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 24px 60px rgba(0,0,0,0.25);
    }
    .modal-head {
      padding: 24px 28px 16px;
      border-bottom: 1px solid var(--parchment);
      display: flex; justify-content: space-between; align-items: center;
    }
    .modal-head h2 {
      font-family: 'Playfair Display', serif;
      font-size: 20px;
      font-weight: 600;
    }
    .modal-close {
      width: 44px;
      height: 44px;
      min-height: 44px;
      background: none; border: none; font-size: 20px;
      cursor: pointer; color: var(--mist); line-height: 1;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }
    .modal-body { padding: 24px 28px; }
    .modal-footer { padding: 16px 28px 24px; display: flex; gap: 10px; justify-content: flex-end; }
    .fx-note {
      font-size: 14px;
      color: var(--mist);
      margin: -6px 0 12px;
      line-height: 1.4;
    }

    .settings-wrap {
      width: 100%;
      max-width: 520px;
    }
    .settings-card {
      background: var(--white);
      border: 1px solid var(--parchment);
      border-radius: 12px;
      padding: 20px 16px;
    }
    .settings-card-title {
      font-family: 'Playfair Display', serif;
      font-size: 22px;
      margin-bottom: 6px;
    }
    .settings-card-note {
      font-size: 14px;
      color: var(--mist);
      margin-bottom: 16px;
      line-height: 1.4;
    }
    .btn-nowrap { white-space: nowrap; }

    /* ─── Forms ─── */
    .form-group { margin-bottom: 18px; }
    .form-group label {
      display: block;
      font-family: 'DM Sans', sans-serif;
      font-size: 11px;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      color: var(--mist);
      margin-bottom: 6px;
    }
    .form-group input,
    .form-group select,
    .form-group textarea {
      width: 100%;
      padding: 10px 14px;
      border: 1px solid #d8cfbe;
      border-radius: 7px;
      font-family: 'DM Sans', sans-serif;
      font-size: 15px;
      color: var(--ink);
      background: var(--white);
      outline: none;
      transition: border-color 0.2s;
    }
    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus { border-color: var(--forest); }
    .form-group textarea { min-height: 80px; resize: vertical; }
    .form-group.align-end {
      display: flex;
      align-items: flex-end;
    }
    .form-group.align-end .btn {
      width: 100%;
      justify-content: center;
    }
    .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; }
    .trip-destination-row {
      display: flex;
      gap: 8px;
      align-items: center;
    }
    .panel-actions-right {
      display: flex;
      justify-content: flex-end;
      margin-bottom: 16px;
    }

    /* ─── Activity Modal Usability ─── */
    #modalAddActivity .modal { width: 720px; }
    #modalAddActivity .modal-head h2 { font-size: 36px; }
    #modalAddActivity .modal-close { font-size: 34px; }
    #modalAddActivity .modal-body { padding-top: 20px; }
    #modalAddActivity .modal-footer .btn {
      font-size: 20px;
      padding: 12px 22px;
      border-radius: 10px;
      min-width: 150px;
      justify-content: center;
    }
    #modalAddActivity .form-row { grid-template-columns: 1fr; gap: 10px; }
    #modalAddActivity .form-group label {
      font-family: 'DM Sans', sans-serif;
      font-size: 17px;
      font-weight: 600;
      letter-spacing: 0;
      text-transform: none;
      color: var(--ink-mid);
      margin-bottom: 8px;
    }
    #modalAddActivity .form-group input,
    #modalAddActivity .form-group select,
    #modalAddActivity .form-group textarea {
      font-size: 18px;
      padding: 14px 16px;
      border-radius: 10px;
    }
    #modalAddActivity .form-group textarea { min-height: 110px; }
    .activity-cost-hint {
      font-size: 14px;
      color: var(--mist);
      margin-top: -8px;
      margin-bottom: 6px;
    }
    .activity-fx {
      border: 1px dashed #d8cfbe;
      border-radius: 10px;
      padding: 10px 12px 6px;
      background: rgba(245,240,232,0.35);
      margin-top: 6px;
      margin-bottom: 10px;
    }
    .activity-fx-row { margin-bottom: 10px; }
    .activity-fx-line {
      display: grid;
      grid-template-columns: 1fr 240px;
      gap: 10px;
      margin-bottom: 10px;
    }
    /* Mobile-first responsive baseline (320px-375px) */
    /* Keep defaults thumb-friendly and vertically stacked; larger layouts scale up via min-width only. */
    body {
      font-size: 16px;
      line-height: 1.5;
    }
    .main { margin-left: 0; }
    .sidebar {
      transform: translateX(-100%);
      box-shadow: 0 12px 28px rgba(0,0,0,0.18);
    }
    .app:not(.sidebar-collapsed) .sidebar {
      width: 260px;
      transform: translateX(0);
      opacity: 1;
      pointer-events: auto;
    }
    .app:not(.sidebar-collapsed) .sidebar-backdrop { display: block; }
    .sidebar-section {
      font-size: 14px;
      letter-spacing: 0.08em;
    }
    .sidebar-logo .tagline { font-size: 14px; letter-spacing: 0.08em; }
    .nav-item {
      font-size: 16px;
      min-height: 44px;
      padding: 10px 12px;
      margin-bottom: 8px;
    }
    .trip-chip {
      font-size: 16px;
      min-height: 44px;
      display: flex;
      align-items: center;
      margin-bottom: 8px;
    }
    .btn-new-trip {
      min-height: 44px;
      font-size: 14px;
    }
    .content { padding: 16px; }
    .section-head {
      margin-bottom: 16px;
      flex-direction: column;
      align-items: stretch;
      gap: 10px;
    }
    .section-head .btn {
      width: 100%;
      justify-content: center;
    }
    .section-head h2 { font-size: 22px; }
    .hero-banner {
      border-radius: 12px;
      padding: 20px 16px;
      margin-bottom: 24px;
    }
    .hero-banner::before,
    .hero-banner::after { display: none; }
    .hero-banner h1 { font-size: 30px; line-height: 1.2; margin-bottom: 4px; }
    .hero-banner p { font-size: 14px; }
    .trip-card-dest,
    .badge,
    .trip-header-eyebrow,
    .day-card-head .day-label,
    .activity-time,
    .activity-location,
    .activity-cost,
    .activity-desc,
    .budget-box .b-label,
    .info-card-left p,
    .meta-pill,
    .expense-table td::before {
      font-size: 14px;
      line-height: 1.4;
    }

    .topbar {
      height: 60px;
      min-height: 60px;
      padding: 0 12px;
      gap: 8px;
    }
    .topbar-left { gap: 8px; min-width: 0; flex: 1; }
    .topbar-right { gap: 8px; min-width: 0; }
    .topbar-title { font-size: 20px; }
    .sync-badge { display: none; }

    /* Touch targets */
    .btn {
      min-height: 44px;
      padding: 10px 14px;
      font-size: 16px;
      line-height: 1.2;
    }
    .btn-sm {
      min-height: 44px;
      padding: 8px 12px;
      font-size: 14px;
    }
    .btn-icon {
      width: 44px;
      height: 44px;
      min-height: 44px;
      padding: 0;
      font-size: 18px;
    }
    .topbar-actions { gap: 8px; }
    .topbar-actions .btn { padding: 8px 10px; font-size: 14px; min-height: 44px; }

    .trips-grid { grid-template-columns: 1fr; gap: 14px; }
    .trip-card:hover { transform: none; box-shadow: 0 2px 8px var(--shadow); }
    .trip-card-banner { height: 54px; }
    .trip-card-name { font-size: 22px; }
    .trip-card-dates { font-size: 14px; }

    .trip-header {
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 16px;
      flex-direction: row;
      align-items: flex-start;
      justify-content: space-between;
      gap: 10px;
    }
    .trip-header > div:first-child {
      min-width: 0;
      flex: 1;
    }
    .trip-header-title { font-size: 32px; line-height: 1.2; }
    .trip-header-meta { font-size: 14px; }
    .trip-header-eyebrow { font-size: 12px; }
    .trip-header-actions {
      width: auto;
      display: flex;
      justify-content: flex-end;
      gap: 8px;
      flex-shrink: 0;
    }
    .trip-header-actions .header-kebab { margin-left: 0; }

    .itinerary-filter-bar {
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 8px;
      padding: 8px;
      margin-bottom: 16px;
    }
    .itinerary-filter-btn {
      white-space: normal;
      padding: 9px 8px;
      font-size: 14px;
      min-height: 44px;
    }

    .day-card { margin-bottom: 12px; }
    .day-card-head {
      padding: 12px;
      flex-direction: row;
      align-items: center;
      gap: 8px;
    }
    .day-head-main { flex: 1; min-width: 0; width: auto; }
    .day-head-main > div:last-child { min-width: 0; flex: 1; }
    .day-head-actions {
      width: auto;
      margin-top: 0;
      justify-content: flex-end;
      flex-shrink: 0;
    }
    .day-head-actions .header-kebab { margin-left: 0; }
    .day-card-head .day-title { font-size: 20px; line-height: 1.2; }
    .day-card-head .day-label {
      font-size: 15px;
      letter-spacing: 0.08em;
      line-height: 1.4;
      white-space: normal;
      overflow-wrap: anywhere;
    }

    .activity-row {
      display: grid;
      grid-template-columns: 56px 34px 1fr auto;
      gap: 8px 10px;
      padding: 12px;
      align-items: flex-start;
    }
    .activity-time { grid-column: 1; font-size: 13px; }
    .activity-dot { grid-column: 2; width: 30px; height: 30px; font-size: 14px; }
    .activity-info { grid-column: 3; min-width: 0; }
    .activity-title { font-size: 18px; line-height: 1.3; }
    .activity-desc, .activity-location, .activity-cost { font-size: 14px; line-height: 1.4; }
    .activity-actions {
      grid-column: 4;
      grid-row: 1;
      justify-self: end;
      align-self: start;
      margin-left: 0;
    }
    .activity-actions-item {
      font-size: 16px;
      padding: 10px 12px;
      gap: 8px;
    }

    .budget-overview { grid-template-columns: 1fr; gap: 12px; margin-bottom: 16px; }
    .budget-box { padding: 16px; }
    .budget-box .b-val { font-size: 28px; line-height: 1.2; }

    .panel-actions-right { margin-bottom: 12px; }
    .panel-actions-right .btn { width: 100%; justify-content: center; }
    .info-card {
      padding: 14px;
      flex-direction: column;
      gap: 12px;
    }
    .info-card > .btn { width: 100%; }
    .checklist-grid { grid-template-columns: 1fr; gap: 14px; }
    .considerations-grid { grid-template-columns: 1fr; gap: 14px; }
    .consider-card ul li { font-size: 14px; line-height: 1.45; }

    .form-group { margin-bottom: 14px; }
    .form-group label {
      font-size: 14px;
      letter-spacing: 0.06em;
      margin-bottom: 6px;
    }
    .form-group input,
    .form-group select,
    .form-group textarea {
      font-size: 16px;
      line-height: 1.4;
      min-height: 44px;
      padding: 10px 12px;
    }
    .form-row { grid-template-columns: 1fr; gap: 10px; }
    .trip-destination-row {
      flex-direction: column;
      align-items: stretch;
      gap: 8px;
    }
    .trip-destination-row .btn { width: 100%; justify-content: center; }

    .modal-overlay {
      align-items: flex-end;
      padding: 0;
    }
    .modal {
      width: 100%;
      max-width: 100%;
      max-height: 95vh;
      border-radius: 16px 16px 0 0;
      box-shadow: 0 -8px 24px rgba(0,0,0,0.18);
    }
    .modal-head { padding: 14px 16px 10px; }
    .modal-head h2 { font-size: 28px; }
    .modal-close { font-size: 28px; }
    .modal-body { padding: 14px 16px; }
    .modal-footer {
      padding: 10px 16px 14px;
      flex-direction: column-reverse;
      gap: 8px;
    }
    .modal-footer .btn { width: 100%; justify-content: center; min-height: 48px; }

    #modalAddActivity .modal { width: 100%; max-height: 96vh; }
    #modalAddActivity .modal-head h2 { font-size: 30px; }
    #modalAddActivity .modal-close { font-size: 30px; }
    #modalAddActivity .modal-body { padding: 12px 14px; }
    #modalAddActivity .form-group { margin-bottom: 12px; }
    #modalAddActivity .form-group label {
      font-family: 'DM Sans', sans-serif;
      font-size: 16px;
      font-weight: 600;
      letter-spacing: 0;
      text-transform: none;
      color: var(--ink-mid);
    }
    #modalAddActivity .form-group input,
    #modalAddActivity .form-group select,
    #modalAddActivity .form-group textarea {
      font-size: 16px;
      padding: 10px 12px;
      border-radius: 9px;
    }
    #modalAddActivity .form-group textarea { min-height: 90px; }
    #modalAddActivity .activity-cost-hint { font-size: 14px; margin-top: -6px; }
    #modalAddActivity .activity-fx {
      padding: 8px 10px 6px;
      margin-top: 4px;
      margin-bottom: 8px;
    }
    #modalAddActivity .activity-fx summary { font-size: 16px; margin-bottom: 6px; }
    #modalAddActivity .activity-fx-line { grid-template-columns: 1fr; gap: 8px; margin-bottom: 8px; }
    #modalAddActivity .modal-footer {
      position: sticky;
      bottom: 0;
      background: linear-gradient(180deg, rgba(253,250,245,0.92) 0%, rgba(253,250,245,1) 28%);
      border-top: 1px solid var(--parchment);
    }
    #modalAddActivity .modal-footer .btn {
      min-height: 48px;
      font-size: 16px;
      border-radius: 10px;
    }

    /* Mobile budget table as stacked cards */
    .table-scroll {
      overflow-x: visible;
      border-radius: 0;
    }
    .expense-table {
      border: none;
      background: transparent;
    }
    .expense-table thead { display: none; }
    .expense-table tbody,
    .expense-table tr,
    .expense-table td {
      display: block;
      width: 100%;
    }
    .expense-table tr {
      background: var(--white);
      border: 1px solid var(--parchment);
      border-radius: 10px;
      margin-bottom: 10px;
      padding: 10px 12px;
    }
    .expense-table td {
      border: none;
      padding: 7px 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      font-size: 14px;
    }
    .expense-table td::before {
      content: attr(data-label);
      color: var(--mist);
      font-family: 'DM Sans', sans-serif;
      font-size: 14px;
      letter-spacing: 0.06em;
      text-transform: uppercase;
    }
    .expense-table td:last-child {
      justify-content: flex-end;
      padding-top: 8px;
    }
    .expense-table td:last-child::before { content: none; }
    .expense-table td[colspan] {
      display: block;
      text-align: center !important;
    }
    .expense-table td[colspan]::before { content: none; }

    /* Large mobile (390-430px): loosen spacing and allow 2-column actions */
    @media (min-width: 390px) {
      .content { padding: 18px; }
      .itinerary-filter-bar { grid-template-columns: repeat(3, minmax(0, 1fr)); }
    }

    /* Tablet (>=768px): 2-column layouts and desktop-like tables */
    @media (min-width: 768px) {
      .sync-badge { display: inline-flex; max-width: 42vw; }
      .topbar { padding: 0 18px; }
      .topbar-title { font-size: 24px; }
      .content { padding: 24px; }
      .section-head {
        flex-direction: row;
        align-items: baseline;
      }
      .section-head .btn { width: auto; }
      .hero-banner { padding: 24px 22px; }
      .hero-banner h1 { font-size: 34px; }
      .trips-grid { grid-template-columns: repeat(2, minmax(0, 1fr)); gap: 16px; }
      .trip-header {
        padding: 20px;
        flex-direction: column;
      }
      .budget-overview { grid-template-columns: 1fr 1fr; gap: 16px; }
      .checklist-grid { grid-template-columns: 1fr 1fr; }
      .considerations-grid { grid-template-columns: repeat(2, 1fr); }
      .panel-actions-right .btn { width: auto; }
      .form-row { grid-template-columns: 1fr 1fr; gap: 12px; }
      .trip-destination-row {
        flex-direction: row;
        align-items: center;
      }
      .trip-destination-row .btn { width: auto; }

      .day-card-head {
        flex-direction: row;
        align-items: center;
      }
      .day-head-main {
        width: auto;
      }
      .day-head-actions {
        display: flex;
        width: auto;
        margin-top: 0;
      }
      .day-head-actions .header-kebab { margin-left: 0; }

      .modal-overlay {
        align-items: center;
        padding: 16px;
      }
      .modal {
        width: 560px;
        max-width: 96vw;
        border-radius: 14px;
      }
      .modal-head h2 { font-size: 30px; }
      .modal-footer {
        flex-direction: row;
        justify-content: flex-end;
      }
      .modal-footer .btn { width: auto; min-height: 44px; }

      #modalAddActivity .modal { width: 700px; }
      #modalAddActivity .form-row { grid-template-columns: 1fr 1fr; gap: 10px; }
      #modalAddActivity .activity-fx-line { grid-template-columns: 1fr 220px; }
      .settings-card {
        padding: 28px;
      }
      .settings-card-title { font-size: 24px; }
      .table-scroll {
        overflow-x: auto;
        border-radius: 12px;
      }
      .table-scroll .expense-table { min-width: 0; }
      .expense-table {
        border: 1px solid var(--parchment);
        background: var(--white);
      }
      .expense-table thead { display: table-header-group; }
      .expense-table tbody { display: table-row-group; }
      .expense-table tr { display: table-row; padding: 0; margin: 0; border: none; border-radius: 0; }
      .expense-table td, .expense-table th {
        display: table-cell;
        width: auto;
      }
      .expense-table td {
        font-size: 15px;
        padding: 12px 14px;
        border-bottom: 1px solid var(--parchment);
      }
      .expense-table td::before { content: none; }
      .expense-table td:last-child { padding-top: 12px; }
    }

    /* Desktop (>=1024px): persistent sidebar + denser multi-column layout */
    @media (min-width: 1024px) {
      body { font-size: 17px; }
      .sidebar {
        transform: translateX(0);
        width: 260px;
        opacity: 1;
        pointer-events: auto;
        box-shadow: none;
      }
      .sidebar-backdrop { display: none !important; }
      .main { margin-left: 260px; }
      .sidebar-section {
        font-size: 10px;
        letter-spacing: 0.18em;
      }
      .sidebar-logo .tagline { font-size: 11px; letter-spacing: 0.14em; }
      .nav-item {
        font-size: 15px;
        min-height: 0;
        margin-bottom: 2px;
      }
      .trip-chip {
        font-size: 13.5px;
        min-height: 0;
        margin-bottom: 2px;
      }
      .btn-new-trip { font-size: 13px; }

      .topbar {
        height: 60px;
        min-height: 60px;
        padding: 0 40px;
      }
      .topbar-title { font-size: 28px; }
      .content { padding: 36px 40px; }
      .hero-banner {
        padding: 40px 48px;
        margin-bottom: 36px;
        border-radius: 16px;
      }
      .hero-banner::before,
      .hero-banner::after { display: block; }
      .hero-banner h1 { font-size: 42px; }

      .trips-grid { grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; }
      .trip-card:hover { transform: translateY(-3px); box-shadow: 0 8px 24px var(--shadow-strong); }
      .trip-card-dest { font-size: 11px; }
      .badge { font-size: 11px; }
      .trip-header {
        flex-direction: row;
        align-items: flex-start;
        justify-content: space-between;
        padding: 32px 36px;
      }
      .trip-header-eyebrow { font-size: 13px; }
      .trip-header-actions {
        width: auto;
        display: flex;
        flex-wrap: wrap;
      }

      .activity-row {
        display: flex;
        padding: 14px 20px;
      }
      .day-card-head .day-label { font-size: 11px; letter-spacing: 0.16em; }
      .activity-time { font-size: 11.5px; }
      .activity-desc { font-size: 13.5px; }
      .activity-location,
      .activity-cost { font-size: 12px; }
      .budget-box .b-label { font-size: 12px; }
      .info-card-left p { font-size: 13.5px; }
      .meta-pill { font-size: 12px; }
      .activity-actions { grid-column: auto; }

      .considerations-grid { grid-template-columns: repeat(3, 1fr); }
      .checklist-grid { grid-template-columns: 1fr 1fr; }
      .panel-actions-right { justify-content: flex-end; }
      .panel-actions-right .btn { min-height: 44px; }
      .modal { box-shadow: 0 24px 60px rgba(0,0,0,0.25); }
    }

    /* Large desktop (>=1280px): increase content breathing room */
    @media (min-width: 1280px) {
      .content { padding: 40px 48px; }
      .hero-banner h1 { font-size: 48px; }
      .trip-header-title { font-size: 46px; }
      .section-head h2 { font-size: 30px; }
      .budget-box .b-val { font-size: 36px; }
    }
    #modalAddActivity .activity-fx-line .form-group { margin-bottom: 0; }
    #activityFxButton {
      width: 100%;
      justify-content: center;
      margin-bottom: 8px;
    }
    .activity-fx summary {
      cursor: pointer;
      font-family: 'DM Sans', sans-serif;
      font-size: 18px;
      font-weight: 600;
      color: var(--ink-mid);
      margin-bottom: 8px;
      user-select: none;
    }
    #activityFxNote {
      font-size: 14px;
      color: var(--mist);
      margin: 6px 0 4px;
    }

    /* ─── Supabase config ─── */
    .config-banner {
      background: linear-gradient(135deg, rgba(201,168,76,0.12) 0%, rgba(26,58,42,0.08) 100%);
      border: 1px dashed var(--gold);
      border-radius: 12px;
      padding: 20px 24px;
      margin-bottom: 28px;
      display: flex; gap: 16px; align-items: flex-start;
    }
    .config-banner .cfg-icon { font-size: 24px; flex-shrink: 0; }
    .config-banner h3 { font-family: 'Playfair Display', serif; font-size: 16px; font-weight: 600; margin-bottom: 4px; }
    .config-banner p { font-size: 13.5px; color: var(--ink-mid); }
    .config-banner.hidden { display: none; }

    /* ─── Empty states ─── */
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: var(--mist);
    }
    .empty-state .e-icon { font-size: 48px; margin-bottom: 14px; }
    .empty-state h3 { font-family: 'Playfair Display', serif; font-size: 18px; color: var(--ink-mid); margin-bottom: 8px; }
    .empty-state p { font-size: 14px; max-width: 320px; margin: 0 auto 20px; }

    /* ─── Toast ─── */
    .toast-container {
      position: fixed;
      left: 12px;
      right: 12px;
      bottom: 12px;
      width: auto;
      z-index: 999;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .toast {
      background: var(--forest);
      color: #fff;
      padding: 10px 12px;
      border-radius: 8px;
      font-size: 14px;
      box-shadow: 0 4px 16px rgba(0,0,0,0.2);
      animation: slideIn 0.25s ease;
    }
    .toast.success { background: var(--forest); }
    .toast.error { background: var(--terracotta); }
    @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    @media (min-width: 768px) {
      .toast-container {
        left: auto;
        right: 24px;
        bottom: 24px;
        width: auto;
      }
      .toast { padding: 12px 20px; }
    }

    /* Scrollbar */
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: rgba(26,58,42,0.2); border-radius: 3px; }
  </style>
</head>
<body>

<!-- ─── App ─── -->
<div class="app" id="mainApp">

  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="sidebar-logo">
      <div class="wordmark" id="sidebarWordmark" data-full="Voyageur" data-short="V">Voyageur</div>
      <div class="tagline">Travel Planner</div>
    </div>
    <div class="sidebar-nav">
      <div class="sidebar-section">Navigate</div>
      <div class="nav-item active" onclick="showPanel('dashboard')">
        <span class="icon">🗺️</span><span class="nav-label">Dashboard</span>
      </div>
      <div class="nav-item" onclick="showPanel('considerations')">
        <span class="icon">💡</span><span class="nav-label">What to Consider</span>
      </div>
      <div class="nav-item" onclick="showPanel('settings')">
        <span class="icon">⚙️</span><span class="nav-label">Settings</span>
      </div>
    </div>
    <div>
      <div class="sidebar-section" style="padding-top:24px;">My Trips</div>
      <div class="sidebar-trips" id="sidebarTrips">
        <div style="padding: 8px 12px; font-size:13px; color:rgba(255,255,255,0.3); font-style:italic;">Loading trips…</div>
      </div>
      <button class="btn-new-trip" onclick="openNewTripModal()">+ New Trip</button>
    </div>
  </aside>
  <div class="sidebar-backdrop" id="sidebarBackdrop" onclick="toggleSidebar()"></div>

  <!-- Main -->
  <main class="main">
    <div class="topbar">
      <div class="topbar-left">
        <button class="sidebar-toggle" id="sidebarToggleBtn" onclick="toggleSidebar()" aria-label="Collapse sidebar">☰</button>
        <div class="topbar-title" id="topbarTitle">Dashboard</div>
      </div>
      <div class="topbar-right">
        <div class="sync-badge" id="syncStatusBadge">Checking…</div>
        <div class="topbar-actions" id="topbarActions">
          <button class="btn btn-primary" onclick="openNewTripModal()">+ New Trip</button>
        </div>
      </div>
    </div>
    <div class="content">

      <!-- Dashboard -->
      <div class="panel active" id="panel-dashboard">
        <div class="hero-banner">
          <h1>Plan your next <em>adventure</em></h1>
          <!-- <p>Build detailed day-by-day itineraries, track your budget, manage bookings, and pack smart.</p> -->
        </div>
        <div class="section-head">
          <h2>Your Trips</h2>
        </div>
        <div class="trips-grid" id="tripsGrid">
          <div class="empty-state">
            <div class="e-icon">✈️</div>
            <h3>No trips yet</h3>
            <p>Create your first trip to start planning your adventure.</p>
            <button class="btn btn-primary" onclick="openNewTripModal()">Create a Trip</button>
          </div>
        </div>
      </div>

      <!-- Trip Detail -->
      <div class="panel" id="panel-trip">
        <div class="trip-header" id="tripHeader"></div>

        <!-- Itinerary tab -->
        <div class="tab-panel active" id="tab-itinerary">
          <div class="itinerary-filter-bar" id="itineraryFilterBar">
            <button class="itinerary-filter-btn active" data-itinerary-filter="all" onclick="setItineraryFilter('all')">All</button>
            <button class="itinerary-filter-btn" data-itinerary-filter="attraction" onclick="setItineraryFilter('attraction')">🏛️ Attraction</button>
            <button class="itinerary-filter-btn" data-itinerary-filter="food" onclick="setItineraryFilter('food')">🍜 Food</button>
            <button class="itinerary-filter-btn" data-itinerary-filter="transport" onclick="setItineraryFilter('transport')">🚌 Transport</button>
            <button class="itinerary-filter-btn" data-itinerary-filter="hotel" onclick="setItineraryFilter('hotel')">🏨 Hotel</button>
            <button class="itinerary-filter-btn" data-itinerary-filter="other" onclick="setItineraryFilter('other')">📌 Other</button>
          </div>
          <div id="daysContainer"></div>
        </div>

        <!-- Accommodation tab -->
        <div class="tab-panel" id="tab-accommodation">
          <div class="panel-actions-right">
            <button class="btn btn-primary" onclick="openAddAccomModal()">+ Add Accommodation</button>
          </div>
          <div id="accomContainer"></div>
        </div>

        <!-- Transport tab -->
        <div class="tab-panel" id="tab-transport">
          <div class="panel-actions-right">
            <button class="btn btn-primary" onclick="openAddTransportModal()">+ Add Transport</button>
          </div>
          <div id="transportContainer"></div>
        </div>

        <!-- Budget tab -->
        <div class="tab-panel" id="tab-budget">
          <div class="budget-overview" id="budgetOverview"></div>
          <div class="section-head">
            <h2>Expenses</h2>
            <button class="btn btn-primary btn-sm" onclick="openAddExpenseModal()">+ Add Expense</button>
          </div>
          <div class="table-scroll">
            <table class="expense-table" id="expenseTable">
              <thead><tr>
                <th>Item</th><th>Category</th><th>Date</th><th>Amount</th><th></th>
              </tr></thead>
              <tbody id="expenseBody"></tbody>
            </table>
          </div>
        </div>

        <!-- Packing tab -->
        <div class="tab-panel" id="tab-packing">
          <div class="panel-actions-right">
            <button class="btn btn-primary" onclick="openAddPackingModal()">+ Add Item</button>
          </div>
          <div class="checklist-grid" id="packingGrid"></div>
        </div>
      </div>

      <!-- What to Consider -->
      <div class="panel" id="panel-considerations">
        <div class="section-head" style="margin-bottom:24px;">
          <h2>What to Consider When Planning a Trip</h2>
        </div>
        <div class="considerations-grid">
          <div class="consider-card">
            <div class="c-icon">📄</div>
            <h3>Documents & Visas</h3>
            <ul>
              <li>Passport validity (6 months beyond travel)</li>
              <li>Visa requirements & processing time</li>
              <li>Travel insurance documents</li>
              <li>Vaccination certificates if required</li>
              <li>International driving permit</li>
              <li>Copies of all key documents</li>
            </ul>
          </div>
          <div class="consider-card">
            <div class="c-icon">💰</div>
            <h3>Budget Planning</h3>
            <ul>
              <li>Flights & local transport</li>
              <li>Accommodation costs</li>
              <li>Daily food & drink budget</li>
              <li>Activities & entrance fees</li>
              <li>Emergency contingency fund (10–15%)</li>
              <li>Currency exchange rates & fees</li>
            </ul>
          </div>
          <div class="consider-card">
            <div class="c-icon">✈️</div>
            <h3>Flights & Transport</h3>
            <ul>
              <li>Book flights early for best prices</li>
              <li>Airport transfer options</li>
              <li>Ground transport (train, car, bus)</li>
              <li>Transit stops & layovers</li>
              <li>Baggage allowance rules</li>
              <li>Car rental requirements</li>
            </ul>
          </div>
          <div class="consider-card">
            <div class="c-icon">🏨</div>
            <h3>Accommodation</h3>
            <ul>
              <li>Location relative to attractions</li>
              <li>Check-in / check-out flexibility</li>
              <li>Cancellation policies</li>
              <li>Amenities needed (Wi-Fi, kitchen)</li>
              <li>Safety of neighbourhood</li>
              <li>Reviews & ratings</li>
            </ul>
          </div>
          <div class="consider-card">
            <div class="c-icon">🌤️</div>
            <h3>Timing & Weather</h3>
            <ul>
              <li>Peak vs off-peak seasons</li>
              <li>Monsoon or hurricane seasons</li>
              <li>Local public holidays & events</li>
              <li>Daylight hours at destination</li>
              <li>Time zone adjustments</li>
              <li>Festival or event timing</li>
            </ul>
          </div>
          <div class="consider-card">
            <div class="c-icon">🏥</div>
            <h3>Health & Safety</h3>
            <ul>
              <li>Required & recommended vaccines</li>
              <li>Travel health insurance coverage</li>
              <li>Nearest hospitals & clinics</li>
              <li>Prescription medicines & supply</li>
              <li>Food & water safety standards</li>
              <li>Emergency contact numbers</li>
            </ul>
          </div>
          <div class="consider-card">
            <div class="c-icon">📱</div>
            <h3>Connectivity</h3>
            <ul>
              <li>Local SIM card vs roaming plan</li>
              <li>Offline maps downloaded</li>
              <li>Important apps installed</li>
              <li>Power adapter/plug type</li>
              <li>Portable charger capacity</li>
              <li>Notify bank of travel</li>
            </ul>
          </div>
          <div class="consider-card">
            <div class="c-icon">🌍</div>
            <h3>Culture & Etiquette</h3>
            <ul>
              <li>Dress code for temples & sites</li>
              <li>Tipping customs and amounts</li>
              <li>Basic local language phrases</li>
              <li>Photography restrictions</li>
              <li>Dietary laws & restrictions</li>
              <li>Local laws & regulations</li>
            </ul>
          </div>
          <div class="consider-card">
            <div class="c-icon">🎒</div>
            <h3>Packing Essentials</h3>
            <ul>
              <li>Climate-appropriate clothing</li>
              <li>Comfortable walking shoes</li>
              <li>Universal travel adapter</li>
              <li>First aid & medications</li>
              <li>Sunscreen & insect repellent</li>
              <li>Reusable water bottle</li>
            </ul>
          </div>
        </div>
      </div>

      <!-- Settings -->
      <div class="panel" id="panel-settings">
        <div class="section-head" style="margin-bottom:24px;"><h2>Settings</h2></div>
        <div class="settings-wrap">
          <div class="settings-card">
            <h3 class="settings-card-title">Default Currency</h3>
            <p class="settings-card-note">Used across budget tracking</p>
            <div class="form-group">
              <select id="settingsCurrency" onchange="saveCurrencyPref()">
                <option>MYR</option><option>USD</option><option>EUR</option><option>GBP</option><option>SGD</option><option>AUD</option><option>JPY</option><option>THB</option>
              </select>
            </div>
          </div>
        </div>
      </div>

    </div>
  </main>
</div>

<!-- ─── Modals ─── -->

<!-- New Trip -->
<div class="modal-overlay" id="modalNewTrip">
  <div class="modal">
    <div class="modal-head">
      <h2 id="tripModalTitle">New Trip ✈️</h2>
      <button class="modal-close" onclick="closeTripModal()">✕</button>
    </div>
    <div class="modal-body">
      <input type="hidden" id="fTripId" />
      <div class="form-group"><label>Trip Name</label><input type="text" id="fTripName" placeholder="e.g. Tokyo Spring 2025" /></div>
      <div class="form-row">
        <div class="form-group">
          <label>Destination</label>
          <div class="trip-destination-row">
            <input type="text" id="fTripDest" placeholder="e.g. Tokyo, Japan" />
            <button type="button" class="btn btn-secondary btn-sm btn-nowrap" onclick="appendDestinationSeparator()">+ Destination</button>
          </div>
        </div>
        <div class="form-group"><label>Country Flag (emoji)</label><input type="text" id="fTripFlag" placeholder="🇯🇵 🇰🇷 🇹🇭" maxlength="40" /></div>
      </div>
      <div class="form-row">
        <div class="form-group"><label>Start Date</label><input type="date" id="fTripStart" /></div>
        <div class="form-group"><label>End Date</label><input type="date" id="fTripEnd" /></div>
      </div>
      <div class="form-row">
        <div class="form-group"><label>Total Budget</label><input type="number" id="fTripBudget" placeholder="5000" /></div>
        <div class="form-group"><label>Currency</label>
          <select id="fTripCurrency">
            <option>MYR</option><option>USD</option><option>EUR</option><option>GBP</option><option>SGD</option><option>AUD</option><option>JPY</option><option>THB</option>
          </select>
        </div>
      </div>
      <div class="form-group"><label>Notes</label><textarea id="fTripNotes" placeholder="Purpose of trip, special occasions..."></textarea></div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-ghost" onclick="closeTripModal()">Cancel</button>
      <button class="btn btn-primary" id="tripModalSaveBtn" onclick="saveTrip()">Create Trip</button>
    </div>
  </div>
</div>

<!-- Add Day -->
<div class="modal-overlay" id="modalAddDay">
  <div class="modal">
    <div class="modal-head">
      <h2>Add Day</h2>
      <button class="modal-close" onclick="closeModal('modalAddDay')">✕</button>
    </div>
    <div class="modal-body">
      <div class="form-row">
        <div class="form-group"><label>Day Number</label><input type="number" id="fDayNum" placeholder="1" /></div>
        <div class="form-group"><label>Date</label><input type="date" id="fDayDate" /></div>
      </div>
      <div class="form-group"><label>Day Title</label><input type="text" id="fDayTitle" placeholder="e.g. Arrival & Shibuya Explore" /></div>
      <div class="form-group"><label>Notes</label><textarea id="fDayNotes" placeholder="General notes for the day..."></textarea></div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-ghost" onclick="closeModal('modalAddDay')">Cancel</button>
      <button class="btn btn-primary" onclick="saveDay()">Add Day</button>
    </div>
  </div>
</div>

<!-- Add Activity -->
<div class="modal-overlay" id="modalAddActivity">
  <div class="modal">
    <div class="modal-head">
      <h2 id="activityModalTitle">Add Activity</h2>
      <button class="modal-close" onclick="closeActivityModal()">✕</button>
    </div>
    <div class="modal-body">
      <input type="hidden" id="fActId" />
      <input type="hidden" id="fActDayId" />
      <div class="form-group"><label>Activity Name</label><input type="text" id="fActTitle" placeholder="e.g. Visit Senso-ji Temple" /></div>
      <div class="form-row">
        <div class="form-group"><label>Category</label>
          <select id="fActCat">
            <option value="attraction">🏛️ Attraction</option>
            <option value="food">🍜 Food & Drink</option>
            <option value="transport">🚌 Transport</option>
            <option value="hotel">🏨 Hotel</option>
            <option value="other">📌 Other</option>
          </select>
        </div>
        <div class="form-group"><label>Time</label><input type="time" id="fActTime" /></div>
      </div>
      <div class="form-group"><label>Location / Address</label><input type="text" id="fActLoc" placeholder="Asakusa, Tokyo" /></div>
      <div class="form-group"><label>Description</label><textarea id="fActDesc" placeholder="Details, tips, booking info..." style="min-height:60px;"></textarea></div>
      <div class="form-group"><label>Estimated Cost</label><input type="number" id="fActCost" placeholder="0" /></div>
      <div class="activity-cost-hint" id="activityCostHint"></div>

      <details class="activity-fx" id="activityFxPanel">
        <summary>Need currency conversion? (Optional)</summary>
        <div class="activity-fx-row">
          <div class="activity-fx-line">
            <div class="form-group"><label>Amount A</label><input type="number" id="fActFromAmt" placeholder="0" oninput="setActivityFxDirection('from')" /></div>
            <div class="form-group"><label>Currency A</label>
              <select id="fActFromCur" onchange="setActivityFxDirection('from')"></select>
            </div>
          </div>
          <div class="activity-fx-line">
            <div class="form-group"><label>Amount B</label><input type="number" id="fActToAmt" placeholder="0" oninput="setActivityFxDirection('to')" /></div>
            <div class="form-group"><label>Currency B</label>
              <select id="fActToCur" onchange="setActivityFxDirection('to')"></select>
            </div>
          </div>
        </div>
        <button class="btn btn-secondary" id="activityFxButton" type="button" onclick="convertActivityCost()">Convert</button>
        <div id="activityFxNote"></div>
      </details>
    </div>
    <div class="modal-footer">
      <button class="btn btn-ghost" onclick="closeActivityModal()">Cancel</button>
      <button class="btn btn-primary" id="activityModalSaveBtn" onclick="saveActivity()">Add Activity</button>
    </div>
  </div>
</div>

<!-- Add Accommodation -->
<div class="modal-overlay" id="modalAddAccom">
  <div class="modal">
    <div class="modal-head">
      <h2>Add Accommodation 🏨</h2>
      <button class="modal-close" onclick="closeModal('modalAddAccom')">✕</button>
    </div>
    <div class="modal-body">
      <div class="form-group"><label>Property Name</label><input type="text" id="fAccomName" placeholder="e.g. Park Hyatt Tokyo" /></div>
      <div class="form-group"><label>Address</label><input type="text" id="fAccomAddr" placeholder="Full address" /></div>
      <div class="form-row">
        <div class="form-group"><label>Check-in</label><input type="date" id="fAccomIn" /></div>
        <div class="form-group"><label>Check-out</label><input type="date" id="fAccomOut" /></div>
      </div>
      <div class="form-row">
        <div class="form-group"><label>Confirmation #</label><input type="text" id="fAccomConf" placeholder="ABC123" /></div>
        <div class="form-group"><label>Total Cost</label><input type="number" id="fAccomCost" placeholder="0" /></div>
      </div>
      <div class="form-group"><label>Notes</label><textarea id="fAccomNotes" placeholder="Booking platform, contact, special requests..."></textarea></div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-ghost" onclick="closeModal('modalAddAccom')">Cancel</button>
      <button class="btn btn-primary" onclick="saveAccom()">Save</button>
    </div>
  </div>
</div>

<!-- Add Transport -->
<div class="modal-overlay" id="modalAddTransport">
  <div class="modal">
    <div class="modal-head">
      <h2>Add Transport 🚌</h2>
      <button class="modal-close" onclick="closeModal('modalAddTransport')">✕</button>
    </div>
    <div class="modal-body">
      <div class="form-row">
        <div class="form-group"><label>Type</label>
          <select id="fTransType">
            <option>✈️ Flight</option><option>🚂 Train</option><option>🚌 Bus</option><option>🚗 Car Rental</option><option>🚢 Ferry</option><option>🚕 Taxi/Grab</option>
          </select>
        </div>
        <div class="form-group"><label>Confirmation #</label><input type="text" id="fTransConf" placeholder="Optional" /></div>
      </div>
      <div class="form-row">
        <div class="form-group"><label>From</label><input type="text" id="fTransFrom" placeholder="Kuala Lumpur" /></div>
        <div class="form-group"><label>To</label><input type="text" id="fTransTo" placeholder="Tokyo" /></div>
      </div>
      <div class="form-row">
        <div class="form-group"><label>Departure</label><input type="datetime-local" id="fTransDep" /></div>
        <div class="form-group"><label>Arrival</label><input type="datetime-local" id="fTransArr" /></div>
      </div>
      <div class="form-row">
        <div class="form-group"><label>Operator / Airline</label><input type="text" id="fTransOp" placeholder="AirAsia" /></div>
        <div class="form-group"><label>Cost</label><input type="number" id="fTransCost" placeholder="0" /></div>
      </div>
      <div class="form-group"><label>Notes</label><textarea id="fTransNotes" placeholder="Seat numbers, terminal, baggage info..."></textarea></div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-ghost" onclick="closeModal('modalAddTransport')">Cancel</button>
      <button class="btn btn-primary" onclick="saveTransport()">Save</button>
    </div>
  </div>
</div>

<!-- Add Expense -->
<div class="modal-overlay" id="modalAddExpense">
  <div class="modal">
    <div class="modal-head">
      <h2>Add Expense 💸</h2>
      <button class="modal-close" onclick="closeModal('modalAddExpense')">✕</button>
    </div>
    <div class="modal-body">
      <div class="form-group"><label>Item</label><input type="text" id="fExpItem" placeholder="e.g. Dinner at Nishiki Market" /></div>
      <div class="form-row">
        <div class="form-group"><label>Category</label>
          <select id="fExpCat">
            <option>🍜 Food</option><option>🏛️ Activity</option><option>✈️ Flight</option><option>🏨 Accommodation</option><option>🚌 Transport</option><option>🛍️ Shopping</option><option>💊 Health</option><option>📌 Other</option>
          </select>
        </div>
        <div class="form-group"><label>Date</label><input type="date" id="fExpDate" /></div>
      </div>
      <div class="form-row">
        <div class="form-group"><label>From Currency</label><select id="fExpFromCur"></select></div>
        <div class="form-group"><label>Amount In Source Currency</label><input type="number" id="fExpFromAmt" placeholder="0" /></div>
      </div>
      <div class="form-row">
        <div class="form-group"><label>To Currency</label><select id="fExpToCur"></select></div>
        <div class="form-group align-end">
          <button class="btn btn-secondary" type="button" onclick="convertExpenseAmount()">Convert &amp; Fill Amount</button>
        </div>
      </div>
      <div id="expenseFxNote" class="fx-note"></div>
      <div class="form-group"><label>Amount (Saved Currency)</label><input type="number" id="fExpAmt" placeholder="0" /></div>
      <div class="form-group"><label>Notes</label><textarea id="fExpNotes" placeholder="Optional notes..." style="min-height:60px;"></textarea></div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-ghost" onclick="closeModal('modalAddExpense')">Cancel</button>
      <button class="btn btn-primary" onclick="saveExpense()">Save</button>
    </div>
  </div>
</div>

<!-- Add Packing Item -->
<div class="modal-overlay" id="modalAddPacking">
  <div class="modal">
    <div class="modal-head">
      <h2>Add Packing Item 🎒</h2>
      <button class="modal-close" onclick="closeModal('modalAddPacking')">✕</button>
    </div>
    <div class="modal-body">
      <div class="form-row">
        <div class="form-group"><label>Item Name</label><input type="text" id="fPackItem" placeholder="e.g. Rain jacket" /></div>
        <div class="form-group"><label>Category</label>
          <select id="fPackCat">
            <option>👕 Clothing</option><option>🔌 Electronics</option><option>💊 Health</option><option>📄 Documents</option><option>🧴 Toiletries</option><option>📌 Other</option>
          </select>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-ghost" onclick="closeModal('modalAddPacking')">Cancel</button>
      <button class="btn btn-primary" onclick="savePacking()">Add Item</button>
    </div>
  </div>
</div>

<!-- Toast container -->
<div class="toast-container" id="toastContainer"></div>

<script>
// ─── State ───────────────────────────────────────────────────────────────
let sbClient = null;
let currentTripId = null;
let currentTripData = null;
let currency = 'MYR';
const expandedDayIds = new Set();
let itineraryCategoryFilter = 'all';
let activityFxDirection = 'from';
let syncInProgress = false;
let offlineReadNotified = false;
let loadDaysToken = 0;
let sidebarCollapsed = false;
let lastSidebarDesktopState = window.innerWidth >= 1024;
let currentUser = null;
let userScopeColumnAvailable = null;
let tableScopeSupport = {};
let scopeDetectedForUserId = null;
let authWarningShown = false;

const DEFAULT_SUPABASE_URL = window.__VOYAGEUR_SUPABASE_URL || 'https://usnqzrkwwxhafuxidxlq.supabase.co';
const DEFAULT_SUPABASE_ANON_KEY = window.__VOYAGEUR_SUPABASE_ANON_KEY || 'sb_publishable_h6fEKv_SWz5Z_laFKOVsEw_CxfJZRsu';
const ENABLE_USER_SCOPE = window.__VOYAGEUR_ENABLE_USER_SCOPE === true;
const ACCESS_MODE = String(window.__VOYAGEUR_ACCESS_MODE || 'shared').toLowerCase() === 'private' ? 'private' : 'shared';
const FX_API_BASE = 'https://api.frankfurter.dev/v1';
const FX_CURRENCIES = ['AED','AUD','BGN','BRL','CAD','CHF','CNY','CZK','DKK','EUR','GBP','HKD','HUF','IDR','ILS','INR','ISK','JPY','KRW','MXN','MYR','NOK','NZD','PHP','PLN','RON','SEK','SGD','THB','TRY','USD','ZAR'];
const FX_RATE_CACHE_PREFIX = 'voyageur_fx_rate_v1';
const OFFLINE_CACHE_KEY = 'voyageur_offline_cache_v1';
const OFFLINE_QUEUE_KEY = 'voyageur_sync_queue_v1';
const SIDEBAR_COLLAPSE_KEY = 'voyageur_sidebar_collapsed_v1';
const DB_TABLES = ['trips', 'days', 'activities', 'accommodations', 'transports', 'expenses', 'packing'];
let offlineCache = createEmptyCache();
let syncQueue = [];

// ─── Config ──────────────────────────────────────────────────────────────
function initApp() {
  bindConnectivityEvents();
  initSidebarState();
  window.addEventListener('resize', syncSidebarWithViewport);
  document.addEventListener('click', handleActionMenuDocumentClick);

  currency = localStorage.getItem('def_currency') || 'MYR';
  const url = DEFAULT_SUPABASE_URL;
  const key = DEFAULT_SUPABASE_ANON_KEY;

  try {
    if (window.supabase?.createClient) {
      sbClient = window.supabase.createClient(url, key);
    }
    if (!sbClient) {
      toast('Supabase client unavailable. Check script loading.', 'error');
      return;
    }
    initGuestAuthFlow();
  } catch (e) {
    console.error(e);
    toast('App initialization failed. Refresh and try again.', 'error');
  }
}

function launchApp() {
  document.getElementById('mainApp').style.display = 'flex';
  document.getElementById('settingsCurrency').value = currency;
  loadDashboard();
}

function saveCurrencyPref() {
  currency = document.getElementById('settingsCurrency').value;
  localStorage.setItem('def_currency', currency);
}

function escapeHtml(value) {
  return String(value ?? '')
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;')
    .replace(/'/g, '&#39;');
}

function escapeJsString(value) {
  return String(value ?? '')
    .replace(/\\/g, '\\\\')
    .replace(/'/g, "\\'")
    .replace(/\r/g, '\\r')
    .replace(/\n/g, '\\n')
    .replace(/</g, '\\x3c')
    .replace(/>/g, '\\x3e');
}

function safeText(value) { return escapeHtml(value); }
function safeJsArg(value) { return escapeJsString(value); }
function makeDomId(prefix, value) {
  return `${prefix}${String(value ?? '').replace(/[^a-zA-Z0-9_-]/g, '_')}`;
}
function normalizeActivityCategory(value) {
  const cat = String(value || 'other').toLowerCase();
  return ['food', 'attraction', 'transport', 'hotel', 'other'].includes(cat) ? cat : 'other';
}

function scopedStorageKey(base) {
  return `${base}_${currentUser?.id || 'anon'}`;
}

function requireAuthSession() {
  if (!ENABLE_USER_SCOPE) return true;
  if (currentUser) return true;
  if (!authWarningShown) {
    toast('Guest auth unavailable. Enable Supabase Anonymous Sign-Ins.', 'error');
    authWarningShown = true;
  }
  return false;
}

function hasUserScope(table) {
  return ACCESS_MODE === 'private' && !!currentUser && tableScopeSupport[table] === true;
}

function shouldAttachUserId(table) {
  return !!currentUser && tableScopeSupport[table] === true;
}

function withUserScopePayload(table, payload, includeUserId = false) {
  if (!includeUserId || !shouldAttachUserId(table)) return { ...payload };
  return { ...payload, user_id: currentUser.id };
}

function applyUserScopeToQuery(query, table) {
  if (!hasUserScope(table)) return query;
  return query.eq('user_id', currentUser.id);
}

function applyUserScopeToMutation(query, table, id) {
  let q = query.eq('id', id);
  if (hasUserScope(table)) q = q.eq('user_id', currentUser.id);
  return q;
}

async function initGuestAuthFlow() {
  if (!sbClient) return;
  currentUser = null;
  authWarningShown = false;

  if (!ENABLE_USER_SCOPE) {
    loadOfflineState();
    await detectUserScopeCapability();
    launchApp();
    updateSyncStatusBadge();
    syncPendingOperations();
    return;
  }

  try {
    const { data, error } = await sbClient.auth.getSession();
    if (error) throw error;
    currentUser = data?.session?.user || null;

    if (!currentUser && typeof sbClient.auth.signInAnonymously === 'function') {
      const { data: anonData, error: anonError } = await sbClient.auth.signInAnonymously();
      if (anonError) throw anonError;
      currentUser = anonData?.user || anonData?.session?.user || null;
    }
  } catch (error) {
    console.warn('Automatic guest auth failed:', error?.message || error);
    currentUser = null;
  }

  if (currentUser) {
    loadOfflineState();
  } else {
    offlineCache = createEmptyCache();
    syncQueue = [];
    persistOfflineCache();
    persistSyncQueue();
  }

  await detectUserScopeCapability();
  launchApp();
  updateSyncStatusBadge();
  syncPendingOperations();
}

async function detectUserScopeCapability() {
  const scopeKey = currentUser?.id || 'anon';
  if (!sbClient || scopeDetectedForUserId === scopeKey) return;

  tableScopeSupport = {};
  DB_TABLES.forEach(table => {
    tableScopeSupport[table] = ENABLE_USER_SCOPE && !!currentUser;
  });
  userScopeColumnAvailable = ENABLE_USER_SCOPE && !!currentUser;
  scopeDetectedForUserId = scopeKey;

  if (!ENABLE_USER_SCOPE) {
    console.info('User scope disabled: running shared mode without per-user auth filters.');
  } else if (!currentUser) {
    console.warn('Anonymous auth is disabled in Supabase. Enable it to use app without login UI.');
  } else if (ACCESS_MODE === 'shared') {
    console.info('Shared mode enabled: authenticated users can see/edit shared data.');
  }
}

function applySidebarState(collapsed) {
  sidebarCollapsed = !!collapsed;
  const app = document.getElementById('mainApp');
  if (app) app.classList.toggle('sidebar-collapsed', sidebarCollapsed);

  const toggleBtn = document.getElementById('sidebarToggleBtn');
  if (toggleBtn) {
    toggleBtn.textContent = sidebarCollapsed ? '☰' : '☷';
    toggleBtn.setAttribute('aria-label', sidebarCollapsed ? 'Expand sidebar' : 'Collapse sidebar');
    toggleBtn.title = sidebarCollapsed ? 'Expand sidebar' : 'Collapse sidebar';
  }

  const wordmark = document.getElementById('sidebarWordmark');
  if (wordmark) {
    const full = wordmark.getAttribute('data-full') || 'Voyageur';
    const short = wordmark.getAttribute('data-short') || 'V';
    wordmark.textContent = sidebarCollapsed ? short : full;
  }
}

function initSidebarState() {
  lastSidebarDesktopState = window.innerWidth >= 1024;
  if (window.innerWidth < 1024) {
    applySidebarState(true);
    return;
  }
  const saved = localStorage.getItem(SIDEBAR_COLLAPSE_KEY);
  applySidebarState(saved === null ? false : saved === '1');
}

function toggleSidebar() {
  const next = !sidebarCollapsed;
  applySidebarState(next);
  if (window.innerWidth < 1024) return;
  localStorage.setItem(SIDEBAR_COLLAPSE_KEY, next ? '1' : '0');
}

function closeSidebarOnMobile() {
  if (window.innerWidth >= 1024 || sidebarCollapsed) return;
  applySidebarState(true);
}

function syncSidebarWithViewport() {
  const isDesktop = window.innerWidth >= 1024;
  if (isDesktop === lastSidebarDesktopState) return;
  lastSidebarDesktopState = isDesktop;

  if (!isDesktop) {
    applySidebarState(true);
    return;
  }

  const saved = localStorage.getItem(SIDEBAR_COLLAPSE_KEY);
  applySidebarState(saved === null ? false : saved === '1');
}

// ─── Offline helpers ─────────────────────────────────────────────────────
function createEmptyCache() {
  const initial = {};
  DB_TABLES.forEach(table => { initial[table] = []; });
  return initial;
}

function ensureCacheTable(table) {
  if (!Array.isArray(offlineCache[table])) offlineCache[table] = [];
}

function persistOfflineCache() {
  localStorage.setItem(scopedStorageKey(OFFLINE_CACHE_KEY), JSON.stringify(offlineCache));
}

function persistSyncQueue() {
  localStorage.setItem(scopedStorageKey(OFFLINE_QUEUE_KEY), JSON.stringify(syncQueue));
}

function loadOfflineState() {
  try {
    const parsedCache = JSON.parse(localStorage.getItem(scopedStorageKey(OFFLINE_CACHE_KEY)) || '{}');
    const parsedQueue = JSON.parse(localStorage.getItem(scopedStorageKey(OFFLINE_QUEUE_KEY)) || '[]');
    offlineCache = createEmptyCache();
    DB_TABLES.forEach(table => {
      offlineCache[table] = Array.isArray(parsedCache[table]) ? parsedCache[table] : [];
    });
    syncQueue = Array.isArray(parsedQueue) ? parsedQueue : [];
  } catch (error) {
    console.error('Offline state parse failed', error);
    offlineCache = createEmptyCache();
    syncQueue = [];
  }
}

function isOnline() {
  return navigator.onLine;
}

function getFxCacheKey(fromCurrency, toCurrency) {
  return `${FX_RATE_CACHE_PREFIX}_${fromCurrency}_${toCurrency}`;
}

function saveFxRate(fromCurrency, toCurrency, rate, date) {
  if (!Number.isFinite(rate)) return;
  const payload = { rate, date: date || new Date().toISOString().slice(0, 10), saved_at: new Date().toISOString() };
  localStorage.setItem(getFxCacheKey(fromCurrency, toCurrency), JSON.stringify(payload));
}

function loadFxRate(fromCurrency, toCurrency) {
  try {
    const raw = localStorage.getItem(getFxCacheKey(fromCurrency, toCurrency));
    if (!raw) return null;
    const parsed = JSON.parse(raw);
    const rate = Number(parsed?.rate);
    if (!Number.isFinite(rate) || rate <= 0) return null;
    return { rate, date: parsed?.date || '', saved_at: parsed?.saved_at || '' };
  } catch (_) {
    return null;
  }
}

function formatFxNote(fromCurrency, toCurrency, result) {
  const suffix = result.cached ? `${result.date || 'cached'} · cached` : (result.date || 'live');
  return `1 ${fromCurrency} = ${result.rate.toFixed(6)} ${toCurrency} (${suffix})`;
}

function updateSyncStatusBadge() {
  const badge = document.getElementById('syncStatusBadge');
  if (!badge) return;
  const pending = syncQueue.length;
  badge.classList.remove('online', 'offline', 'syncing');

  if (syncInProgress) {
    badge.classList.add('syncing');
    badge.textContent = pending ? `Syncing ${pending}...` : 'Syncing...';
    return;
  }
  if (!isOnline()) {
    badge.classList.add('offline');
    badge.textContent = pending ? `Offline · ${pending} pending` : 'Offline';
    return;
  }
  if (pending > 0) {
    badge.classList.add('syncing');
    badge.textContent = `Online · ${pending} pending`;
  } else {
    badge.classList.add('online');
    badge.textContent = 'Online';
  }
}

function bindConnectivityEvents() {
  window.addEventListener('online', () => {
    offlineReadNotified = false;
    updateSyncStatusBadge();
    toast('Back online. Syncing changes...');
    syncPendingOperations();
  });
  window.addEventListener('offline', () => {
    updateSyncStatusBadge();
    toast('Offline mode: changes will sync later', 'error');
  });
}

function isNetworkError(error) {
  const message = String(error?.message || error || '').toLowerCase();
  return message.includes('failed to fetch')
    || message.includes('networkerror')
    || message.includes('network error')
    || message.includes('load failed')
    || message.includes('offline');
}

function makeClientId() {
  if (window.crypto?.randomUUID) return window.crypto.randomUUID();
  return `id_${Date.now()}_${Math.random().toString(16).slice(2, 10)}`;
}

function sortedByCreatedAt(rows) {
  return [...rows].sort((a, b) => String(a?.created_at || '').localeCompare(String(b?.created_at || '')));
}

function filterRows(rows, filters = {}) {
  const entries = Object.entries(filters);
  if (!entries.length) return sortedByCreatedAt(rows);
  return sortedByCreatedAt(rows.filter(row => entries.every(([k, v]) => row?.[k] === v)));
}

function upsertCachedRow(table, row) {
  ensureCacheTable(table);
  const nextRow = { created_at: new Date().toISOString(), ...row };
  if (!nextRow.id) nextRow.id = makeClientId();
  const idx = offlineCache[table].findIndex(item => item.id === nextRow.id);
  if (idx === -1) offlineCache[table].push(nextRow);
  else offlineCache[table][idx] = { ...offlineCache[table][idx], ...nextRow };
  persistOfflineCache();
  return nextRow;
}

function replaceCachedTable(table, rows) {
  ensureCacheTable(table);
  offlineCache[table] = sortedByCreatedAt((rows || []).map(row => ({ created_at: new Date().toISOString(), ...row })));
  persistOfflineCache();
}

function mergeCachedRows(table, rows) {
  ensureCacheTable(table);
  const map = new Map(offlineCache[table].map(row => [row.id, row]));
  (rows || []).forEach(row => {
    if (!row?.id) return;
    map.set(row.id, { created_at: new Date().toISOString(), ...(map.get(row.id) || {}), ...row });
  });
  offlineCache[table] = sortedByCreatedAt(Array.from(map.values()));
  persistOfflineCache();
}

function updateCachedRow(table, id, patch) {
  ensureCacheTable(table);
  const idx = offlineCache[table].findIndex(item => item.id === id);
  if (idx === -1) {
    const created = { id, created_at: new Date().toISOString(), ...patch };
    offlineCache[table].push(created);
    persistOfflineCache();
    return created;
  }
  offlineCache[table][idx] = { ...offlineCache[table][idx], ...patch };
  persistOfflineCache();
  return offlineCache[table][idx];
}

function removeCachedRow(table, id) {
  ensureCacheTable(table);
  const idx = offlineCache[table].findIndex(item => item.id === id);
  if (idx === -1) return null;
  const [removed] = offlineCache[table].splice(idx, 1);
  persistOfflineCache();
  return removed;
}

function getCachedById(table, id) {
  ensureCacheTable(table);
  return offlineCache[table].find(item => item.id === id) || null;
}

function getCachedRows(table, filters = {}) {
  ensureCacheTable(table);
  return filterRows(offlineCache[table], filters);
}

function applyQueuedOpsToRows(table, baseRows) {
  const map = new Map((baseRows || []).map(row => [row.id, { ...row }]));
  for (const op of syncQueue) {
    if (op.table !== table) continue;
    if (op.op === 'insert') {
      map.set(op.id, { ...(map.get(op.id) || {}), ...(op.payload || { id: op.id }) });
      continue;
    }
    if (op.op === 'update') {
      map.set(op.id, { ...(map.get(op.id) || { id: op.id }), ...(op.payload || {}) });
      continue;
    }
    if (op.op === 'delete') map.delete(op.id);
  }
  return sortedByCreatedAt(Array.from(map.values()));
}

function enqueueSyncOperation(op) {
  if (!op || !op.table || !op.id || !op.op) return;

  if (op.op === 'update') {
    for (let i = syncQueue.length - 1; i >= 0; i--) {
      const existing = syncQueue[i];
      if (existing.table !== op.table || existing.id !== op.id) continue;
      if (existing.op === 'insert' || existing.op === 'update') {
        existing.payload = { ...(existing.payload || {}), ...(op.payload || {}) };
        persistSyncQueue();
        updateSyncStatusBadge();
        return;
      }
      if (existing.op === 'delete') {
        updateSyncStatusBadge();
        return;
      }
    }
  }

  if (op.op === 'delete') {
    for (let i = syncQueue.length - 1; i >= 0; i--) {
      const existing = syncQueue[i];
      if (existing.table !== op.table || existing.id !== op.id) continue;
      if (existing.op === 'insert' || existing.op === 'update') {
        syncQueue.splice(i, 1);
      } else if (existing.op === 'delete') {
        persistSyncQueue();
        updateSyncStatusBadge();
        return;
      }
    }
  }

  syncQueue.push({ ...op, queued_at: new Date().toISOString() });
  persistSyncQueue();
  updateSyncStatusBadge();
}

async function syncPendingOperations() {
  if (!sbClient || !currentUser || !isOnline() || syncInProgress || !syncQueue.length) {
    updateSyncStatusBadge();
    return;
  }

  syncInProgress = true;
  updateSyncStatusBadge();

  let synced = 0;
  while (syncQueue.length) {
    const item = syncQueue[0];
    try {
      if (item.op === 'insert') {
        const payload = withUserScopePayload(item.table, item.payload || {}, true);
        const { error } = await sbClient.from(item.table).upsert(payload, { onConflict: 'id' });
        if (error) throw error;
      } else if (item.op === 'update') {
        const payload = withUserScopePayload(item.table, item.payload || {});
        const mutation = applyUserScopeToMutation(sbClient.from(item.table).update(payload), item.table, item.id);
        const { error } = await mutation;
        if (error) throw error;
      } else if (item.op === 'delete') {
        const mutation = applyUserScopeToMutation(sbClient.from(item.table).delete(), item.table, item.id);
        const { error } = await mutation;
        if (error) throw error;
      }
      syncQueue.shift();
      synced++;
      persistSyncQueue();
      updateSyncStatusBadge();
    } catch (error) {
      if (isNetworkError(error)) break;
      console.error('Sync failed for queued op', item, error);
      syncQueue.shift();
      persistSyncQueue();
      toast(`Skipped 1 invalid queued change (${item.table})`, 'error');
      updateSyncStatusBadge();
    }
  }

  syncInProgress = false;
  updateSyncStatusBadge();
  if (synced > 0) toast(`Synced ${synced} change(s)`);
}

// ─── DB helpers ──────────────────────────────────────────────────────────
async function dbQuery(table, filters = {}) {
  if (!requireAuthSession()) return [];
  if (sbClient && isOnline()) {
    try {
      let q = applyUserScopeToQuery(sbClient.from(table).select('*'), table);
      for (const [k, v] of Object.entries(filters)) q = q.eq(k, v);
      const { data, error } = await q.order('created_at', { ascending: true });
      if (error) throw error;
      offlineReadNotified = false;
      const rows = applyQueuedOpsToRows(table, data || []);
      if (Object.keys(filters).length === 0) replaceCachedTable(table, rows);
      else mergeCachedRows(table, rows);
      return getCachedRows(table, filters);
    } catch (error) {
      if (!isNetworkError(error)) {
        console.error(error);
        toast('DB error: ' + error.message, 'error');
      } else if (!offlineReadNotified) {
        toast('Offline mode: showing cached data', 'error');
        offlineReadNotified = true;
      }
    }
  }
  return getCachedRows(table, filters);
}

async function dbGetById(table, id) {
  if (!requireAuthSession()) return null;
  const cached = getCachedById(table, id);
  const hasQueuedDelete = syncQueue.some(op => op.table === table && op.id === id && op.op === 'delete');
  if (hasQueuedDelete) return null;
  const hasQueuedLocal = syncQueue.some(op => op.table === table && op.id === id && op.op !== 'delete');
  if (cached && hasQueuedLocal) return cached;

  if (sbClient && isOnline()) {
    try {
      let q = applyUserScopeToQuery(sbClient.from(table).select('*'), table).eq('id', id);
      const { data, error } = await q.single();
      if (error) throw error;
      const rows = applyQueuedOpsToRows(table, data ? [data] : []);
      const row = rows.find(item => item.id === id) || null;
      if (row) upsertCachedRow(table, row);
      return row;
    } catch (error) {
      if (!isNetworkError(error)) toast('DB error: ' + error.message, 'error');
    }
  }
  return cached;
}

async function dbInsert(table, obj) {
  if (!requireAuthSession()) return null;
  const localPayload = withUserScopePayload(table, obj || {}, true);
  const localRow = upsertCachedRow(table, { ...localPayload, id: localPayload?.id || makeClientId() });
  if (!sbClient || !isOnline()) {
    enqueueSyncOperation({ op: 'insert', table, id: localRow.id, payload: localRow });
    return localRow;
  }

  try {
    const payload = withUserScopePayload(table, localRow, true);
    const { data, error } = await sbClient.from(table).upsert(payload, { onConflict: 'id' }).select().single();
    if (error) throw error;
    if (data) upsertCachedRow(table, data);
    return data || localRow;
  } catch (error) {
    if (isNetworkError(error)) {
      enqueueSyncOperation({ op: 'insert', table, id: localRow.id, payload: localRow });
      updateSyncStatusBadge();
      return localRow;
    }
    removeCachedRow(table, localRow.id);
    toast('DB error: ' + error.message, 'error');
    return null;
  }
}

async function dbDelete(table, id) {
  if (!requireAuthSession()) return false;
  const backup = getCachedById(table, id);
  removeCachedRow(table, id);

  if (!sbClient || !isOnline()) {
    enqueueSyncOperation({ op: 'delete', table, id });
    return true;
  }

  try {
    const mutation = applyUserScopeToMutation(sbClient.from(table).delete(), table, id);
    const { error } = await mutation;
    if (error) throw error;
    return true;
  } catch (error) {
    if (isNetworkError(error)) {
      enqueueSyncOperation({ op: 'delete', table, id });
      updateSyncStatusBadge();
      return true;
    }
    if (backup) upsertCachedRow(table, backup);
    toast('Delete error: ' + error.message, 'error');
    return false;
  }
}

async function dbUpdate(table, id, obj) {
  if (!requireAuthSession()) return false;
  const backup = getCachedById(table, id);
  const localPatch = withUserScopePayload(table, obj || {});
  updateCachedRow(table, id, localPatch);

  if (!sbClient || !isOnline()) {
    enqueueSyncOperation({ op: 'update', table, id, payload: localPatch });
    return true;
  }

  try {
    const mutation = applyUserScopeToMutation(sbClient.from(table).update(localPatch), table, id);
    const { error } = await mutation;
    if (error) throw error;
    return true;
  } catch (error) {
    if (isNetworkError(error)) {
      enqueueSyncOperation({ op: 'update', table, id, payload: localPatch });
      updateSyncStatusBadge();
      return true;
    }
    if (backup) upsertCachedRow(table, backup);
    toast('Update error: ' + error.message, 'error');
    return false;
  }
}

// ─── Navigation ──────────────────────────────────────────────────────────
function showPanel(name) {
  closeSidebarOnMobile();
  document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
  document.querySelector(`#panel-${name}`)?.classList.add('active');
  document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
  const panelTitles = { dashboard:'Dashboard', considerations:'What to Consider', settings:'Settings' };
  document.getElementById('topbarTitle').textContent = panelTitles[name] || 'Dashboard';
  const acts = document.getElementById('topbarActions');
  acts.innerHTML = name === 'dashboard' ? '<button class="btn btn-primary" onclick="openNewTripModal()">+ New Trip</button>' : '';
  if (name === 'dashboard') { document.querySelector('.nav-item').classList.add('active'); loadDashboard(); }
  if (name === 'considerations') { document.querySelectorAll('.nav-item')[1].classList.add('active'); }
  if (name === 'settings') { document.querySelectorAll('.nav-item')[2].classList.add('active'); }
}

function switchTab(name) {
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.tab-panel').forEach(t => t.classList.remove('active'));
  document.querySelector(`.tab[onclick="switchTab('${name}')"]`)?.classList.add('active');
  document.getElementById(`tab-${name}`)?.classList.add('active');
  if (name === 'itinerary') loadDays();
  if (name === 'accommodation') loadAccom();
  if (name === 'transport') loadTransport();
  if (name === 'budget') loadBudget();
  if (name === 'packing') loadPacking();
}

// ─── Dashboard ───────────────────────────────────────────────────────────
async function loadDashboard() {
  const trips = await dbQuery('trips');
  renderSidebar(trips);
  renderTripsGrid(trips);
}

function renderSidebar(trips) {
  const el = document.getElementById('sidebarTrips');
  if (!trips.length) { el.innerHTML = '<div style="padding:8px 12px;font-size:13px;color:rgba(255,255,255,0.3);font-style:italic;">No trips yet</div>'; return; }
  el.innerHTML = trips.map(t => `
    <div class="trip-chip ${t.id === currentTripId ? 'active' : ''}" onclick="openTrip('${safeJsArg(t.id)}')">
      <span class="dot"></span>${safeText(t.flag || '')} ${safeText(t.name || 'Untitled Trip')}
    </div>`).join('');
}

function renderTripsGrid(trips) {
  const el = document.getElementById('tripsGrid');
  if (!trips.length) {
    el.innerHTML = `<div class="empty-state"><div class="e-icon">✈️</div><h3>No trips yet</h3><p>Create your first trip to start planning your adventure.</p><button class="btn btn-primary" onclick="openNewTripModal()">Create a Trip</button></div>`;
    return;
  }
  el.innerHTML = trips.map(t => {
    const days = t.end_date && t.start_date ? Math.ceil((new Date(t.end_date)-new Date(t.start_date))/(1000*60*60*24))+1 : '?';
    return `<div class="trip-card" onclick="openTrip('${safeJsArg(t.id)}')">
      <div class="trip-card-banner">
        <div class="trip-card-flag">${safeText(t.flag || '🌍')}</div>
        <div class="trip-card-dest">${safeText(t.destination || 'Unknown destination')}</div>
      </div>
      <div class="trip-card-body">
        <div class="trip-card-name">${safeText(t.name || 'Untitled Trip')}</div>
        <div class="trip-card-dates">${formatDate(t.start_date)} → ${formatDate(t.end_date)}</div>
      </div>
      <div class="trip-card-footer">
        <span class="badge badge-forest">${days} days</span>
        <span class="badge badge-gold">${safeText(t.currency || currency)} ${Number(t.budget||0).toLocaleString()}</span>
      </div>
    </div>`;
  }).join('');
}

// ─── Trip Detail ─────────────────────────────────────────────────────────
async function openTrip(tripId) {
  closeSidebarOnMobile();
  currentTripId = tripId;
  expandedDayIds.clear();
  itineraryCategoryFilter = 'all';
  const trips = await dbQuery('trips');
  currentTripData = trips.find(t => t.id === tripId);
  if (!currentTripData) return;

  const days = currentTripData.end_date && currentTripData.start_date
    ? Math.ceil((new Date(currentTripData.end_date)-new Date(currentTripData.start_date))/(1000*60*60*24))+1
    : '?';
  const safeTripId = safeJsArg(tripId);

  document.getElementById('tripHeader').innerHTML = `
    <div>
      <div class="trip-header-eyebrow">${safeText(currentTripData.destination)}</div>
      <div class="trip-header-title">${safeText(currentTripData.flag||'🌍')} ${safeText(currentTripData.name || 'Untitled Trip')}</div>
      <div class="trip-header-meta">${formatDate(currentTripData.start_date)} → ${formatDate(currentTripData.end_date)} · <span>${days} days</span></div>
      ${currentTripData.notes ? `<div class="trip-header-note">${safeText(currentTripData.notes)}</div>` : ''}
    </div>
    <div class="trip-header-actions">
      <div class="header-kebab" id="tripHeaderActionsMenu">
        <button class="header-kebab-btn" type="button" title="Trip actions" aria-label="Trip actions" onclick="toggleHeaderActionsMenu('tripHeaderActionsMenu', event)">⋮</button>
        <div class="header-kebab-menu" role="menu" onclick="event.stopPropagation()">
          <button class="header-kebab-item edit" type="button" onclick="closeAllActionMenus(); openEditTripModal('${safeTripId}')">✏️ Edit Trip</button>
          <button class="header-kebab-item delete" type="button" onclick="closeAllActionMenus(); deleteTrip('${safeTripId}')">🗑️ Delete Trip</button>
        </div>
      </div>
    </div>`;

  document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
  document.getElementById('panel-trip').classList.add('active');
  document.getElementById('topbarTitle').textContent = currentTripData.name;
  document.getElementById('topbarActions').innerHTML = '';

  // Reset tabs
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.tab-panel').forEach(t => t.classList.remove('active'));
  const firstTab = document.querySelector('.tab');
  if (firstTab) firstTab.classList.add('active');
  document.getElementById('tab-itinerary').classList.add('active');

  renderSidebar(trips);
  loadDays();
}

async function deleteTrip(id) {
  if (!confirm('Delete this trip and all its data?')) return;
  const dayRows = await dbQuery('days', { trip_id: id });
  for (const day of dayRows) {
    const dayActivities = await dbQuery('activities', { day_id: day.id });
    for (const activity of dayActivities) await dbDelete('activities', activity.id);
  }
  const activitiesByTrip = await dbQuery('activities', { trip_id: id });
  for (const activity of activitiesByTrip) await dbDelete('activities', activity.id);
  for (const day of dayRows) await dbDelete('days', day.id);

  const dependentTables = ['accommodations', 'transports', 'expenses', 'packing'];
  for (const table of dependentTables) {
    const rows = await dbQuery(table, { trip_id: id });
    for (const row of rows) await dbDelete(table, row.id);
  }
  await dbDelete('trips', id);
  if (currentTripId === id) {
    currentTripId = null;
    currentTripData = null;
  }
  toast('Trip deleted');
  showPanel('dashboard');
}

// ─── Days & Activities ────────────────────────────────────────────────────
function closeAllActionMenus() {
  document.querySelectorAll('.activity-actions.open, .header-kebab.open').forEach(el => el.classList.remove('open'));
}

function closeActivityMenus() {
  closeAllActionMenus();
}

function handleActionMenuDocumentClick(event) {
  if (event.target.closest('.activity-actions, .header-kebab')) return;
  closeAllActionMenus();
}

function toggleHeaderActionsMenu(menuId, event) {
  if (event) {
    event.preventDefault();
    event.stopPropagation();
  }
  const menuWrap = document.getElementById(menuId);
  if (!menuWrap) return;

  const shouldOpen = !menuWrap.classList.contains('open');
  closeAllActionMenus();
  if (!shouldOpen) return;
  menuWrap.classList.add('open');
}

function toggleActivityActionsMenu(activityId, event) {
  if (event) {
    event.preventDefault();
    event.stopPropagation();
  }
  const menuId = makeDomId('activityActions-', activityId);
  const menuWrap = document.getElementById(menuId);
  if (!menuWrap) return;

  const shouldOpen = !menuWrap.classList.contains('open');
  closeAllActionMenus();
  if (!shouldOpen) return;
  menuWrap.classList.add('open');
}

async function loadDays() {
  closeAllActionMenus();
  const requestToken = ++loadDaysToken;
  const [days, tripActivitiesRaw] = await Promise.all([
    dbQuery('days', { trip_id: currentTripId }),
    dbQuery('activities', { trip_id: currentTripId })
  ]);
  if (requestToken !== loadDaysToken) return;

  days.sort((a,b) => (a.day_number||0) - (b.day_number||0));
  const container = document.getElementById('daysContainer');
  updateItineraryFilterUI();

  if (!days.length) {
    container.innerHTML = `<div class="empty-state"><div class="e-icon">📅</div><h3>No days added yet</h3><p>Start building your day-by-day itinerary.</p></div>`;
    return;
  }

  const dayIdSet = new Set(days.map(d => d.id));
  let tripActivities = tripActivitiesRaw.filter(a => dayIdSet.has(a.day_id));
  if (!tripActivities.length && dayIdSet.size) {
    const allActivities = await dbQuery('activities');
    if (requestToken !== loadDaysToken) return;
    tripActivities = allActivities.filter(a => dayIdSet.has(a.day_id));
  }

  const activitiesByDay = new Map();
  for (const activity of tripActivities) {
    if (!activitiesByDay.has(activity.day_id)) activitiesByDay.set(activity.day_id, []);
    activitiesByDay.get(activity.day_id).push(activity);
  }
  for (const list of activitiesByDay.values()) {
    list.sort((a, b) => (a.time || '').localeCompare(b.time || ''));
  }

  let html = '';
  const catIcon = { food:'🍜', attraction:'🏛️', transport:'🚌', hotel:'🏨', other:'📌' };
  for (const day of days) {
    const allActivities = activitiesByDay.get(day.id) || [];
    const activities = itineraryCategoryFilter === 'all'
      ? allActivities
      : allActivities.filter(a => a.category === itineraryCategoryFilter);
    if (itineraryCategoryFilter !== 'all' && activities.length === 0) continue;

    const isCollapsed = !expandedDayIds.has(day.id);
    const dayId = String(day.id || '');
    const dayDomId = makeDomId('dayCard-', dayId);
    const dayActionsMenuId = makeDomId('dayHeadActions-', dayId);
    const dayJsId = safeJsArg(dayId);
    const dayActionsMenuJsId = safeJsArg(dayActionsMenuId);
    const dayNumberLabel = Number(day.day_number) || 0;
    const defaultDayTitle = `Day ${dayNumberLabel}`.trim().toLowerCase();
    const enteredDayTitle = String(day.title || '').trim();
    const showCustomDayTitle = !!enteredDayTitle && enteredDayTitle.toLowerCase() !== defaultDayTitle;
    html += `<div class="day-card ${isCollapsed ? 'collapsed' : ''}" id="${dayDomId}">
      <div class="day-card-head" onclick="toggleDayCollapse('${dayJsId}')">
        <div class="day-head-main">
          <div class="day-toggle">${isCollapsed ? '▸' : '▾'}</div>
          <div>
            <div class="day-label">Day ${dayNumberLabel} · ${formatDate(day.date)}</div>
            ${showCustomDayTitle ? `<div class="day-title">${safeText(enteredDayTitle)}</div>` : ''}
          </div>
        </div>
        <div class="day-head-actions">
          <div class="header-kebab" id="${dayActionsMenuId}">
            <button class="header-kebab-btn" type="button" title="Day actions" aria-label="Day actions" onclick="toggleHeaderActionsMenu('${dayActionsMenuJsId}', event)">⋮</button>
            <div class="header-kebab-menu" role="menu" onclick="event.stopPropagation()">
              <button class="header-kebab-item edit" type="button" onclick="closeAllActionMenus(); openAddActivityModal('${dayJsId}')">➕ Add Activity</button>
              <button class="header-kebab-item delete" type="button" onclick="closeAllActionMenus(); deleteDay('${dayJsId}')">🗑️ Delete Day</button>
            </div>
          </div>
        </div>
      </div>
      <div class="day-card-body">`;

    if (!activities.length) {
      html += `<div style="padding:20px;text-align:center;color:var(--mist);font-size:14px;font-style:italic;">No activities yet · click "+ Activity"</div>`;
    } else {
      for (const a of activities) {
        const cat = normalizeActivityCategory(a.category);
        const activityId = String(a.id || '');
        const activityMenuDomId = makeDomId('activityActions-', activityId);
        const activityJsId = safeJsArg(activityId);
        html += `<div class="activity-row">
          <div class="activity-time">${safeText(a.time || '--:--')}</div>
          <div class="activity-dot cat-${cat}">${catIcon[cat]||'📌'}</div>
          <div class="activity-info">
            <div class="activity-title">${safeText(a.title || 'Untitled Activity')}</div>
            ${a.description ? `<div class="activity-desc">${safeText(a.description)}</div>` : ''}
            <div class="activity-meta">
              ${a.location ? `<span class="activity-location">📍 ${safeText(a.location)}</span>` : ''}
              ${a.cost ? `<span class="activity-cost">${safeText(currentTripData?.currency||currency)} ${Number(a.cost).toLocaleString()}</span>` : ''}
            </div>
          </div>
          <div class="activity-actions" id="${activityMenuDomId}">
            <button class="activity-kebab-btn" type="button" title="Open activity actions" aria-label="Open activity actions" onclick="toggleActivityActionsMenu('${activityJsId}', event)">⋮</button>
            <div class="activity-actions-menu" role="menu" onclick="event.stopPropagation()">
              <button class="activity-actions-item edit" type="button" onclick="closeActivityMenus(); openEditActivityModal('${activityJsId}')">✏️ Edit</button>
              <button class="activity-actions-item delete" type="button" onclick="closeActivityMenus(); deleteActivity('${activityJsId}')">🗑️ Delete</button>
            </div>
          </div>
        </div>`;
      }
    }
    html += `</div></div>`;
  }
  if (!html) {
    container.innerHTML = `<div class="empty-state"><div class="e-icon">🔎</div><h3>No activities in this category</h3><p>Choose another category filter or add an activity.</p></div>`;
    return;
  }
  container.innerHTML = html;
}

function setItineraryFilter(category) {
  itineraryCategoryFilter = category;
  loadDays();
}

function updateItineraryFilterUI() {
  document.querySelectorAll('[data-itinerary-filter]').forEach(btn => {
    const active = btn.getAttribute('data-itinerary-filter') === itineraryCategoryFilter;
    btn.classList.toggle('active', active);
  });
}

function toggleDayCollapse(dayId) {
  const card = document.getElementById(makeDomId('dayCard-', dayId));
  if (!card) return;
  if (expandedDayIds.has(dayId)) {
    expandedDayIds.delete(dayId);
    card.classList.add('collapsed');
  } else {
    expandedDayIds.add(dayId);
    card.classList.remove('collapsed');
  }
  const toggle = card.querySelector('.day-toggle');
  if (toggle) toggle.textContent = expandedDayIds.has(dayId) ? '▾' : '▸';
}

async function deleteDay(id) {
  if (!confirm('Delete this day and all its activities?')) return;
  const activities = await dbQuery('activities', { day_id: id });
  for (const activity of activities) await dbDelete('activities', activity.id);
  await dbDelete('days', id);
  expandedDayIds.delete(id);
  toast('Day removed'); loadDays();
}

async function deleteActivity(id) {
  await dbDelete('activities', id); loadDays();
}

// ─── Accommodation ────────────────────────────────────────────────────────
async function loadAccom() {
  const rows = await dbQuery('accommodations', { trip_id: currentTripId });
  const el = document.getElementById('accomContainer');
  if (!rows.length) { el.innerHTML = `<div class="empty-state"><div class="e-icon">🏨</div><h3>No accommodation added</h3></div>`; return; }
  el.innerHTML = rows.map(r => `
    <div class="info-card">
      <div class="info-card-left">
        <h3>🏨 ${safeText(r.name || 'Untitled')}</h3>
        <p>${safeText(r.address||'')}</p>
        <div class="info-card-meta">
          ${r.check_in?`<span class="meta-pill">Check-in: ${formatDate(r.check_in)}</span>`:''}
          ${r.check_out?`<span class="meta-pill">Check-out: ${formatDate(r.check_out)}</span>`:''}
          ${r.confirmation?`<span class="meta-pill">Conf: ${safeText(r.confirmation)}</span>`:''}
          ${r.cost?`<span class="meta-pill" style="color:var(--terracotta);">${safeText(currentTripData?.currency||currency)} ${Number(r.cost).toLocaleString()}</span>`:''}
        </div>
        ${r.notes?`<p style="margin-top:8px;font-size:13px;color:var(--mist);">${safeText(r.notes)}</p>`:''}
      </div>
      <button class="btn btn-danger btn-sm" onclick="deleteAccom('${safeJsArg(r.id)}')">Remove</button>
    </div>`).join('');
}

async function deleteAccom(id) { await dbDelete('accommodations',id); loadAccom(); }

// ─── Transport ────────────────────────────────────────────────────────────
async function loadTransport() {
  const rows = await dbQuery('transports', { trip_id: currentTripId });
  const el = document.getElementById('transportContainer');
  if (!rows.length) { el.innerHTML = `<div class="empty-state"><div class="e-icon">🚌</div><h3>No transport added</h3></div>`; return; }
  el.innerHTML = rows.map(r => `
    <div class="info-card">
      <div class="info-card-left">
        <h3>${safeText(r.type || 'Transport')}</h3>
        <p>${safeText(r.from_location || '')} → ${safeText(r.to_location || '')}</p>
        <div class="info-card-meta">
          ${r.departure?`<span class="meta-pill">Dep: ${safeText(r.departure.replace('T',' '))}</span>`:''}
          ${r.arrival?`<span class="meta-pill">Arr: ${safeText(r.arrival.replace('T',' '))}</span>`:''}
          ${r.operator?`<span class="meta-pill">${safeText(r.operator)}</span>`:''}
          ${r.confirmation?`<span class="meta-pill">Conf: ${safeText(r.confirmation)}</span>`:''}
          ${r.cost?`<span class="meta-pill" style="color:var(--terracotta);">${safeText(currentTripData?.currency||currency)} ${Number(r.cost).toLocaleString()}</span>`:''}
        </div>
        ${r.notes?`<p style="margin-top:8px;font-size:13px;color:var(--mist);">${safeText(r.notes)}</p>`:''}
      </div>
      <button class="btn btn-danger btn-sm" onclick="deleteTransport('${safeJsArg(r.id)}')">Remove</button>
    </div>`).join('');
}
async function deleteTransport(id) { await dbDelete('transports',id); loadTransport(); }

// ─── Budget ───────────────────────────────────────────────────────────────
async function loadBudget() {
  const expenses = await dbQuery('expenses', { trip_id: currentTripId });
  const budget = Number(currentTripData?.budget || 0);
  const spent = expenses.reduce((s,e) => s + Number(e.amount||0), 0);
  const pct = budget ? Math.min(100, Math.round(spent/budget*100)) : 0;
  const cur = currentTripData?.currency || currency;

  document.getElementById('budgetOverview').innerHTML = `
    <div class="budget-box">
      <div class="b-label">Total Budget</div>
      <div class="b-val">${safeText(cur)} ${budget.toLocaleString()}</div>
    </div>
    <div class="budget-box">
      <div class="b-label">Total Spent</div>
      <div class="b-val ${spent > budget ? 'over' : ''}">${safeText(cur)} ${spent.toLocaleString()}</div>
      <div class="progress-bar"><div class="progress-fill ${pct > 90 ? 'warn' : ''}" style="width:${pct}%"></div></div>
      <div style="font-size:12px;color:var(--mist);margin-top:6px;font-family:'DM Sans',sans-serif;">${pct}% used · ${safeText(cur)} ${Math.max(0,budget-spent).toLocaleString()} remaining</div>
    </div>`;

  const tbody = document.getElementById('expenseBody');
  if (!expenses.length) { tbody.innerHTML = `<tr><td colspan="5" style="text-align:center;padding:32px;color:var(--mist);font-style:italic;">No expenses recorded yet</td></tr>`; return; }
  tbody.innerHTML = expenses.map(e => `
    <tr>
      <td data-label="Item">${safeText(e.item || '')}</td>
      <td data-label="Category">${safeText(e.category || '')}</td>
      <td data-label="Date">${formatDate(e.date)}</td>
      <td data-label="Amount" style="color:var(--terracotta);font-family:'DM Sans',sans-serif;">${safeText(cur)} ${Number(e.amount||0).toLocaleString()}</td>
      <td data-label="Action"><button class="btn btn-danger btn-sm" onclick="deleteExpense('${safeJsArg(e.id)}')">✕</button></td>
    </tr>`).join('');
}
async function deleteExpense(id) { await dbDelete('expenses',id); loadBudget(); }

// ─── Packing ──────────────────────────────────────────────────────────────
const packCategories = ['📄 Documents','👕 Clothing','🔌 Electronics','💊 Health','🧴 Toiletries','📌 Other'];
const defaultItems = {
  '📄 Documents': ['Passport','Visa/Entry docs','Travel insurance','Hotel confirmation','Flight tickets','Emergency contacts'],
  '👕 Clothing': ['T-shirts','Pants/Shorts','Underwear','Socks','Walking shoes','Light jacket','Swimwear'],
  '🔌 Electronics': ['Phone charger','Power adapter','Portable charger','Camera','Headphones'],
  '💊 Health': ['Prescription meds','Paracetamol','Sunscreen','Insect repellent','Hand sanitizer','First aid kit'],
  '🧴 Toiletries': ['Toothbrush & paste','Shampoo','Deodorant','Razor','Moisturiser'],
  '📌 Other': ['Reusable water bottle','Snacks','Umbrella','Books/Kindle','Travel pillow']
};

async function loadPacking() {
  let items = await dbQuery('packing', { trip_id: currentTripId });
  // Seed defaults if empty
  if (!items.length) {
    for (const [cat, list] of Object.entries(defaultItems)) {
      for (const item of list) {
        const row = await dbInsert('packing', { trip_id: currentTripId, item, category: cat, packed: false });
        if (row) items.push(row);
      }
    }
  }

  const grouped = {};
  for (const cat of packCategories) grouped[cat] = [];
  for (const i of items) { if (!grouped[i.category]) grouped[i.category] = []; grouped[i.category].push(i); }

  const el = document.getElementById('packingGrid');
  el.innerHTML = packCategories.map(cat => {
    const its = grouped[cat] || [];
    const done = its.filter(i=>i.packed).length;
    return `<div class="checklist-card">
      <h3>${safeText(cat)} <small style="font-size:12px;color:var(--mist);font-family:'DM Sans',sans-serif;">${done}/${its.length}</small></h3>
      ${its.map(i => `
        <div class="check-item ${i.packed?'checked':''}" onclick="togglePack('${safeJsArg(i.id)}',${!i.packed})">
          <input type="checkbox" ${i.packed?'checked':''} onchange="togglePack('${safeJsArg(i.id)}',this.checked)" onclick="event.stopPropagation()" />
          ${safeText(i.item)}
        </div>`).join('')}
    </div>`;
  }).join('');
}

async function togglePack(id, packed) {
  await dbUpdate('packing', id, { packed });
  loadPacking();
}

// ─── Modals ───────────────────────────────────────────────────────────────
function openModal(id) { document.getElementById(id).classList.add('open'); }
function closeModal(id) { document.getElementById(id).classList.remove('open'); }
document.querySelectorAll('.modal-overlay').forEach(m => m.addEventListener('click', e => { if (e.target === m) m.classList.remove('open'); }));

function closeTripModal() {
  closeModal('modalNewTrip');
  document.getElementById('fTripId').value = '';
}

function openNewTripModal() {
  document.getElementById('fTripId').value = '';
  document.getElementById('fTripName').value = '';
  document.getElementById('fTripDest').value = '';
  document.getElementById('fTripFlag').value = '';
  document.getElementById('fTripStart').value = '';
  document.getElementById('fTripEnd').value = '';
  document.getElementById('fTripBudget').value = '';
  document.getElementById('fTripCurrency').value = currency || 'MYR';
  document.getElementById('fTripNotes').value = '';
  document.getElementById('tripModalTitle').textContent = 'New Trip ✈️';
  document.getElementById('tripModalSaveBtn').textContent = 'Create Trip';
  openModal('modalNewTrip');
}

async function openEditTripModal(tripId) {
  const trip = await dbGetById('trips', tripId);
  if (!trip) return;
  document.getElementById('fTripId').value = trip.id;
  document.getElementById('fTripName').value = trip.name || '';
  document.getElementById('fTripDest').value = trip.destination || '';
  document.getElementById('fTripFlag').value = trip.flag || '';
  document.getElementById('fTripStart').value = trip.start_date || '';
  document.getElementById('fTripEnd').value = trip.end_date || '';
  document.getElementById('fTripBudget').value = trip.budget || '';
  document.getElementById('fTripCurrency').value = trip.currency || currency || 'MYR';
  document.getElementById('fTripNotes').value = trip.notes || '';
  document.getElementById('tripModalTitle').textContent = 'Edit Trip';
  document.getElementById('tripModalSaveBtn').textContent = 'Save Changes';
  openModal('modalNewTrip');
}

function appendDestinationSeparator() {
  const input = document.getElementById('fTripDest');
  if (!input) return;
  const current = input.value.trim();
  if (!current) {
    input.focus();
    return;
  }
  input.value = current.endsWith('+') || current.endsWith(' +') ? current : `${current} + `;
  input.focus();
}

async function syncTripDaysToRange(tripId, startDate, endDate) {
  if (!startDate || !endDate) return { added: 0 };
  const start = new Date(`${startDate}T00:00:00Z`);
  const end = new Date(`${endDate}T00:00:00Z`);
  if (Number.isNaN(start.getTime()) || Number.isNaN(end.getTime()) || end < start) return { added: 0 };

  const existingDays = await dbQuery('days', { trip_id: tripId });
  const existingByDate = new Map();
  const existingByNumber = new Map();
  for (const day of existingDays) {
    if (day.date && !existingByDate.has(day.date)) existingByDate.set(day.date, day);
    if (day.day_number && !existingByNumber.has(day.day_number)) existingByNumber.set(day.day_number, day);
  }
  const usedDayIds = new Set();

  const dayMs = 24 * 60 * 60 * 1000;
  const count = Math.floor((end.getTime() - start.getTime()) / dayMs) + 1;
  let added = 0;

  for (let i = 0; i < count; i++) {
    const date = new Date(start.getTime() + (i * dayMs)).toISOString().slice(0, 10);
    const dayNumber = i + 1;
    const byDate = existingByDate.get(date);
    const byNumber = existingByNumber.get(dayNumber);
    const existing = (byDate && !usedDayIds.has(byDate.id))
      ? byDate
      : ((byNumber && !usedDayIds.has(byNumber.id)) ? byNumber : null);
    if (existing) {
      usedDayIds.add(existing.id);
      if ((existing.day_number || 0) !== dayNumber || existing.date !== date) {
        await dbUpdate('days', existing.id, { day_number: dayNumber, date });
      }
    } else {
      await dbInsert('days', {
        trip_id: tripId,
        day_number: dayNumber,
        date,
        title: `Day ${dayNumber}`,
        notes: ''
      });
      added++;
    }
  }

  return { added };
}

async function saveTrip() {
  const tripId = document.getElementById('fTripId').value;
  const name = document.getElementById('fTripName').value.trim();
  if (!name) { toast('Please enter a trip name', 'error'); return; }
  const obj = {
    name, destination: document.getElementById('fTripDest').value,
    flag: document.getElementById('fTripFlag').value,
    start_date: document.getElementById('fTripStart').value,
    end_date: document.getElementById('fTripEnd').value,
    budget: document.getElementById('fTripBudget').value || 0,
    currency: document.getElementById('fTripCurrency').value,
    notes: document.getElementById('fTripNotes').value
  };

  if (obj.start_date && obj.end_date && obj.end_date < obj.start_date) {
    toast('End date cannot be before start date', 'error');
    return;
  }

  if (tripId) {
    const ok = await dbUpdate('trips', tripId, obj);
    if (!ok) return;
    const { added } = await syncTripDaysToRange(tripId, obj.start_date, obj.end_date);
    closeTripModal();
    toast(added ? `Trip updated! ${added} day(s) added.` : 'Trip updated!');
    loadDashboard();
    openTrip(tripId);
    return;
  }

  const row = await dbInsert('trips', obj);
  if (!row) return;
  const { added } = await syncTripDaysToRange(row.id, obj.start_date, obj.end_date);
  closeTripModal();
  toast(added ? `Trip created! ${added} day(s) added.` : 'Trip created! ✈️');
  loadDashboard();
  openTrip(row.id);
}

function openAddDayModal() { openModal('modalAddDay'); }

async function saveDay() {
  const title = document.getElementById('fDayTitle').value.trim();
  if (!title) { toast('Please enter a day title', 'error'); return; }
  const obj = {
    trip_id: currentTripId,
    day_number: parseInt(document.getElementById('fDayNum').value) || 1,
    date: document.getElementById('fDayDate').value,
    title, notes: document.getElementById('fDayNotes').value
  };
  await dbInsert('days', obj);
  closeModal('modalAddDay');
  toast('Day added!');
  ['fDayTitle','fDayNotes','fDayDate'].forEach(id => document.getElementById(id).value = '');
  loadDays();
}

function setActivityFxNote(message, isError = false) {
  const note = document.getElementById('activityFxNote');
  if (!note) return;
  note.textContent = message;
  note.style.color = isError ? 'var(--terracotta)' : 'var(--mist)';
}

function setActivityCostHint(targetCurrency) {
  const hint = document.getElementById('activityCostHint');
  if (!hint) return;
  hint.textContent = `Saved in ${targetCurrency}. Converter works both ways: edit Amount A or Amount B, then tap Convert.`;
}

function getActivityTargetCurrency() {
  return currentTripData?.currency || currency || 'MYR';
}

function setActivityFxDirection(direction) {
  activityFxDirection = direction === 'to' ? 'to' : 'from';
  const btn = document.getElementById('activityFxButton');
  if (btn) btn.textContent = activityFxDirection === 'to' ? 'Convert B -> A' : 'Convert A -> B';
}

function syncActivitySavedCostFromConverter() {
  const tripCurrency = getActivityTargetCurrency();
  const fromCurrency = document.getElementById('fActFromCur').value;
  const toCurrency = document.getElementById('fActToCur').value;
  const fromAmount = Number(document.getElementById('fActFromAmt').value || 0);
  const toAmount = Number(document.getElementById('fActToAmt').value || 0);
  const costInput = document.getElementById('fActCost');
  if (!costInput) return;

  if (fromCurrency === tripCurrency && fromAmount > 0) {
    costInput.value = fromAmount.toFixed(2);
    return;
  }
  if (toCurrency === tripCurrency && toAmount > 0) {
    costInput.value = toAmount.toFixed(2);
  }
}

function populateActivityCurrencySelects(targetCurrency) {
  const fromSelect = document.getElementById('fActFromCur');
  const toSelect = document.getElementById('fActToCur');
  if (!fromSelect || !toSelect) return;
  const options = FX_CURRENCIES.map(c => `<option value="${c}">${c}</option>`).join('');
  fromSelect.innerHTML = options;
  toSelect.innerHTML = options;

  const fallback = FX_CURRENCIES.includes(targetCurrency) ? targetCurrency : 'MYR';
  fromSelect.value = fallback;
  toSelect.value = fallback === 'USD' ? 'MYR' : 'USD';
  if (toSelect.value === fallback) toSelect.value = 'EUR';
  setActivityFxDirection('from');
}

async function convertActivityCost(forcedDirection = null) {
  const direction = forcedDirection || activityFxDirection || 'from';
  const fromCurrency = document.getElementById('fActFromCur').value;
  const toCurrency = document.getElementById('fActToCur').value;
  const fromInput = document.getElementById('fActFromAmt');
  const toInput = document.getElementById('fActToAmt');

  const sourceCurrency = direction === 'to' ? toCurrency : fromCurrency;
  const targetCurrency = direction === 'to' ? fromCurrency : toCurrency;
  const sourceAmount = Number(direction === 'to' ? toInput.value : fromInput.value);

  if (!sourceAmount || sourceAmount <= 0) {
    setActivityFxNote(`Enter Amount ${direction === 'to' ? 'B' : 'A'} first.`, true);
    return;
  }

  try {
    const result = await fetchConvertedAmount(sourceAmount, sourceCurrency, targetCurrency);
    const converted = result.converted.toFixed(2);
    if (direction === 'to') fromInput.value = converted;
    else toInput.value = converted;
    setActivityFxNote(formatFxNote(sourceCurrency, targetCurrency, result));
    syncActivitySavedCostFromConverter();
  } catch (error) {
    setActivityFxNote(error.message, true);
  }
}

function openAddActivityModal(dayId) {
  const targetCurrency = currentTripData?.currency || currency || 'MYR';
  populateActivityCurrencySelects(targetCurrency);
  setActivityCostHint(targetCurrency);
  document.getElementById('fActId').value = '';
  document.getElementById('fActDayId').value = dayId;
  document.getElementById('fActTime').value = '';
  document.getElementById('fActCat').value = 'attraction';
  document.getElementById('fActTitle').value = '';
  document.getElementById('fActDesc').value = '';
  document.getElementById('fActLoc').value = '';
  document.getElementById('fActFromAmt').value = '';
  document.getElementById('fActToAmt').value = '';
  document.getElementById('fActCost').value = '';
  setActivityFxNote('');
  document.getElementById('activityFxPanel').open = false;
  document.getElementById('activityModalTitle').textContent = 'Add Activity';
  document.getElementById('activityModalSaveBtn').textContent = 'Add Activity';
  openModal('modalAddActivity');
}

async function openEditActivityModal(id) {
  const activity = await dbGetById('activities', id);
  if (!activity) return;
  const targetCurrency = currentTripData?.currency || currency || 'MYR';
  populateActivityCurrencySelects(targetCurrency);
  setActivityCostHint(targetCurrency);
  document.getElementById('fActId').value = activity.id;
  document.getElementById('fActDayId').value = activity.day_id;
  document.getElementById('fActTime').value = activity.time || '';
  document.getElementById('fActCat').value = activity.category || 'attraction';
  document.getElementById('fActTitle').value = activity.title || '';
  document.getElementById('fActDesc').value = activity.description || '';
  document.getElementById('fActLoc').value = activity.location || '';
  document.getElementById('fActFromCur').value = targetCurrency;
  document.getElementById('fActFromAmt').value = activity.cost || '';
  document.getElementById('fActToAmt').value = '';
  document.getElementById('fActCost').value = activity.cost || '';
  setActivityFxDirection('from');
  setActivityFxNote('');
  document.getElementById('activityFxPanel').open = false;
  document.getElementById('activityModalTitle').textContent = 'Edit Activity';
  document.getElementById('activityModalSaveBtn').textContent = 'Save Changes';
  openModal('modalAddActivity');
}

function closeActivityModal() {
  closeModal('modalAddActivity');
  document.getElementById('fActId').value = '';
  setActivityFxNote('');
}

async function saveActivity() {
  const activityId = document.getElementById('fActId').value;
  const title = document.getElementById('fActTitle').value.trim();
  if (!title) { setActivityFxNote('Activity name is required.', true); return; }
  const tripCurrency = getActivityTargetCurrency();
  const fromCurrency = document.getElementById('fActFromCur').value;
  const toCurrency = document.getElementById('fActToCur').value;
  const fromAmount = Number(document.getElementById('fActFromAmt').value || 0);
  const toAmount = Number(document.getElementById('fActToAmt').value || 0);
  let cost = Number(document.getElementById('fActCost').value || 0);

  if (!cost) {
    if (fromCurrency === tripCurrency && fromAmount > 0) cost = fromAmount;
    else if (toCurrency === tripCurrency && toAmount > 0) cost = toAmount;
    else if (fromAmount > 0) {
      try {
        const result = await fetchConvertedAmount(fromAmount, fromCurrency, tripCurrency);
        cost = Number(result.converted.toFixed(2));
        const source = result.cached ? `${result.date || 'cached'} · cached` : result.date;
        setActivityFxNote(`Saved in ${tripCurrency} using ${fromCurrency} rate (${source})`);
      } catch (error) {
        setActivityFxNote(error.message, true);
      }
    } else if (toAmount > 0) {
      try {
        const result = await fetchConvertedAmount(toAmount, toCurrency, tripCurrency);
        cost = Number(result.converted.toFixed(2));
        const source = result.cached ? `${result.date || 'cached'} · cached` : result.date;
        setActivityFxNote(`Saved in ${tripCurrency} using ${toCurrency} rate (${source})`);
      } catch (error) {
        setActivityFxNote(error.message, true);
      }
    }
  }
  const normalizedCost = Number.isFinite(cost) && cost > 0 ? cost : 0;

  const obj = {
    trip_id: currentTripId,
    day_id: document.getElementById('fActDayId').value,
    time: document.getElementById('fActTime').value,
    category: document.getElementById('fActCat').value,
    title, description: document.getElementById('fActDesc').value,
    location: document.getElementById('fActLoc').value,
    cost: normalizedCost
  };
  if (activityId) {
    await dbUpdate('activities', activityId, obj);
  } else {
    await dbInsert('activities', obj);
  }
  closeActivityModal();
  ['fActTime','fActTitle','fActDesc','fActLoc','fActFromAmt','fActToAmt','fActCost'].forEach(id => document.getElementById(id).value = '');
  loadDays();
}

function openAddAccomModal() { openModal('modalAddAccom'); }
async function saveAccom() {
  const name = document.getElementById('fAccomName').value.trim();
  if (!name) { toast('Please enter a property name', 'error'); return; }
  await dbInsert('accommodations', { trip_id: currentTripId, name, address: document.getElementById('fAccomAddr').value, check_in: document.getElementById('fAccomIn').value, check_out: document.getElementById('fAccomOut').value, confirmation: document.getElementById('fAccomConf').value, cost: document.getElementById('fAccomCost').value||0, notes: document.getElementById('fAccomNotes').value });
  closeModal('modalAddAccom'); toast('Accommodation saved!'); loadAccom();
}

function openAddTransportModal() { openModal('modalAddTransport'); }
async function saveTransport() {
  await dbInsert('transports', { trip_id: currentTripId, type: document.getElementById('fTransType').value, from_location: document.getElementById('fTransFrom').value, to_location: document.getElementById('fTransTo').value, departure: document.getElementById('fTransDep').value, arrival: document.getElementById('fTransArr').value, operator: document.getElementById('fTransOp').value, confirmation: document.getElementById('fTransConf').value, cost: document.getElementById('fTransCost').value||0, notes: document.getElementById('fTransNotes').value });
  closeModal('modalAddTransport'); toast('Transport saved!'); loadTransport();
}

function setExpenseFxNote(message, isError = false) {
  const note = document.getElementById('expenseFxNote');
  if (!note) return;
  note.textContent = message;
  note.style.color = isError ? 'var(--terracotta)' : 'var(--mist)';
}

function populateExpenseCurrencySelects(targetCurrency) {
  const fromSelect = document.getElementById('fExpFromCur');
  const toSelect = document.getElementById('fExpToCur');
  if (!fromSelect || !toSelect) return;
  const options = FX_CURRENCIES.map(c => `<option value="${c}">${c}</option>`).join('');
  fromSelect.innerHTML = options;
  toSelect.innerHTML = options;

  const fallback = FX_CURRENCIES.includes(targetCurrency) ? targetCurrency : 'MYR';
  fromSelect.value = fallback;
  toSelect.value = fallback;
}

async function fetchConvertedAmount(amount, fromCurrency, toCurrency) {
  if (!Number.isFinite(amount) || amount <= 0) throw new Error('Amount must be greater than 0');
  if (!fromCurrency || !toCurrency) throw new Error('Please choose both currencies');
  if (fromCurrency === toCurrency) {
    return { converted: amount, rate: 1, date: new Date().toISOString().slice(0, 10), cached: false };
  }

  try {
    const endpoint = `${FX_API_BASE}/latest?base=${encodeURIComponent(fromCurrency)}&symbols=${encodeURIComponent(toCurrency)}`;
    const response = await fetch(endpoint);
    if (!response.ok) throw new Error('Unable to fetch live exchange rate');
    const data = await response.json();
    const rate = Number(data?.rates?.[toCurrency]);
    if (!Number.isFinite(rate)) throw new Error('Exchange rate unavailable for selected currency pair');
    saveFxRate(fromCurrency, toCurrency, rate, data.date || '');
    return { converted: amount * rate, rate, date: data.date || '', cached: false };
  } catch (error) {
    const cached = loadFxRate(fromCurrency, toCurrency);
    if (cached) {
      return { converted: amount * cached.rate, rate: cached.rate, date: cached.date || '', cached: true };
    }
    if (!isOnline()) throw new Error('Offline: this currency pair has no cached rate yet');
    throw error;
  }
}

async function convertExpenseAmount() {
  const fromCurrency = document.getElementById('fExpFromCur').value;
  const toCurrency = document.getElementById('fExpToCur').value;
  const sourceAmount = Number(document.getElementById('fExpFromAmt').value);
  if (!sourceAmount || sourceAmount <= 0) {
    setExpenseFxNote('Enter source amount first.', true);
    toast('Enter source amount first', 'error');
    return;
  }

  try {
    const result = await fetchConvertedAmount(sourceAmount, fromCurrency, toCurrency);
    document.getElementById('fExpAmt').value = result.converted.toFixed(2);
    setExpenseFxNote(formatFxNote(fromCurrency, toCurrency, result));
  } catch (error) {
    setExpenseFxNote(error.message, true);
    toast(error.message, 'error');
  }
}

function openAddExpenseModal() {
  const targetCurrency = currentTripData?.currency || currency || 'MYR';
  populateExpenseCurrencySelects(targetCurrency);
  document.getElementById('fExpItem').value = '';
  document.getElementById('fExpDate').value = new Date().toISOString().slice(0, 10);
  document.getElementById('fExpFromAmt').value = '';
  document.getElementById('fExpAmt').value = '';
  document.getElementById('fExpNotes').value = '';
  setExpenseFxNote(`Convert any currency into ${targetCurrency} before saving.`);
  openModal('modalAddExpense');
}

async function saveExpense() {
  const item = document.getElementById('fExpItem').value.trim();
  if (!item) { toast('Please enter an item name', 'error'); return; }
  const fromCurrency = document.getElementById('fExpFromCur').value;
  const toCurrency = document.getElementById('fExpToCur').value;
  const sourceAmount = Number(document.getElementById('fExpFromAmt').value || 0);
  let amount = Number(document.getElementById('fExpAmt').value || 0);

  if (!amount && sourceAmount > 0) {
    try {
      const result = await fetchConvertedAmount(sourceAmount, fromCurrency, toCurrency);
      amount = Number(result.converted.toFixed(2));
      document.getElementById('fExpAmt').value = amount;
      setExpenseFxNote(formatFxNote(fromCurrency, toCurrency, result));
    } catch (error) {
      setExpenseFxNote(error.message, true);
      toast(error.message, 'error');
      return;
    }
  }

  if (!amount || amount <= 0) {
    toast('Please enter or convert an amount first', 'error');
    return;
  }

  await dbInsert('expenses', {
    trip_id: currentTripId,
    item,
    category: document.getElementById('fExpCat').value,
    date: document.getElementById('fExpDate').value,
    amount,
    notes: document.getElementById('fExpNotes').value
  });
  closeModal('modalAddExpense'); toast('Expense recorded!');
  ['fExpItem','fExpDate','fExpFromAmt','fExpAmt','fExpNotes'].forEach(id => document.getElementById(id).value='');
  setExpenseFxNote('');
  loadBudget();
}

function openAddPackingModal() { openModal('modalAddPacking'); }
async function savePacking() {
  const item = document.getElementById('fPackItem').value.trim();
  if (!item) { toast('Item name required', 'error'); return; }
  await dbInsert('packing', { trip_id: currentTripId, item, category: document.getElementById('fPackCat').value, packed: false });
  closeModal('modalAddPacking'); toast('Item added!');
  document.getElementById('fPackItem').value = '';
  loadPacking();
}

// ─── Utilities ────────────────────────────────────────────────────────────
function formatDate(d) {
  if (!d) return '—';
  const dt = new Date(d + 'T00:00:00');
  return dt.toLocaleDateString('en-GB', { day:'numeric', month:'short', year:'numeric' });
}

function toast(msg, type = 'success') {
  const el = document.createElement('div');
  el.className = `toast ${type}`;
  el.textContent = msg;
  document.getElementById('toastContainer').appendChild(el);
  setTimeout(() => el.remove(), 3000);
}

// ─── Boot ─────────────────────────────────────────────────────────────────
initApp();
</script>
</body>
</html>
