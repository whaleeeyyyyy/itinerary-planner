<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Voyageur ‚Äî Travel Itinerary Planner</title>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,600;0,700;1,400;1,600&family=Crimson+Pro:ital,wght@0,300;0,400;0,600;1,300;1,400&family=DM+Mono:wght@300;400&display=swap" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root {
      --forest: #1a3a2a;
      --forest-mid: #2d5a3d;
      --forest-light: #3d7a52;
      --cream: #f5f0e8;
      --parchment: #ede5d4;
      --terracotta: #c0613a;
      --terra-light: #e07a52;
      --gold: #c9a84c;
      --ink: #1c1a16;
      --ink-mid: #3a3630;
      --mist: #8a9990;
      --white: #fdfaf5;
      --shadow: rgba(26, 58, 42, 0.12);
      --shadow-strong: rgba(26, 58, 42, 0.22);
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    html, body {
      width: 100%;
      max-width: 100%;
      overflow-x: hidden;
    }

    body {
      font-family: 'Crimson Pro', Georgia, serif;
      background: var(--cream);
      color: var(--ink);
      min-height: 100vh;
      font-size: 17px;
      line-height: 1.6;
      overflow-x: hidden;
      -webkit-text-size-adjust: 100%;
    }

    /* ‚îÄ‚îÄ‚îÄ Layout ‚îÄ‚îÄ‚îÄ */
    .app { display: flex; min-height: 100vh; }
    .app.sidebar-collapsed .sidebar {
      width: 0;
      transform: translateX(-100%);
      opacity: 0;
      pointer-events: none;
    }
    .app.sidebar-collapsed .main { margin-left: 0; }

    /* ‚îÄ‚îÄ‚îÄ Sidebar ‚îÄ‚îÄ‚îÄ */
    .sidebar {
      width: 260px;
      min-height: 100vh;
      background: var(--forest);
      display: flex;
      flex-direction: column;
      position: fixed;
      left: 0; top: 0; bottom: 0;
      z-index: 100;
      overflow-y: auto;
      overflow-x: hidden;
      transition: width 0.22s ease, transform 0.22s ease, opacity 0.18s ease;
    }
    .sidebar-backdrop {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(26,58,42,0.25);
      z-index: 90;
    }

    .sidebar-logo {
      padding: 32px 24px 20px;
      border-bottom: 1px solid rgba(255,255,255,0.08);
    }
    .sidebar-logo .wordmark {
      font-family: 'Playfair Display', serif;
      font-size: 22px;
      font-weight: 700;
      color: var(--gold);
      letter-spacing: 0.04em;
      white-space: nowrap;
    }
    .sidebar-logo .tagline {
      font-size: 11px;
      color: rgba(255,255,255,0.35);
      letter-spacing: 0.14em;
      text-transform: uppercase;
      margin-top: 2px;
      font-family: 'DM Mono', monospace;
    }

    .sidebar-section {
      padding: 20px 16px 8px;
      font-size: 10px;
      letter-spacing: 0.18em;
      text-transform: uppercase;
      color: rgba(255,255,255,0.28);
      font-family: 'DM Mono', monospace;
    }

    .sidebar-nav { padding: 0 12px; flex: 1; }
    .nav-item {
      display: flex; align-items: center; gap: 10px;
      padding: 10px 12px;
      border-radius: 8px;
      cursor: pointer;
      color: rgba(255,255,255,0.62);
      font-size: 15px;
      transition: all 0.2s;
      margin-bottom: 2px;
    }
    .nav-item:hover { background: rgba(255,255,255,0.07); color: rgba(255,255,255,0.9); }
    .nav-item.active { background: var(--terracotta); color: #fff; }
    .nav-item .icon { font-size: 16px; width: 20px; text-align: center; }

    .sidebar-trips { padding: 0 12px; margin-top: 8px; }
    .trip-chip {
      padding: 9px 12px;
      border-radius: 8px;
      cursor: pointer;
      color: rgba(255,255,255,0.55);
      font-size: 13.5px;
      transition: all 0.2s;
      margin-bottom: 2px;
      white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
      display: flex; align-items: center; gap: 8px;
    }
    .trip-chip:hover { background: rgba(255,255,255,0.07); color: rgba(255,255,255,0.85); }
    .trip-chip.active { background: rgba(201,168,76,0.2); color: var(--gold); }
    .trip-chip .dot { width: 6px; height: 6px; border-radius: 50%; background: var(--gold); opacity: 0.5; flex-shrink: 0; }
    .trip-chip.active .dot { opacity: 1; }

    .btn-new-trip {
      margin: 12px;
      padding: 10px 16px;
      background: rgba(255,255,255,0.07);
      border: 1px dashed rgba(255,255,255,0.2);
      border-radius: 8px;
      color: rgba(255,255,255,0.5);
      font-size: 13px;
      cursor: pointer;
      text-align: center;
      transition: all 0.2s;
      font-family: 'DM Mono', monospace;
      letter-spacing: 0.04em;
    }
    .btn-new-trip:hover { border-color: var(--gold); color: var(--gold); background: rgba(201,168,76,0.07); }

    /* ‚îÄ‚îÄ‚îÄ Main ‚îÄ‚îÄ‚îÄ */
    .main {
      margin-left: 260px;
      flex: 1;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      transition: margin-left 0.22s ease;
    }

    .topbar {
      background: var(--white);
      border-bottom: 1px solid var(--parchment);
      padding: 0 40px;
      height: 60px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      position: sticky;
      top: 0;
      z-index: 50;
    }

    .topbar-title {
      font-family: 'Playfair Display', serif;
      font-size: 18px;
      color: var(--ink);
      font-weight: 600;
      min-width: 0;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .topbar-left { display: flex; align-items: center; gap: 10px; min-width: 0; }
    .sidebar-toggle {
      width: 34px;
      height: 34px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      border-radius: 8px;
      border: 1px solid #d8cfbe;
      background: transparent;
      color: var(--ink-mid);
      cursor: pointer;
      font-size: 18px;
      line-height: 1;
      transition: all 0.18s;
      flex-shrink: 0;
    }
    .sidebar-toggle:hover { background: var(--parchment); }

    .topbar-right { display: flex; gap: 10px; align-items: center; min-width: 0; }
    .topbar-actions { display: flex; gap: 10px; align-items: center; }
    .sync-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-family: 'DM Mono', monospace;
      font-size: 11px;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      border: 1px solid var(--parchment);
      border-radius: 999px;
      padding: 4px 10px;
      color: var(--mist);
      background: rgba(255,255,255,0.6);
      white-space: nowrap;
      max-width: 220px;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .sync-badge.online {
      color: var(--forest);
      border-color: rgba(26,58,42,0.2);
      background: rgba(26,58,42,0.06);
    }
    .sync-badge.offline {
      color: var(--terracotta);
      border-color: rgba(192,97,58,0.35);
      background: rgba(192,97,58,0.08);
    }
    .sync-badge.syncing {
      color: #a07820;
      border-color: rgba(201,168,76,0.45);
      background: rgba(201,168,76,0.14);
    }

    .btn {
      display: inline-flex; align-items: center; gap: 6px;
      padding: 8px 18px;
      border-radius: 6px;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.18s;
      font-family: 'Crimson Pro', serif;
      border: none;
    }
    .btn-primary { background: var(--terracotta); color: #fff; }
    .btn-primary:hover { background: var(--terra-light); }
    .btn-secondary { background: var(--parchment); color: var(--ink-mid); border: 1px solid #d8cfbe; }
    .btn-secondary:hover { background: #e0d8c8; }
    .btn-ghost { background: transparent; color: var(--ink-mid); border: 1px solid #d8cfbe; }
    .btn-ghost:hover { background: var(--parchment); }
    .btn-danger { background: #fee; color: #c0392b; border: 1px solid #f5c6cb; }
    .btn-danger:hover { background: #fdd; }
    .btn-sm { padding: 5px 12px; font-size: 13px; }
    .btn-icon { padding: 8px; border-radius: 6px; background: transparent; border: 1px solid #d8cfbe; color: var(--ink-mid); cursor: pointer; font-size: 16px; transition: all 0.18s; }
    .btn-icon:hover { background: var(--parchment); }

    /* ‚îÄ‚îÄ‚îÄ Content area ‚îÄ‚îÄ‚îÄ */
    .content { padding: 36px 40px; flex: 1; }

    /* ‚îÄ‚îÄ‚îÄ Panels ‚îÄ‚îÄ‚îÄ */
    .panel { display: none; }
    .panel.active { display: block; }

    /* ‚îÄ‚îÄ‚îÄ Dashboard ‚îÄ‚îÄ‚îÄ */
    .hero-banner {
      background: var(--forest);
      border-radius: 16px;
      padding: 40px 48px;
      color: #fff;
      margin-bottom: 36px;
      position: relative;
      overflow: hidden;
    }
    .hero-banner::before {
      content: '';
      position: absolute;
      right: -40px; top: -40px;
      width: 300px; height: 300px;
      background: radial-gradient(circle, rgba(201,168,76,0.18) 0%, transparent 70%);
    }
    .hero-banner::after {
      content: '';
      position: absolute;
      left: 40%; bottom: -60px;
      width: 200px; height: 200px;
      background: radial-gradient(circle, rgba(192,97,58,0.15) 0%, transparent 70%);
    }
    .hero-banner h1 {
      font-family: 'Playfair Display', serif;
      font-size: 32px;
      font-weight: 700;
      margin-bottom: 8px;
    }
    .hero-banner h1 em { color: var(--gold); font-style: italic; }
    .hero-banner p { color: rgba(255,255,255,0.6); font-size: 16px; max-width: 480px; }

    .stat-row { display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-bottom: 36px; }
    .stat-card {
      background: var(--white);
      border-radius: 10px;
      padding: 20px 22px;
      border: 1px solid var(--parchment);
    }
    .stat-card .num {
      font-family: 'Playfair Display', serif;
      font-size: 28px;
      font-weight: 700;
      color: var(--forest);
    }
    .stat-card .label { font-size: 13px; color: var(--mist); letter-spacing: 0.06em; }

    .section-head {
      display: flex; justify-content: space-between; align-items: baseline;
      margin-bottom: 18px;
    }
    .section-head h2 {
      font-family: 'Playfair Display', serif;
      font-size: 20px;
      font-weight: 600;
    }

    .trips-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; }
    .trip-card {
      background: var(--white);
      border-radius: 12px;
      overflow: hidden;
      border: 1px solid var(--parchment);
      cursor: pointer;
      transition: all 0.22s;
      box-shadow: 0 2px 8px var(--shadow);
    }
    .trip-card:hover { transform: translateY(-3px); box-shadow: 0 8px 24px var(--shadow-strong); }
    .trip-card-banner {
      height: 60px;
      background: linear-gradient(135deg, var(--forest) 0%, var(--forest-mid) 100%);
      position: relative;
      display: flex; align-items: flex-end;
      padding: 12px 16px;
    }
    .trip-card-flag {
      font-size: 28px;
      position: absolute;
      right: 14px; top: 14px;
    }
    .trip-card-dest {
      color: var(--gold);
      font-family: 'DM Mono', monospace;
      font-size: 11px;
      letter-spacing: 0.14em;
      text-transform: uppercase;
    }
    .trip-card-body { padding: 16px; }
    .trip-card-name {
      font-family: 'Playfair Display', serif;
      font-size: 17px;
      font-weight: 600;
      margin-bottom: 4px;
    }
    .trip-card-dates { font-size: 13px; color: var(--mist); }
    .trip-card-footer {
      border-top: 1px solid var(--parchment);
      padding: 10px 16px;
      display: flex; gap: 8px; flex-wrap: wrap;
    }
    .badge {
      padding: 2px 8px;
      border-radius: 20px;
      font-size: 11px;
      font-family: 'DM Mono', monospace;
      letter-spacing: 0.04em;
    }
    .badge-forest { background: rgba(26,58,42,0.1); color: var(--forest); }
    .badge-terra { background: rgba(192,97,58,0.1); color: var(--terracotta); }
    .badge-gold { background: rgba(201,168,76,0.12); color: #a07820; }

    /* ‚îÄ‚îÄ‚îÄ Trip Detail ‚îÄ‚îÄ‚îÄ */
    .trip-header {
      background: var(--forest);
      border-radius: 14px;
      padding: 32px 36px;
      color: #fff;
      margin-bottom: 28px;
      display: flex; justify-content: space-between; align-items: flex-start;
    }
    .trip-header-title {
      font-family: 'Playfair Display', serif;
      font-size: 28px;
      font-weight: 700;
    }
    .trip-header-meta { font-size: 14px; color: rgba(255,255,255,0.55); margin-top: 6px; }
    .trip-header-meta span { color: var(--gold); }
    .trip-header-eyebrow {
      font-size: 13px;
      color: rgba(255,255,255,0.5);
      margin-bottom: 4px;
      font-family: 'DM Mono', monospace;
      letter-spacing: 0.1em;
      text-transform: uppercase;
    }
    .trip-header-note {
      margin-top: 8px;
      font-size: 14px;
      color: rgba(255,255,255,0.55);
      font-style: italic;
    }
    .trip-header-actions {
      display: flex;
      gap: 10px;
      align-items: center;
      justify-content: flex-end;
      flex-wrap: wrap;
    }

    .tabs {
      display: flex; gap: 0;
      background: var(--white);
      border-radius: 10px;
      border: 1px solid var(--parchment);
      padding: 4px;
      margin-bottom: 28px;
      overflow-x: auto;
    }
    .tab {
      padding: 8px 18px;
      border-radius: 7px;
      cursor: pointer;
      font-size: 14px;
      color: var(--mist);
      transition: all 0.18s;
      white-space: nowrap;
      border: none;
      background: transparent;
      font-family: 'Crimson Pro', serif;
    }
    .tab.active { background: var(--forest); color: #fff; }
    .tab:hover:not(.active) { background: var(--parchment); color: var(--ink); }

    .tab-panel { display: none; }
    .tab-panel.active { display: block; }

    .itinerary-filter-bar {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 6px;
      background: var(--white);
      border-radius: 10px;
      border: 1px solid var(--parchment);
      padding: 6px;
      margin-bottom: 20px;
      width: 100%;
    }
    .itinerary-filter-btn {
      border: none;
      background: transparent;
      color: var(--mist);
      border-radius: 7px;
      padding: 8px 18px;
      font-size: 14px;
      cursor: pointer;
      font-family: 'Crimson Pro', serif;
      white-space: nowrap;
      width: 100%;
      text-align: center;
      transition: all 0.18s;
    }
    .itinerary-filter-btn:hover { background: var(--parchment); color: var(--ink); }
    .itinerary-filter-btn.active {
      background: var(--forest);
      color: #fff;
    }

    /* ‚îÄ‚îÄ‚îÄ Day cards ‚îÄ‚îÄ‚îÄ */
    .day-card {
      background: var(--white);
      border-radius: 12px;
      border: 1px solid var(--parchment);
      margin-bottom: 20px;
      overflow: hidden;
    }
    .day-card-head {
      background: var(--forest);
      color: #fff;
      padding: 14px 20px;
      display: flex; justify-content: space-between; align-items: center;
      cursor: pointer;
    }
    .day-head-main { display:flex; align-items:flex-start; gap:10px; min-width:0; }
    .day-head-actions { display:flex; gap:8px; }
    .day-toggle {
      width: 18px;
      flex-shrink: 0;
      color: rgba(255,255,255,0.75);
      font-size: 14px;
      line-height: 1;
      margin-top: 1px;
    }
    .day-card-head .day-label {
      font-family: 'DM Mono', monospace;
      font-size: 11px;
      letter-spacing: 0.16em;
      text-transform: uppercase;
      color: var(--gold);
    }
    .day-card-head .day-title {
      font-family: 'Playfair Display', serif;
      font-size: 16px;
      margin-top: 2px;
    }
    .day-card-body { padding: 0; }
    .day-card.collapsed .day-card-body { display: none; }

    .activity-row {
      display: flex; align-items: flex-start;
      padding: 14px 20px;
      border-bottom: 1px solid var(--parchment);
      gap: 16px;
      transition: background 0.15s;
    }
    .activity-row:last-child { border-bottom: none; }
    .activity-row:hover { background: rgba(245,240,232,0.5); }
    .activity-time {
      font-family: 'DM Mono', monospace;
      font-size: 11.5px;
      color: var(--mist);
      width: 56px;
      flex-shrink: 0;
      margin-top: 2px;
    }
    .activity-dot {
      width: 28px; height: 28px; border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      font-size: 13px;
      flex-shrink: 0;
    }
    .activity-dot.cat-food { background: rgba(201,168,76,0.15); }
    .activity-dot.cat-attraction { background: rgba(26,58,42,0.12); }
    .activity-dot.cat-transport { background: rgba(192,97,58,0.12); }
    .activity-dot.cat-hotel { background: rgba(100,100,180,0.12); }
    .activity-dot.cat-other { background: rgba(100,100,100,0.1); }
    .activity-info { flex: 1; }
    .activity-title { font-weight: 600; font-size: 15px; }
    .activity-desc { font-size: 13.5px; color: var(--ink-mid); margin-top: 2px; }
    .activity-meta { display: flex; gap: 10px; margin-top: 6px; flex-wrap: wrap; }
    .activity-location { font-size: 12px; color: var(--mist); font-family: 'DM Mono', monospace; }
    .activity-cost { font-size: 12px; color: var(--terracotta); font-family: 'DM Mono', monospace; }
    .activity-actions { display: flex; gap: 6px; opacity: 0; transition: opacity 0.2s; }
    .activity-row:hover .activity-actions { opacity: 1; }

    .add-activity-bar {
      padding: 12px 20px;
      border-top: 1px dashed #d8cfbe;
    }

    /* ‚îÄ‚îÄ‚îÄ Budget ‚îÄ‚îÄ‚îÄ */
    .budget-overview {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 28px;
    }
    .budget-box {
      background: var(--white);
      border: 1px solid var(--parchment);
      border-radius: 12px;
      padding: 22px 24px;
    }
    .budget-box .b-label { font-size: 12px; letter-spacing: 0.1em; text-transform: uppercase; color: var(--mist); font-family: 'DM Mono', monospace; }
    .budget-box .b-val { font-family: 'Playfair Display', serif; font-size: 32px; font-weight: 700; color: var(--forest); }
    .budget-box .b-val.over { color: var(--terracotta); }
    .progress-bar { height: 6px; background: var(--parchment); border-radius: 99px; margin-top: 12px; overflow: hidden; }
    .progress-fill { height: 100%; border-radius: 99px; background: var(--forest); transition: width 0.4s; }
    .progress-fill.warn { background: var(--terracotta); }

    .expense-table {
      width: 100%;
      border-collapse: collapse;
      background: var(--white);
      border-radius: 12px;
      overflow: hidden;
      border: 1px solid var(--parchment);
    }
    .expense-table th {
      background: var(--forest);
      color: rgba(255,255,255,0.7);
      font-family: 'DM Mono', monospace;
      font-size: 11px;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      padding: 12px 16px;
      text-align: left;
      font-weight: 400;
    }
    .expense-table td {
      padding: 12px 16px;
      border-bottom: 1px solid var(--parchment);
      font-size: 14.5px;
    }
    .expense-table tr:last-child td { border-bottom: none; }
    .expense-table tr:hover td { background: rgba(245,240,232,0.5); }
    .table-scroll {
      width: 100%;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      border-radius: 12px;
    }
    .table-scroll .expense-table { min-width: 620px; }

    /* ‚îÄ‚îÄ‚îÄ Checklist ‚îÄ‚îÄ‚îÄ */
    .checklist-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
    .checklist-card {
      background: var(--white);
      border: 1px solid var(--parchment);
      border-radius: 12px;
      padding: 20px 22px;
    }
    .checklist-card h3 {
      font-family: 'Playfair Display', serif;
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 14px;
      padding-bottom: 10px;
      border-bottom: 1px solid var(--parchment);
    }
    .check-item {
      display: flex; align-items: center; gap: 10px;
      padding: 7px 0;
      cursor: pointer;
      border-radius: 6px;
      transition: background 0.15s;
      font-size: 14.5px;
    }
    .check-item:hover { background: rgba(245,240,232,0.5); padding: 7px 6px; margin: 0 -6px; }
    .check-item input[type="checkbox"] {
      accent-color: var(--forest);
      width: 15px; height: 15px;
      cursor: pointer;
    }
    .check-item.checked { text-decoration: line-through; color: var(--mist); }

    /* ‚îÄ‚îÄ‚îÄ Accom & Transport ‚îÄ‚îÄ‚îÄ */
    .info-card {
      background: var(--white);
      border: 1px solid var(--parchment);
      border-radius: 12px;
      padding: 20px 22px;
      margin-bottom: 16px;
      display: flex; justify-content: space-between; align-items: flex-start;
    }
    .info-card-left h3 { font-family: 'Playfair Display', serif; font-size: 16px; font-weight: 600; margin-bottom: 4px; }
    .info-card-left p { font-size: 13.5px; color: var(--ink-mid); }
    .info-card-meta { margin-top: 10px; display: flex; gap: 10px; flex-wrap: wrap; }
    .meta-pill {
      background: var(--parchment);
      padding: 3px 10px;
      border-radius: 20px;
      font-size: 12px;
      font-family: 'DM Mono', monospace;
      color: var(--ink-mid);
    }

    /* ‚îÄ‚îÄ‚îÄ Considerations ‚îÄ‚îÄ‚îÄ */
    .considerations-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; }
    .consider-card {
      background: var(--white);
      border: 1px solid var(--parchment);
      border-radius: 12px;
      padding: 20px;
    }
    .consider-card .c-icon { font-size: 26px; margin-bottom: 10px; }
    .consider-card h3 { font-family: 'Playfair Display', serif; font-size: 15px; font-weight: 600; margin-bottom: 8px; }
    .consider-card ul { list-style: none; }
    .consider-card ul li { font-size: 13.5px; color: var(--ink-mid); padding: 3px 0; display: flex; gap: 6px; align-items: flex-start; }
    .consider-card ul li::before { content: '¬∑'; color: var(--terracotta); font-size: 18px; line-height: 1.2; flex-shrink: 0; }

    /* ‚îÄ‚îÄ‚îÄ Modals ‚îÄ‚îÄ‚îÄ */
    .modal-overlay {
      display: none;
      position: fixed; inset: 0;
      background: rgba(26,58,42,0.55);
      z-index: 200;
      align-items: center; justify-content: center;
    }
    .modal-overlay.open { display: flex; }
    .modal {
      background: var(--white);
      border-radius: 16px;
      width: 500px;
      max-width: 95vw;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 24px 60px rgba(0,0,0,0.25);
    }
    .modal-head {
      padding: 24px 28px 16px;
      border-bottom: 1px solid var(--parchment);
      display: flex; justify-content: space-between; align-items: center;
    }
    .modal-head h2 {
      font-family: 'Playfair Display', serif;
      font-size: 20px;
      font-weight: 600;
    }
    .modal-close {
      background: none; border: none; font-size: 20px;
      cursor: pointer; color: var(--mist); line-height: 1;
    }
    .modal-body { padding: 24px 28px; }
    .modal-footer { padding: 16px 28px 24px; display: flex; gap: 10px; justify-content: flex-end; }

    /* ‚îÄ‚îÄ‚îÄ Forms ‚îÄ‚îÄ‚îÄ */
    .form-group { margin-bottom: 18px; }
    .form-group label {
      display: block;
      font-family: 'DM Mono', monospace;
      font-size: 11px;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      color: var(--mist);
      margin-bottom: 6px;
    }
    .form-group input,
    .form-group select,
    .form-group textarea {
      width: 100%;
      padding: 10px 14px;
      border: 1px solid #d8cfbe;
      border-radius: 7px;
      font-family: 'Crimson Pro', serif;
      font-size: 15px;
      color: var(--ink);
      background: var(--white);
      outline: none;
      transition: border-color 0.2s;
    }
    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus { border-color: var(--forest); }
    .form-group textarea { min-height: 80px; resize: vertical; }
    .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; }
    .trip-destination-row {
      display: flex;
      gap: 8px;
      align-items: center;
    }
    .panel-actions-right {
      display: flex;
      justify-content: flex-end;
      margin-bottom: 16px;
    }

    /* ‚îÄ‚îÄ‚îÄ Activity Modal Usability ‚îÄ‚îÄ‚îÄ */
    #modalAddActivity .modal { width: 720px; }
    #modalAddActivity .modal-head h2 { font-size: 36px; }
    #modalAddActivity .modal-close { font-size: 34px; }
    #modalAddActivity .modal-body { padding-top: 20px; }
    #modalAddActivity .modal-footer .btn {
      font-size: 20px;
      padding: 12px 22px;
      border-radius: 10px;
      min-width: 150px;
      justify-content: center;
    }
    #modalAddActivity .form-row { grid-template-columns: 1fr; gap: 10px; }
    #modalAddActivity .form-group label {
      font-family: 'Crimson Pro', serif;
      font-size: 17px;
      font-weight: 600;
      letter-spacing: 0;
      text-transform: none;
      color: var(--ink-mid);
      margin-bottom: 8px;
    }
    #modalAddActivity .form-group input,
    #modalAddActivity .form-group select,
    #modalAddActivity .form-group textarea {
      font-size: 18px;
      padding: 14px 16px;
      border-radius: 10px;
    }
    #modalAddActivity .form-group textarea { min-height: 110px; }
    .activity-cost-hint {
      font-size: 14px;
      color: var(--mist);
      margin-top: -8px;
      margin-bottom: 6px;
    }
    .activity-fx {
      border: 1px dashed #d8cfbe;
      border-radius: 10px;
      padding: 10px 12px 6px;
      background: rgba(245,240,232,0.35);
      margin-top: 6px;
      margin-bottom: 10px;
    }
    .activity-fx-row { margin-bottom: 10px; }
    .activity-fx-line {
      display: grid;
      grid-template-columns: 1fr 240px;
      gap: 10px;
      margin-bottom: 10px;
    }
    @media (max-width: 980px) {
      body { font-size: 16px; }
      .main { margin-left: 0; }
      .sidebar {
        transform: translateX(-100%);
        box-shadow: 0 14px 32px rgba(0,0,0,0.22);
      }
      .app:not(.sidebar-collapsed) .sidebar {
        width: 260px;
        transform: translateX(0);
        opacity: 1;
        pointer-events: auto;
      }
      .app:not(.sidebar-collapsed) .sidebar-backdrop { display: block; }
      .topbar {
        height: 60px;
        min-height: 60px;
        padding: 8px 14px;
        gap: 10px;
        flex-wrap: nowrap;
      }
      .topbar-left {
        width: auto;
        min-width: 0;
        flex: 1;
      }
      .topbar-right {
        width: auto;
        justify-content: space-between;
        gap: 8px;
      }
      .sync-badge { max-width: 42vw; }
      .content { padding: 18px 12px; }
      .hero-banner {
        padding: 22px 16px;
        margin-bottom: 16px;
      }
      .hero-banner::before,
      .hero-banner::after {
        display: none;
      }
      .hero-banner h1 { font-size: 24px; }
      .hero-banner p { font-size: 14px; }
      .trips-grid { grid-template-columns: repeat(auto-fill, minmax(230px, 1fr)); gap: 14px; }
      .trip-header {
        padding: 16px 14px;
        gap: 10px;
        flex-direction: column;
      }
      .trip-header-title { font-size: 22px; }
      .trip-header-actions { justify-content: flex-start; }
      .budget-overview { grid-template-columns: 1fr; gap: 14px; }
      .checklist-grid { grid-template-columns: 1fr; gap: 14px; }
      .considerations-grid { grid-template-columns: repeat(2, 1fr); gap: 14px; }
      .section-head {
        flex-wrap: wrap;
        gap: 10px;
      }
    }
    @media (max-width: 760px) {
      body { font-size: 15px; }
      .activity-fx-line { grid-template-columns: 1fr; }
      .topbar {
        height: 52px;
        min-height: 52px;
        padding: 6px 8px;
        gap: 6px;
      }
      .topbar-left { gap: 8px; }
      .topbar-right { gap: 6px; }
      .topbar-title { font-size: 15px; }
      .topbar-actions .btn {
        padding: 6px 8px;
        font-size: 11px;
      }
      .content { padding: 10px 8px 14px; }
      .hero-banner {
        border-radius: 12px;
        padding: 14px 12px;
      }
      .hero-banner h1 {
        font-size: 20px;
        margin-bottom: 0;
      }
      .hero-banner p { display: none; }
      .trips-grid { grid-template-columns: 1fr; }
      .trip-header {
        border-radius: 12px;
        padding: 14px 12px;
        margin-bottom: 12px;
      }
      .trip-header-title { font-size: 20px; }
      .trip-header-meta { font-size: 13px; }
      .trip-header-eyebrow { font-size: 11px; }
      .trip-header-actions {
        width: 100%;
        display: grid;
        grid-template-columns: repeat(2, minmax(0, 1fr));
        gap: 8px;
        align-items: stretch;
      }
      .trip-header-actions .btn:first-child { grid-column: 1 / -1; }
      .trip-header-actions .btn {
        width: auto;
        justify-content: center;
        padding: 8px 10px;
      }
      .itinerary-filter-bar {
        display: flex;
        gap: 8px;
        overflow-x: auto;
        white-space: nowrap;
        padding: 6px;
        scrollbar-width: none;
      }
      .itinerary-filter-bar::-webkit-scrollbar { display: none; }
      .itinerary-filter-btn {
        flex: 0 0 auto;
        width: auto;
        min-width: 110px;
        padding: 8px 10px;
        font-size: 13px;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      .day-card { margin-bottom: 12px; }
      .day-card-head {
        padding: 12px 12px;
        flex-direction: row;
        align-items: flex-start;
        gap: 10px;
      }
      .day-head-main { flex: 1; min-width: 0; }
      .day-head-actions { width: auto; flex-shrink: 0; }
      .day-card.collapsed .day-head-actions .btn:not(.btn-icon) { display: none; }
      .day-head-actions .btn {
        flex: 0 0 auto;
        justify-content: center;
        font-size: 12px;
        padding: 6px 10px;
      }
      .day-head-actions .btn-icon {
        width: 34px;
        height: 34px;
        padding: 0;
      }
      .activity-row {
        display: grid;
        grid-template-columns: 52px 30px 1fr;
        gap: 8px 10px;
        padding: 12px;
      }
      .activity-time {
        grid-column: 1;
        margin-top: 4px;
      }
      .activity-dot { grid-column: 2; }
      .activity-info {
        grid-column: 3;
        min-width: 0;
      }
      .activity-actions {
        grid-column: 1 / -1;
        justify-content: flex-end;
        opacity: 1;
      }
      .panel-actions-right { margin-bottom: 10px; }
      .info-card {
        padding: 14px;
        flex-direction: column;
        gap: 12px;
      }
      .info-card > .btn { width: 100%; }
      .considerations-grid { grid-template-columns: 1fr; }
      .form-row { grid-template-columns: 1fr; gap: 10px; }
      .trip-destination-row {
        flex-direction: column;
        align-items: stretch;
      }
      .trip-destination-row .btn { width: 100%; justify-content: center; }
      .modal-overlay {
        align-items: flex-end;
        padding: 0;
      }
      .modal {
        width: 100%;
        max-width: 100%;
        max-height: 95vh;
        border-radius: 16px 16px 0 0;
      }
      .modal-head { padding: 14px 14px 10px; }
      .modal-head h2 { font-size: 20px; }
      .modal-body { padding: 14px; }
      .modal-footer {
        padding: 10px 14px 14px;
        flex-direction: column-reverse;
      }
      .modal-footer .btn {
        width: 100%;
        justify-content: center;
      }
      #modalAddActivity .modal { width: 100%; }
      #modalAddActivity .modal-head h2 { font-size: 24px; }
      #modalAddActivity .modal-close { font-size: 24px; }
      #modalAddActivity .form-group input,
      #modalAddActivity .form-group select,
      #modalAddActivity .form-group textarea {
        font-size: 16px;
        padding: 11px 12px;
      }
      #modalAddActivity .modal-footer .btn {
        font-size: 16px;
        min-width: 0;
      }
      #modalAddActivity .form-group label { font-size: 15px; }
      .activity-fx summary { font-size: 16px; }
    }
    @media (max-width: 560px) {
      .sync-badge { display: none; }
      .topbar-actions .btn { padding: 6px 8px; font-size: 11px; }
      .topbar-title { font-size: 14px; }
      .content { padding: 8px 6px 12px; }
      .empty-state { padding: 36px 12px; }
      .trip-header {
        padding: 12px 10px;
        border-radius: 10px;
      }
      .trip-header-title { font-size: 19px; }
      .trip-header-meta { font-size: 12px; }
      .trip-header-actions {
        grid-template-columns: repeat(2, minmax(0, 1fr));
        gap: 6px;
      }
      .trip-header-actions .btn:first-child { grid-column: 1 / -1; }
      .trip-header-actions .btn {
        padding: 7px 8px;
        font-size: 12px;
      }
      #modalAddActivity .modal {
        max-height: 96vh;
        border-radius: 14px 14px 0 0;
      }
      #modalAddActivity .modal-head {
        padding: 10px 12px 8px;
      }
      #modalAddActivity .modal-head h2 {
        font-size: 20px;
      }
      #modalAddActivity .modal-close {
        font-size: 20px;
      }
      #modalAddActivity .modal-body {
        padding: 10px 12px;
      }
      #modalAddActivity .modal-footer {
        padding: 8px 12px 12px;
        gap: 8px;
        position: sticky;
        bottom: 0;
        background: linear-gradient(180deg, rgba(253,250,245,0.9) 0%, rgba(253,250,245,1) 24%);
        border-top: 1px solid var(--parchment);
      }
      #modalAddActivity .form-group {
        margin-bottom: 12px;
      }
      #modalAddActivity .form-group label {
        font-size: 13px;
        margin-bottom: 5px;
      }
      #modalAddActivity .form-row {
        grid-template-columns: 1fr 1fr;
        gap: 8px;
      }
      #modalAddActivity .form-group input,
      #modalAddActivity .form-group select,
      #modalAddActivity .form-group textarea {
        font-size: 14px;
        padding: 9px 10px;
        border-radius: 8px;
      }
      #modalAddActivity .form-group textarea {
        min-height: 82px;
      }
      #modalAddActivity .activity-cost-hint {
        font-size: 12px;
        margin-top: -6px;
        margin-bottom: 6px;
      }
      #modalAddActivity .activity-fx {
        padding: 8px 9px 4px;
        margin-top: 4px;
      }
      #modalAddActivity .activity-fx summary {
        font-size: 14px;
        margin-bottom: 6px;
      }
      #modalAddActivity .activity-fx-line {
        gap: 8px;
        margin-bottom: 8px;
      }
      #modalAddActivity #activityFxButton {
        margin-bottom: 6px;
        font-size: 13px;
        padding: 8px 10px;
      }
      #modalAddActivity #activityFxNote {
        font-size: 12px;
        margin: 4px 0 2px;
      }
      #modalAddActivity .modal-footer .btn {
        font-size: 14px;
        min-height: 44px;
        padding: 10px 12px;
        border-radius: 10px;
      }
      #modalAddActivity .modal-footer .btn.btn-primary {
        min-height: 46px;
        font-size: 15px;
        font-weight: 600;
      }
      .itinerary-filter-bar {
        display: grid;
        grid-template-columns: repeat(3, minmax(0, 1fr));
        gap: 6px;
        overflow: visible;
        white-space: normal;
        padding: 4px;
      }
      .itinerary-filter-btn {
        min-width: 0;
        width: 100%;
        padding: 7px 6px;
        font-size: 11.5px;
      }
      .day-card { margin-bottom: 10px; }
      .day-card-head { padding: 10px 10px; }
      .day-card-head .day-label {
        font-size: 10px;
        letter-spacing: 0.12em;
      }
      .day-card-head .day-title { font-size: 13px; }
      .day-head-actions .btn {
        font-size: 11px;
        padding: 5px 8px;
      }
      .day-head-actions .btn-icon {
        width: 30px;
        height: 30px;
      }
      .table-scroll {
        overflow-x: visible;
        border-radius: 0;
      }
      .expense-table {
        border: none;
        background: transparent;
      }
      .expense-table thead { display: none; }
      .expense-table tbody,
      .expense-table tr,
      .expense-table td {
        display: block;
        width: 100%;
      }
      .expense-table tr {
        background: var(--white);
        border: 1px solid var(--parchment);
        border-radius: 10px;
        margin-bottom: 10px;
        padding: 8px 10px;
      }
      .expense-table td {
        border: none;
        padding: 6px 0;
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 10px;
      }
      .expense-table td::before {
        content: attr(data-label);
        color: var(--mist);
        font-family: 'DM Mono', monospace;
        font-size: 10px;
        letter-spacing: 0.08em;
        text-transform: uppercase;
      }
      .expense-table td:last-child {
        justify-content: flex-end;
        padding-top: 8px;
      }
      .expense-table td:last-child::before { content: none; }
      .expense-table td[colspan] {
        display: block;
        text-align: center !important;
      }
      .expense-table td[colspan]::before { content: none; }
    }
    @media (max-width: 760px) {
      .auth-card { padding: 18px 14px; }
      .auth-title { font-size: 28px; }
    }
    #modalAddActivity .activity-fx-line .form-group { margin-bottom: 0; }
    #activityFxButton {
      width: 100%;
      justify-content: center;
      margin-bottom: 8px;
    }
    .activity-fx summary {
      cursor: pointer;
      font-family: 'Crimson Pro', serif;
      font-size: 18px;
      font-weight: 600;
      color: var(--ink-mid);
      margin-bottom: 8px;
      user-select: none;
    }
    #activityFxNote {
      font-size: 14px;
      color: var(--mist);
      margin: 6px 0 4px;
    }

    /* ‚îÄ‚îÄ‚îÄ Supabase config ‚îÄ‚îÄ‚îÄ */
    .config-banner {
      background: linear-gradient(135deg, rgba(201,168,76,0.12) 0%, rgba(26,58,42,0.08) 100%);
      border: 1px dashed var(--gold);
      border-radius: 12px;
      padding: 20px 24px;
      margin-bottom: 28px;
      display: flex; gap: 16px; align-items: flex-start;
    }
    .config-banner .cfg-icon { font-size: 24px; flex-shrink: 0; }
    .config-banner h3 { font-family: 'Playfair Display', serif; font-size: 16px; font-weight: 600; margin-bottom: 4px; }
    .config-banner p { font-size: 13.5px; color: var(--ink-mid); }
    .config-banner.hidden { display: none; }

    /* ‚îÄ‚îÄ‚îÄ Auth Gate ‚îÄ‚îÄ‚îÄ */
    .auth-gate {
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      background: linear-gradient(145deg, #f2ebdf 0%, #e8ddc8 100%);
      padding: 20px;
      z-index: 1200;
    }
    .auth-gate.open { display: flex; }
    .auth-card {
      width: min(460px, 94vw);
      background: var(--white);
      border: 1px solid var(--parchment);
      border-radius: 14px;
      box-shadow: 0 20px 42px rgba(26,58,42,0.14);
      padding: 24px;
    }
    .auth-title {
      font-family: 'Playfair Display', serif;
      font-size: 34px;
      color: var(--forest);
      margin-bottom: 6px;
      text-align: center;
    }
    .auth-subtitle {
      text-align: center;
      color: var(--mist);
      font-size: 14px;
      margin-bottom: 18px;
    }
    .auth-error {
      display: none;
      border: 1px solid #f1c4b8;
      background: #fdf2ef;
      color: #9e3d23;
      border-radius: 8px;
      padding: 9px 10px;
      font-size: 13px;
      margin-bottom: 12px;
    }
    .auth-error.show { display: block; }
    .auth-alt {
      margin-top: 12px;
      text-align: center;
      font-size: 14px;
      color: var(--ink-mid);
    }
    .auth-alt button {
      border: none;
      background: transparent;
      color: var(--forest);
      cursor: pointer;
      text-decoration: underline;
      font: inherit;
      padding: 0;
    }
    .auth-note {
      margin-top: 14px;
      text-align: center;
      font-size: 12px;
      color: var(--mist);
    }

    /* ‚îÄ‚îÄ‚îÄ Empty states ‚îÄ‚îÄ‚îÄ */
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: var(--mist);
    }
    .empty-state .e-icon { font-size: 48px; margin-bottom: 14px; }
    .empty-state h3 { font-family: 'Playfair Display', serif; font-size: 18px; color: var(--ink-mid); margin-bottom: 8px; }
    .empty-state p { font-size: 14px; max-width: 320px; margin: 0 auto 20px; }

    /* ‚îÄ‚îÄ‚îÄ Toast ‚îÄ‚îÄ‚îÄ */
    .toast-container { position: fixed; bottom: 24px; right: 24px; z-index: 999; display: flex; flex-direction: column; gap: 8px; }
    .toast {
      background: var(--forest);
      color: #fff;
      padding: 12px 20px;
      border-radius: 8px;
      font-size: 14px;
      box-shadow: 0 4px 16px rgba(0,0,0,0.2);
      animation: slideIn 0.25s ease;
    }
    .toast.success { background: var(--forest); }
    .toast.error { background: var(--terracotta); }
    @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    /* Scrollbar */
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: rgba(26,58,42,0.2); border-radius: 3px; }
  </style>
</head>
<body>

<div class="auth-gate open" id="authGate">
  <div class="auth-card">
    <div class="auth-title">Voyageur</div>
    <div class="auth-subtitle" id="authSubtitle">Sign in to access your trips</div>
    <div class="auth-error" id="authError"></div>
    <form onsubmit="event.preventDefault(); submitAuth();">
      <div class="form-group">
        <label>Email</label>
        <input type="email" id="authEmail" placeholder="you@example.com" autocomplete="username" required />
      </div>
      <div class="form-group">
        <label>Password</label>
        <input type="password" id="authPassword" placeholder="Minimum 6 characters" autocomplete="current-password" required minlength="6" />
      </div>
      <button type="submit" class="btn btn-primary" id="authSubmitBtn" style="width:100%;justify-content:center;">Sign In</button>
    </form>
    <div class="auth-alt">
      <span id="authAltText">No account yet?</span>
      <button type="button" id="authAltBtn" onclick="toggleAuthMode()">Create one</button>
    </div>
    <div class="auth-note">Your data stays in Supabase under your account.</div>
  </div>
</div>

<!-- ‚îÄ‚îÄ‚îÄ App ‚îÄ‚îÄ‚îÄ -->
<div class="app" id="mainApp" style="display:none;">

  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="sidebar-logo">
      <div class="wordmark" id="sidebarWordmark" data-full="Voyageur" data-short="V">Voyageur</div>
      <div class="tagline">Travel Planner</div>
    </div>
    <div class="sidebar-nav">
      <div class="sidebar-section">Navigate</div>
      <div class="nav-item active" onclick="showPanel('dashboard')">
        <span class="icon">üó∫Ô∏è</span><span class="nav-label">Dashboard</span>
      </div>
      <div class="nav-item" onclick="showPanel('considerations')">
        <span class="icon">üí°</span><span class="nav-label">What to Consider</span>
      </div>
      <div class="nav-item" onclick="showPanel('settings')">
        <span class="icon">‚öôÔ∏è</span><span class="nav-label">Settings</span>
      </div>
    </div>
    <div>
      <div class="sidebar-section" style="padding-top:24px;">My Trips</div>
      <div class="sidebar-trips" id="sidebarTrips">
        <div style="padding: 8px 12px; font-size:13px; color:rgba(255,255,255,0.3); font-style:italic;">Loading trips‚Ä¶</div>
      </div>
      <button class="btn-new-trip" onclick="openNewTripModal()">+ New Trip</button>
    </div>
  </aside>
  <div class="sidebar-backdrop" id="sidebarBackdrop" onclick="toggleSidebar()"></div>

  <!-- Main -->
  <main class="main">
    <div class="topbar">
      <div class="topbar-left">
        <button class="sidebar-toggle" id="sidebarToggleBtn" onclick="toggleSidebar()" aria-label="Collapse sidebar">‚ò∞</button>
        <div class="topbar-title" id="topbarTitle">Dashboard</div>
      </div>
      <div class="topbar-right">
        <div class="sync-badge" id="syncStatusBadge">Checking‚Ä¶</div>
        <div class="topbar-actions" id="topbarActions">
          <button class="btn btn-primary" onclick="openNewTripModal()">+ New Trip</button>
        </div>
      </div>
    </div>
    <div class="content">

      <!-- Dashboard -->
      <div class="panel active" id="panel-dashboard">
        <div class="hero-banner">
          <h1>Plan your next <em>adventure</em></h1>
          <!-- <p>Build detailed day-by-day itineraries, track your budget, manage bookings, and pack smart.</p> -->
        </div>
        <div class="section-head">
          <h2>Your Trips</h2>
        </div>
        <div class="trips-grid" id="tripsGrid">
          <div class="empty-state">
            <div class="e-icon">‚úàÔ∏è</div>
            <h3>No trips yet</h3>
            <p>Create your first trip to start planning your adventure.</p>
            <button class="btn btn-primary" onclick="openNewTripModal()">Create a Trip</button>
          </div>
        </div>
      </div>

      <!-- Trip Detail -->
      <div class="panel" id="panel-trip">
        <div class="trip-header" id="tripHeader"></div>

        <!-- Itinerary tab -->
        <div class="tab-panel active" id="tab-itinerary">
          <div class="itinerary-filter-bar" id="itineraryFilterBar">
            <button class="itinerary-filter-btn active" data-itinerary-filter="all" onclick="setItineraryFilter('all')">All</button>
            <button class="itinerary-filter-btn" data-itinerary-filter="attraction" onclick="setItineraryFilter('attraction')">üèõÔ∏è Attraction</button>
            <button class="itinerary-filter-btn" data-itinerary-filter="food" onclick="setItineraryFilter('food')">üçú Food</button>
            <button class="itinerary-filter-btn" data-itinerary-filter="transport" onclick="setItineraryFilter('transport')">üöå Transport</button>
            <button class="itinerary-filter-btn" data-itinerary-filter="hotel" onclick="setItineraryFilter('hotel')">üè® Hotel</button>
            <button class="itinerary-filter-btn" data-itinerary-filter="other" onclick="setItineraryFilter('other')">üìå Other</button>
          </div>
          <div id="daysContainer"></div>
        </div>

        <!-- Accommodation tab -->
        <div class="tab-panel" id="tab-accommodation">
          <div class="panel-actions-right">
            <button class="btn btn-primary" onclick="openAddAccomModal()">+ Add Accommodation</button>
          </div>
          <div id="accomContainer"></div>
        </div>

        <!-- Transport tab -->
        <div class="tab-panel" id="tab-transport">
          <div class="panel-actions-right">
            <button class="btn btn-primary" onclick="openAddTransportModal()">+ Add Transport</button>
          </div>
          <div id="transportContainer"></div>
        </div>

        <!-- Budget tab -->
        <div class="tab-panel" id="tab-budget">
          <div class="budget-overview" id="budgetOverview"></div>
          <div class="section-head">
            <h2>Expenses</h2>
            <button class="btn btn-primary btn-sm" onclick="openAddExpenseModal()">+ Add Expense</button>
          </div>
          <div class="table-scroll">
            <table class="expense-table" id="expenseTable">
              <thead><tr>
                <th>Item</th><th>Category</th><th>Date</th><th>Amount</th><th></th>
              </tr></thead>
              <tbody id="expenseBody"></tbody>
            </table>
          </div>
        </div>

        <!-- Packing tab -->
        <div class="tab-panel" id="tab-packing">
          <div class="panel-actions-right">
            <button class="btn btn-primary" onclick="openAddPackingModal()">+ Add Item</button>
          </div>
          <div class="checklist-grid" id="packingGrid"></div>
        </div>
      </div>

      <!-- What to Consider -->
      <div class="panel" id="panel-considerations">
        <div class="section-head" style="margin-bottom:24px;">
          <h2>What to Consider When Planning a Trip</h2>
        </div>
        <div class="considerations-grid">
          <div class="consider-card">
            <div class="c-icon">üìÑ</div>
            <h3>Documents & Visas</h3>
            <ul>
              <li>Passport validity (6 months beyond travel)</li>
              <li>Visa requirements & processing time</li>
              <li>Travel insurance documents</li>
              <li>Vaccination certificates if required</li>
              <li>International driving permit</li>
              <li>Copies of all key documents</li>
            </ul>
          </div>
          <div class="consider-card">
            <div class="c-icon">üí∞</div>
            <h3>Budget Planning</h3>
            <ul>
              <li>Flights & local transport</li>
              <li>Accommodation costs</li>
              <li>Daily food & drink budget</li>
              <li>Activities & entrance fees</li>
              <li>Emergency contingency fund (10‚Äì15%)</li>
              <li>Currency exchange rates & fees</li>
            </ul>
          </div>
          <div class="consider-card">
            <div class="c-icon">‚úàÔ∏è</div>
            <h3>Flights & Transport</h3>
            <ul>
              <li>Book flights early for best prices</li>
              <li>Airport transfer options</li>
              <li>Ground transport (train, car, bus)</li>
              <li>Transit stops & layovers</li>
              <li>Baggage allowance rules</li>
              <li>Car rental requirements</li>
            </ul>
          </div>
          <div class="consider-card">
            <div class="c-icon">üè®</div>
            <h3>Accommodation</h3>
            <ul>
              <li>Location relative to attractions</li>
              <li>Check-in / check-out flexibility</li>
              <li>Cancellation policies</li>
              <li>Amenities needed (Wi-Fi, kitchen)</li>
              <li>Safety of neighbourhood</li>
              <li>Reviews & ratings</li>
            </ul>
          </div>
          <div class="consider-card">
            <div class="c-icon">üå§Ô∏è</div>
            <h3>Timing & Weather</h3>
            <ul>
              <li>Peak vs off-peak seasons</li>
              <li>Monsoon or hurricane seasons</li>
              <li>Local public holidays & events</li>
              <li>Daylight hours at destination</li>
              <li>Time zone adjustments</li>
              <li>Festival or event timing</li>
            </ul>
          </div>
          <div class="consider-card">
            <div class="c-icon">üè•</div>
            <h3>Health & Safety</h3>
            <ul>
              <li>Required & recommended vaccines</li>
              <li>Travel health insurance coverage</li>
              <li>Nearest hospitals & clinics</li>
              <li>Prescription medicines & supply</li>
              <li>Food & water safety standards</li>
              <li>Emergency contact numbers</li>
            </ul>
          </div>
          <div class="consider-card">
            <div class="c-icon">üì±</div>
            <h3>Connectivity</h3>
            <ul>
              <li>Local SIM card vs roaming plan</li>
              <li>Offline maps downloaded</li>
              <li>Important apps installed</li>
              <li>Power adapter/plug type</li>
              <li>Portable charger capacity</li>
              <li>Notify bank of travel</li>
            </ul>
          </div>
          <div class="consider-card">
            <div class="c-icon">üåç</div>
            <h3>Culture & Etiquette</h3>
            <ul>
              <li>Dress code for temples & sites</li>
              <li>Tipping customs and amounts</li>
              <li>Basic local language phrases</li>
              <li>Photography restrictions</li>
              <li>Dietary laws & restrictions</li>
              <li>Local laws & regulations</li>
            </ul>
          </div>
          <div class="consider-card">
            <div class="c-icon">üéí</div>
            <h3>Packing Essentials</h3>
            <ul>
              <li>Climate-appropriate clothing</li>
              <li>Comfortable walking shoes</li>
              <li>Universal travel adapter</li>
              <li>First aid & medications</li>
              <li>Sunscreen & insect repellent</li>
              <li>Reusable water bottle</li>
            </ul>
          </div>
        </div>
      </div>

      <!-- Settings -->
      <div class="panel" id="panel-settings">
        <div class="section-head" style="margin-bottom:24px;"><h2>Settings</h2></div>
        <div style="max-width:520px;">
          <div style="background:var(--white);border:1px solid var(--parchment);border-radius:12px;padding:28px;">
            <h3 style="font-family:'Playfair Display',serif;font-size:17px;margin-bottom:6px;">Default Currency</h3>
            <p style="font-size:13.5px;color:var(--mist);margin-bottom:16px;">Used across budget tracking</p>
            <div class="form-group">
              <select id="settingsCurrency" onchange="saveCurrencyPref()">
                <option>MYR</option><option>USD</option><option>EUR</option><option>GBP</option><option>SGD</option><option>AUD</option><option>JPY</option><option>THB</option>
              </select>
            </div>
          </div>
          <div style="background:var(--white);border:1px solid var(--parchment);border-radius:12px;padding:28px;margin-top:20px;">
            <h3 style="font-family:'Playfair Display',serif;font-size:17px;margin-bottom:6px;">Account</h3>
            <p style="font-size:13.5px;color:var(--mist);margin-bottom:14px;" id="settingsUserEmail">Not signed in</p>
            <button class="btn btn-danger" onclick="signOutUser()">Sign Out</button>
          </div>
        </div>
      </div>

    </div>
  </main>
</div>

<!-- ‚îÄ‚îÄ‚îÄ Modals ‚îÄ‚îÄ‚îÄ -->

<!-- New Trip -->
<div class="modal-overlay" id="modalNewTrip">
  <div class="modal">
    <div class="modal-head">
      <h2 id="tripModalTitle">New Trip ‚úàÔ∏è</h2>
      <button class="modal-close" onclick="closeTripModal()">‚úï</button>
    </div>
    <div class="modal-body">
      <input type="hidden" id="fTripId" />
      <div class="form-group"><label>Trip Name</label><input type="text" id="fTripName" placeholder="e.g. Tokyo Spring 2025" /></div>
      <div class="form-row">
        <div class="form-group">
          <label>Destination</label>
          <div class="trip-destination-row">
            <input type="text" id="fTripDest" placeholder="e.g. Tokyo, Japan" />
            <button type="button" class="btn btn-secondary btn-sm" style="white-space:nowrap;" onclick="appendDestinationSeparator()">+ Destination</button>
          </div>
        </div>
        <div class="form-group"><label>Country Flag (emoji)</label><input type="text" id="fTripFlag" placeholder="üáØüáµ üá∞üá∑ üáπüá≠" maxlength="40" /></div>
      </div>
      <div class="form-row">
        <div class="form-group"><label>Start Date</label><input type="date" id="fTripStart" /></div>
        <div class="form-group"><label>End Date</label><input type="date" id="fTripEnd" /></div>
      </div>
      <div class="form-row">
        <div class="form-group"><label>Total Budget</label><input type="number" id="fTripBudget" placeholder="5000" /></div>
        <div class="form-group"><label>Currency</label>
          <select id="fTripCurrency">
            <option>MYR</option><option>USD</option><option>EUR</option><option>GBP</option><option>SGD</option><option>AUD</option><option>JPY</option><option>THB</option>
          </select>
        </div>
      </div>
      <div class="form-group"><label>Notes</label><textarea id="fTripNotes" placeholder="Purpose of trip, special occasions..."></textarea></div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-ghost" onclick="closeTripModal()">Cancel</button>
      <button class="btn btn-primary" id="tripModalSaveBtn" onclick="saveTrip()">Create Trip</button>
    </div>
  </div>
</div>

<!-- Add Day -->
<div class="modal-overlay" id="modalAddDay">
  <div class="modal">
    <div class="modal-head">
      <h2>Add Day</h2>
      <button class="modal-close" onclick="closeModal('modalAddDay')">‚úï</button>
    </div>
    <div class="modal-body">
      <div class="form-row">
        <div class="form-group"><label>Day Number</label><input type="number" id="fDayNum" placeholder="1" /></div>
        <div class="form-group"><label>Date</label><input type="date" id="fDayDate" /></div>
      </div>
      <div class="form-group"><label>Day Title</label><input type="text" id="fDayTitle" placeholder="e.g. Arrival & Shibuya Explore" /></div>
      <div class="form-group"><label>Notes</label><textarea id="fDayNotes" placeholder="General notes for the day..."></textarea></div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-ghost" onclick="closeModal('modalAddDay')">Cancel</button>
      <button class="btn btn-primary" onclick="saveDay()">Add Day</button>
    </div>
  </div>
</div>

<!-- Add Activity -->
<div class="modal-overlay" id="modalAddActivity">
  <div class="modal">
    <div class="modal-head">
      <h2 id="activityModalTitle">Add Activity</h2>
      <button class="modal-close" onclick="closeActivityModal()">‚úï</button>
    </div>
    <div class="modal-body">
      <input type="hidden" id="fActId" />
      <input type="hidden" id="fActDayId" />
      <div class="form-group"><label>Activity Name</label><input type="text" id="fActTitle" placeholder="e.g. Visit Senso-ji Temple" /></div>
      <div class="form-row">
        <div class="form-group"><label>Category</label>
          <select id="fActCat">
            <option value="attraction">üèõÔ∏è Attraction</option>
            <option value="food">üçú Food & Drink</option>
            <option value="transport">üöå Transport</option>
            <option value="hotel">üè® Hotel</option>
            <option value="other">üìå Other</option>
          </select>
        </div>
        <div class="form-group"><label>Time</label><input type="time" id="fActTime" /></div>
      </div>
      <div class="form-group"><label>Location / Address</label><input type="text" id="fActLoc" placeholder="Asakusa, Tokyo" /></div>
      <div class="form-group"><label>Description</label><textarea id="fActDesc" placeholder="Details, tips, booking info..." style="min-height:60px;"></textarea></div>
      <div class="form-group"><label>Estimated Cost</label><input type="number" id="fActCost" placeholder="0" /></div>
      <div class="activity-cost-hint" id="activityCostHint"></div>

      <details class="activity-fx" id="activityFxPanel">
        <summary>Need currency conversion? (Optional)</summary>
        <div class="activity-fx-row">
          <div class="activity-fx-line">
            <div class="form-group"><label>Amount A</label><input type="number" id="fActFromAmt" placeholder="0" oninput="setActivityFxDirection('from')" /></div>
            <div class="form-group"><label>Currency A</label>
              <select id="fActFromCur" onchange="setActivityFxDirection('from')"></select>
            </div>
          </div>
          <div class="activity-fx-line">
            <div class="form-group"><label>Amount B</label><input type="number" id="fActToAmt" placeholder="0" oninput="setActivityFxDirection('to')" /></div>
            <div class="form-group"><label>Currency B</label>
              <select id="fActToCur" onchange="setActivityFxDirection('to')"></select>
            </div>
          </div>
        </div>
        <button class="btn btn-secondary" id="activityFxButton" type="button" onclick="convertActivityCost()">Convert</button>
        <div id="activityFxNote"></div>
      </details>
    </div>
    <div class="modal-footer">
      <button class="btn btn-ghost" onclick="closeActivityModal()">Cancel</button>
      <button class="btn btn-primary" id="activityModalSaveBtn" onclick="saveActivity()">Add Activity</button>
    </div>
  </div>
</div>

<!-- Add Accommodation -->
<div class="modal-overlay" id="modalAddAccom">
  <div class="modal">
    <div class="modal-head">
      <h2>Add Accommodation üè®</h2>
      <button class="modal-close" onclick="closeModal('modalAddAccom')">‚úï</button>
    </div>
    <div class="modal-body">
      <div class="form-group"><label>Property Name</label><input type="text" id="fAccomName" placeholder="e.g. Park Hyatt Tokyo" /></div>
      <div class="form-group"><label>Address</label><input type="text" id="fAccomAddr" placeholder="Full address" /></div>
      <div class="form-row">
        <div class="form-group"><label>Check-in</label><input type="date" id="fAccomIn" /></div>
        <div class="form-group"><label>Check-out</label><input type="date" id="fAccomOut" /></div>
      </div>
      <div class="form-row">
        <div class="form-group"><label>Confirmation #</label><input type="text" id="fAccomConf" placeholder="ABC123" /></div>
        <div class="form-group"><label>Total Cost</label><input type="number" id="fAccomCost" placeholder="0" /></div>
      </div>
      <div class="form-group"><label>Notes</label><textarea id="fAccomNotes" placeholder="Booking platform, contact, special requests..."></textarea></div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-ghost" onclick="closeModal('modalAddAccom')">Cancel</button>
      <button class="btn btn-primary" onclick="saveAccom()">Save</button>
    </div>
  </div>
</div>

<!-- Add Transport -->
<div class="modal-overlay" id="modalAddTransport">
  <div class="modal">
    <div class="modal-head">
      <h2>Add Transport üöå</h2>
      <button class="modal-close" onclick="closeModal('modalAddTransport')">‚úï</button>
    </div>
    <div class="modal-body">
      <div class="form-row">
        <div class="form-group"><label>Type</label>
          <select id="fTransType">
            <option>‚úàÔ∏è Flight</option><option>üöÇ Train</option><option>üöå Bus</option><option>üöó Car Rental</option><option>üö¢ Ferry</option><option>üöï Taxi/Grab</option>
          </select>
        </div>
        <div class="form-group"><label>Confirmation #</label><input type="text" id="fTransConf" placeholder="Optional" /></div>
      </div>
      <div class="form-row">
        <div class="form-group"><label>From</label><input type="text" id="fTransFrom" placeholder="Kuala Lumpur" /></div>
        <div class="form-group"><label>To</label><input type="text" id="fTransTo" placeholder="Tokyo" /></div>
      </div>
      <div class="form-row">
        <div class="form-group"><label>Departure</label><input type="datetime-local" id="fTransDep" /></div>
        <div class="form-group"><label>Arrival</label><input type="datetime-local" id="fTransArr" /></div>
      </div>
      <div class="form-row">
        <div class="form-group"><label>Operator / Airline</label><input type="text" id="fTransOp" placeholder="AirAsia" /></div>
        <div class="form-group"><label>Cost</label><input type="number" id="fTransCost" placeholder="0" /></div>
      </div>
      <div class="form-group"><label>Notes</label><textarea id="fTransNotes" placeholder="Seat numbers, terminal, baggage info..."></textarea></div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-ghost" onclick="closeModal('modalAddTransport')">Cancel</button>
      <button class="btn btn-primary" onclick="saveTransport()">Save</button>
    </div>
  </div>
</div>

<!-- Add Expense -->
<div class="modal-overlay" id="modalAddExpense">
  <div class="modal">
    <div class="modal-head">
      <h2>Add Expense üí∏</h2>
      <button class="modal-close" onclick="closeModal('modalAddExpense')">‚úï</button>
    </div>
    <div class="modal-body">
      <div class="form-group"><label>Item</label><input type="text" id="fExpItem" placeholder="e.g. Dinner at Nishiki Market" /></div>
      <div class="form-row">
        <div class="form-group"><label>Category</label>
          <select id="fExpCat">
            <option>üçú Food</option><option>üèõÔ∏è Activity</option><option>‚úàÔ∏è Flight</option><option>üè® Accommodation</option><option>üöå Transport</option><option>üõçÔ∏è Shopping</option><option>üíä Health</option><option>üìå Other</option>
          </select>
        </div>
        <div class="form-group"><label>Date</label><input type="date" id="fExpDate" /></div>
      </div>
      <div class="form-row">
        <div class="form-group"><label>From Currency</label><select id="fExpFromCur"></select></div>
        <div class="form-group"><label>Amount In Source Currency</label><input type="number" id="fExpFromAmt" placeholder="0" /></div>
      </div>
      <div class="form-row">
        <div class="form-group"><label>To Currency</label><select id="fExpToCur"></select></div>
        <div class="form-group" style="display:flex;align-items:flex-end;">
          <button class="btn btn-secondary" type="button" style="width:100%;justify-content:center;" onclick="convertExpenseAmount()">Convert &amp; Fill Amount</button>
        </div>
      </div>
      <div id="expenseFxNote" style="font-size:12px;color:var(--mist);margin:-8px 0 12px;"></div>
      <div class="form-group"><label>Amount (Saved Currency)</label><input type="number" id="fExpAmt" placeholder="0" /></div>
      <div class="form-group"><label>Notes</label><textarea id="fExpNotes" placeholder="Optional notes..." style="min-height:60px;"></textarea></div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-ghost" onclick="closeModal('modalAddExpense')">Cancel</button>
      <button class="btn btn-primary" onclick="saveExpense()">Save</button>
    </div>
  </div>
</div>

<!-- Add Packing Item -->
<div class="modal-overlay" id="modalAddPacking">
  <div class="modal">
    <div class="modal-head">
      <h2>Add Packing Item üéí</h2>
      <button class="modal-close" onclick="closeModal('modalAddPacking')">‚úï</button>
    </div>
    <div class="modal-body">
      <div class="form-row">
        <div class="form-group"><label>Item Name</label><input type="text" id="fPackItem" placeholder="e.g. Rain jacket" /></div>
        <div class="form-group"><label>Category</label>
          <select id="fPackCat">
            <option>üëï Clothing</option><option>üîå Electronics</option><option>üíä Health</option><option>üìÑ Documents</option><option>üß¥ Toiletries</option><option>üìå Other</option>
          </select>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-ghost" onclick="closeModal('modalAddPacking')">Cancel</button>
      <button class="btn btn-primary" onclick="savePacking()">Add Item</button>
    </div>
  </div>
</div>

<!-- Toast container -->
<div class="toast-container" id="toastContainer"></div>

<script>
// ‚îÄ‚îÄ‚îÄ State ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let sbClient = null;
let currentTripId = null;
let currentTripData = null;
let currency = 'MYR';
const expandedDayIds = new Set();
let itineraryCategoryFilter = 'all';
let activityFxDirection = 'from';
let syncInProgress = false;
let offlineReadNotified = false;
let loadDaysToken = 0;
let sidebarCollapsed = false;
let currentUser = null;
let authMode = 'signin';
let authSubscription = null;
let userScopeColumnAvailable = null;
let tableScopeSupport = {};
let scopeDetectedForUserId = null;

const DEFAULT_SUPABASE_URL = window.__VOYAGEUR_SUPABASE_URL || 'https://usnqzrkwwxhafuxidxlq.supabase.co';
const DEFAULT_SUPABASE_ANON_KEY = window.__VOYAGEUR_SUPABASE_ANON_KEY || 'sb_publishable_h6fEKv_SWz5Z_laFKOVsEw_CxfJZRsu';
const ENABLE_USER_SCOPE = window.__VOYAGEUR_ENABLE_USER_SCOPE !== false;
const ACCESS_MODE = String(window.__VOYAGEUR_ACCESS_MODE || 'shared').toLowerCase() === 'private' ? 'private' : 'shared';
const FX_API_BASE = 'https://api.frankfurter.dev/v1';
const FX_CURRENCIES = ['AED','AUD','BGN','BRL','CAD','CHF','CNY','CZK','DKK','EUR','GBP','HKD','HUF','IDR','ILS','INR','ISK','JPY','KRW','MXN','MYR','NOK','NZD','PHP','PLN','RON','SEK','SGD','THB','TRY','USD','ZAR'];
const FX_RATE_CACHE_PREFIX = 'voyageur_fx_rate_v1';
const OFFLINE_CACHE_KEY = 'voyageur_offline_cache_v1';
const OFFLINE_QUEUE_KEY = 'voyageur_sync_queue_v1';
const SIDEBAR_COLLAPSE_KEY = 'voyageur_sidebar_collapsed_v1';
const DB_TABLES = ['trips', 'days', 'activities', 'accommodations', 'transports', 'expenses', 'packing'];
let offlineCache = createEmptyCache();
let syncQueue = [];

// ‚îÄ‚îÄ‚îÄ Config ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function initApp() {
  bindConnectivityEvents();
  initSidebarState();

  currency = localStorage.getItem('def_currency') || 'MYR';
  const url = DEFAULT_SUPABASE_URL;
  const key = DEFAULT_SUPABASE_ANON_KEY;

  try {
    if (window.supabase?.createClient) {
      sbClient = window.supabase.createClient(url, key);
    }
    if (!sbClient) {
      showAuthGate();
      setAuthError('Supabase client unavailable. Please check script loading.');
      return;
    }
    initAuthFlow();
  } catch (e) {
    console.error(e);
    showAuthGate();
    setAuthError('App initialization failed. Refresh and try again.');
  }
}

function launchApp() {
  document.getElementById('mainApp').style.display = 'flex';
  hideAuthGate();
  document.getElementById('settingsCurrency').value = currency;
  renderAccountInfo();
  loadDashboard();
}

function saveCurrencyPref() {
  currency = document.getElementById('settingsCurrency').value;
  localStorage.setItem('def_currency', currency);
}

function escapeHtml(value) {
  return String(value ?? '')
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;')
    .replace(/'/g, '&#39;');
}

function escapeJsString(value) {
  return String(value ?? '')
    .replace(/\\/g, '\\\\')
    .replace(/'/g, "\\'")
    .replace(/\r/g, '\\r')
    .replace(/\n/g, '\\n')
    .replace(/</g, '\\x3c')
    .replace(/>/g, '\\x3e');
}

function safeText(value) { return escapeHtml(value); }
function safeJsArg(value) { return escapeJsString(value); }
function makeDomId(prefix, value) {
  return `${prefix}${String(value ?? '').replace(/[^a-zA-Z0-9_-]/g, '_')}`;
}
function normalizeActivityCategory(value) {
  const cat = String(value || 'other').toLowerCase();
  return ['food', 'attraction', 'transport', 'hotel', 'other'].includes(cat) ? cat : 'other';
}

function scopedStorageKey(base) {
  return `${base}_${currentUser?.id || 'anon'}`;
}

function requireAuthSession() {
  if (currentUser) return true;
  showAuthGate();
  return false;
}

function hasUserScope(table) {
  return ACCESS_MODE === 'private' && !!currentUser && tableScopeSupport[table] === true;
}

function shouldAttachUserId(table) {
  return !!currentUser && tableScopeSupport[table] === true;
}

function withUserScopePayload(table, payload, includeUserId = false) {
  if (!includeUserId || !shouldAttachUserId(table)) return { ...payload };
  return { ...payload, user_id: currentUser.id };
}

function applyUserScopeToQuery(query, table) {
  if (!hasUserScope(table)) return query;
  return query.eq('user_id', currentUser.id);
}

function applyUserScopeToMutation(query, table, id) {
  let q = query.eq('id', id);
  if (hasUserScope(table)) q = q.eq('user_id', currentUser.id);
  return q;
}

function setAuthError(message = '') {
  const el = document.getElementById('authError');
  if (!el) return;
  if (!message) {
    el.textContent = '';
    el.classList.remove('show');
    return;
  }
  el.textContent = message;
  el.classList.add('show');
}

function showAuthGate() {
  document.getElementById('authGate')?.classList.add('open');
  document.getElementById('mainApp').style.display = 'none';
}

function hideAuthGate() {
  document.getElementById('authGate')?.classList.remove('open');
}

function renderAccountInfo() {
  const email = currentUser?.email || 'Not signed in';
  const el = document.getElementById('settingsUserEmail');
  if (el) el.textContent = email;
}

function updateAuthModeUI() {
  const signIn = authMode === 'signin';
  const submit = document.getElementById('authSubmitBtn');
  const subtitle = document.getElementById('authSubtitle');
  const altText = document.getElementById('authAltText');
  const altBtn = document.getElementById('authAltBtn');
  const pass = document.getElementById('authPassword');
  if (submit) submit.textContent = signIn ? 'Sign In' : 'Create Account';
  if (subtitle) subtitle.textContent = signIn ? 'Sign in to access your trips' : 'Create your account to start planning';
  if (altText) altText.textContent = signIn ? 'No account yet?' : 'Already have an account?';
  if (altBtn) altBtn.textContent = signIn ? 'Create one' : 'Sign in';
  if (pass) pass.setAttribute('autocomplete', signIn ? 'current-password' : 'new-password');
  setAuthError('');
}

function toggleAuthMode() {
  authMode = authMode === 'signin' ? 'signup' : 'signin';
  updateAuthModeUI();
}

async function submitAuth() {
  if (!sbClient) return;
  const email = (document.getElementById('authEmail')?.value || '').trim();
  const password = document.getElementById('authPassword')?.value || '';
  if (!email || !password) {
    setAuthError('Email and password are required.');
    return;
  }

  const submitBtn = document.getElementById('authSubmitBtn');
  if (submitBtn) {
    submitBtn.disabled = true;
    submitBtn.textContent = authMode === 'signin' ? 'Signing In...' : 'Creating...';
  }

  try {
    if (authMode === 'signin') {
      const { error } = await sbClient.auth.signInWithPassword({ email, password });
      if (error) throw error;
      setAuthError('');
      return;
    }

    const { data, error } = await sbClient.auth.signUp({ email, password });
    if (error) throw error;
    if (!data?.session) {
      setAuthError('Account created. Check your email to confirm, then sign in.');
      authMode = 'signin';
      updateAuthModeUI();
    }
  } catch (error) {
    setAuthError(error?.message || 'Authentication failed.');
  } finally {
    if (submitBtn) {
      submitBtn.disabled = false;
      submitBtn.textContent = authMode === 'signin' ? 'Sign In' : 'Create Account';
    }
  }
}

async function signOutUser() {
  if (!sbClient) return;
  await sbClient.auth.signOut();
}

async function detectUserScopeCapability() {
  if (!sbClient || !currentUser) return;
  if (scopeDetectedForUserId === currentUser.id) return;

  tableScopeSupport = {};
  DB_TABLES.forEach(table => {
    tableScopeSupport[table] = ENABLE_USER_SCOPE;
  });
  userScopeColumnAvailable = ENABLE_USER_SCOPE;
  scopeDetectedForUserId = currentUser.id;

  if (!ENABLE_USER_SCOPE) {
    console.warn('User scope disabled. Set window.__VOYAGEUR_ENABLE_USER_SCOPE = true after user_id + RLS are configured.');
  } else if (ACCESS_MODE === 'shared') {
    console.info('Shared mode enabled: authenticated users can see/edit shared data based on RLS policies.');
  }
}

async function applySessionState(session) {
  const previousUserId = currentUser?.id || null;
  currentUser = session?.user || null;
  renderAccountInfo();

  if (!currentUser) {
    currentTripId = null;
    currentTripData = null;
    offlineCache = createEmptyCache();
    syncQueue = [];
    tableScopeSupport = {};
    scopeDetectedForUserId = null;
    userScopeColumnAvailable = null;
    showAuthGate();
    updateSyncStatusBadge();
    return;
  }

  if (previousUserId !== currentUser.id) {
    loadOfflineState();
  }
  await detectUserScopeCapability();
  launchApp();
  updateSyncStatusBadge();
  syncPendingOperations();
}

async function initAuthFlow() {
  updateAuthModeUI();
  const { data, error } = await sbClient.auth.getSession();
  if (error) setAuthError(error.message || 'Unable to read session');
  await applySessionState(data?.session || null);

  if (!authSubscription) {
    const { data: subData } = sbClient.auth.onAuthStateChange((_event, session) => {
      applySessionState(session).catch(err => {
        console.error('Session state update failed', err);
      });
    });
    authSubscription = subData?.subscription || null;
  }
}

function applySidebarState(collapsed) {
  sidebarCollapsed = !!collapsed;
  const app = document.getElementById('mainApp');
  if (app) app.classList.toggle('sidebar-collapsed', sidebarCollapsed);

  const toggleBtn = document.getElementById('sidebarToggleBtn');
  if (toggleBtn) {
    toggleBtn.textContent = sidebarCollapsed ? '‚ò∞' : '‚ò∑';
    toggleBtn.setAttribute('aria-label', sidebarCollapsed ? 'Expand sidebar' : 'Collapse sidebar');
    toggleBtn.title = sidebarCollapsed ? 'Expand sidebar' : 'Collapse sidebar';
  }

  const wordmark = document.getElementById('sidebarWordmark');
  if (wordmark) {
    const full = wordmark.getAttribute('data-full') || 'Voyageur';
    const short = wordmark.getAttribute('data-short') || 'V';
    wordmark.textContent = sidebarCollapsed ? short : full;
  }
}

function initSidebarState() {
  if (window.innerWidth <= 980) {
    applySidebarState(true);
    return;
  }
  const saved = localStorage.getItem(SIDEBAR_COLLAPSE_KEY);
  applySidebarState(saved === null ? false : saved === '1');
}

function toggleSidebar() {
  const next = !sidebarCollapsed;
  applySidebarState(next);
  if (window.innerWidth <= 980) return;
  localStorage.setItem(SIDEBAR_COLLAPSE_KEY, next ? '1' : '0');
}

function closeSidebarOnMobile() {
  if (window.innerWidth > 980 || sidebarCollapsed) return;
  applySidebarState(true);
}

// ‚îÄ‚îÄ‚îÄ Offline helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function createEmptyCache() {
  const initial = {};
  DB_TABLES.forEach(table => { initial[table] = []; });
  return initial;
}

function ensureCacheTable(table) {
  if (!Array.isArray(offlineCache[table])) offlineCache[table] = [];
}

function persistOfflineCache() {
  localStorage.setItem(scopedStorageKey(OFFLINE_CACHE_KEY), JSON.stringify(offlineCache));
}

function persistSyncQueue() {
  localStorage.setItem(scopedStorageKey(OFFLINE_QUEUE_KEY), JSON.stringify(syncQueue));
}

function loadOfflineState() {
  try {
    const parsedCache = JSON.parse(localStorage.getItem(scopedStorageKey(OFFLINE_CACHE_KEY)) || '{}');
    const parsedQueue = JSON.parse(localStorage.getItem(scopedStorageKey(OFFLINE_QUEUE_KEY)) || '[]');
    offlineCache = createEmptyCache();
    DB_TABLES.forEach(table => {
      offlineCache[table] = Array.isArray(parsedCache[table]) ? parsedCache[table] : [];
    });
    syncQueue = Array.isArray(parsedQueue) ? parsedQueue : [];
  } catch (error) {
    console.error('Offline state parse failed', error);
    offlineCache = createEmptyCache();
    syncQueue = [];
  }
}

function isOnline() {
  return navigator.onLine;
}

function getFxCacheKey(fromCurrency, toCurrency) {
  return `${FX_RATE_CACHE_PREFIX}_${fromCurrency}_${toCurrency}`;
}

function saveFxRate(fromCurrency, toCurrency, rate, date) {
  if (!Number.isFinite(rate)) return;
  const payload = { rate, date: date || new Date().toISOString().slice(0, 10), saved_at: new Date().toISOString() };
  localStorage.setItem(getFxCacheKey(fromCurrency, toCurrency), JSON.stringify(payload));
}

function loadFxRate(fromCurrency, toCurrency) {
  try {
    const raw = localStorage.getItem(getFxCacheKey(fromCurrency, toCurrency));
    if (!raw) return null;
    const parsed = JSON.parse(raw);
    const rate = Number(parsed?.rate);
    if (!Number.isFinite(rate) || rate <= 0) return null;
    return { rate, date: parsed?.date || '', saved_at: parsed?.saved_at || '' };
  } catch (_) {
    return null;
  }
}

function formatFxNote(fromCurrency, toCurrency, result) {
  const suffix = result.cached ? `${result.date || 'cached'} ¬∑ cached` : (result.date || 'live');
  return `1 ${fromCurrency} = ${result.rate.toFixed(6)} ${toCurrency} (${suffix})`;
}

function updateSyncStatusBadge() {
  const badge = document.getElementById('syncStatusBadge');
  if (!badge) return;
  const pending = syncQueue.length;
  badge.classList.remove('online', 'offline', 'syncing');

  if (syncInProgress) {
    badge.classList.add('syncing');
    badge.textContent = pending ? `Syncing ${pending}...` : 'Syncing...';
    return;
  }
  if (!isOnline()) {
    badge.classList.add('offline');
    badge.textContent = pending ? `Offline ¬∑ ${pending} pending` : 'Offline';
    return;
  }
  if (pending > 0) {
    badge.classList.add('syncing');
    badge.textContent = `Online ¬∑ ${pending} pending`;
  } else {
    badge.classList.add('online');
    badge.textContent = 'Online';
  }
}

function bindConnectivityEvents() {
  window.addEventListener('online', () => {
    offlineReadNotified = false;
    updateSyncStatusBadge();
    toast('Back online. Syncing changes...');
    syncPendingOperations();
  });
  window.addEventListener('offline', () => {
    updateSyncStatusBadge();
    toast('Offline mode: changes will sync later', 'error');
  });
}

function isNetworkError(error) {
  const message = String(error?.message || error || '').toLowerCase();
  return message.includes('failed to fetch')
    || message.includes('networkerror')
    || message.includes('network error')
    || message.includes('load failed')
    || message.includes('offline');
}

function makeClientId() {
  if (window.crypto?.randomUUID) return window.crypto.randomUUID();
  return `id_${Date.now()}_${Math.random().toString(16).slice(2, 10)}`;
}

function sortedByCreatedAt(rows) {
  return [...rows].sort((a, b) => String(a?.created_at || '').localeCompare(String(b?.created_at || '')));
}

function filterRows(rows, filters = {}) {
  const entries = Object.entries(filters);
  if (!entries.length) return sortedByCreatedAt(rows);
  return sortedByCreatedAt(rows.filter(row => entries.every(([k, v]) => row?.[k] === v)));
}

function upsertCachedRow(table, row) {
  ensureCacheTable(table);
  const nextRow = { created_at: new Date().toISOString(), ...row };
  if (!nextRow.id) nextRow.id = makeClientId();
  const idx = offlineCache[table].findIndex(item => item.id === nextRow.id);
  if (idx === -1) offlineCache[table].push(nextRow);
  else offlineCache[table][idx] = { ...offlineCache[table][idx], ...nextRow };
  persistOfflineCache();
  return nextRow;
}

function replaceCachedTable(table, rows) {
  ensureCacheTable(table);
  offlineCache[table] = sortedByCreatedAt((rows || []).map(row => ({ created_at: new Date().toISOString(), ...row })));
  persistOfflineCache();
}

function mergeCachedRows(table, rows) {
  ensureCacheTable(table);
  const map = new Map(offlineCache[table].map(row => [row.id, row]));
  (rows || []).forEach(row => {
    if (!row?.id) return;
    map.set(row.id, { created_at: new Date().toISOString(), ...(map.get(row.id) || {}), ...row });
  });
  offlineCache[table] = sortedByCreatedAt(Array.from(map.values()));
  persistOfflineCache();
}

function updateCachedRow(table, id, patch) {
  ensureCacheTable(table);
  const idx = offlineCache[table].findIndex(item => item.id === id);
  if (idx === -1) {
    const created = { id, created_at: new Date().toISOString(), ...patch };
    offlineCache[table].push(created);
    persistOfflineCache();
    return created;
  }
  offlineCache[table][idx] = { ...offlineCache[table][idx], ...patch };
  persistOfflineCache();
  return offlineCache[table][idx];
}

function removeCachedRow(table, id) {
  ensureCacheTable(table);
  const idx = offlineCache[table].findIndex(item => item.id === id);
  if (idx === -1) return null;
  const [removed] = offlineCache[table].splice(idx, 1);
  persistOfflineCache();
  return removed;
}

function getCachedById(table, id) {
  ensureCacheTable(table);
  return offlineCache[table].find(item => item.id === id) || null;
}

function getCachedRows(table, filters = {}) {
  ensureCacheTable(table);
  return filterRows(offlineCache[table], filters);
}

function applyQueuedOpsToRows(table, baseRows) {
  const map = new Map((baseRows || []).map(row => [row.id, { ...row }]));
  for (const op of syncQueue) {
    if (op.table !== table) continue;
    if (op.op === 'insert') {
      map.set(op.id, { ...(map.get(op.id) || {}), ...(op.payload || { id: op.id }) });
      continue;
    }
    if (op.op === 'update') {
      map.set(op.id, { ...(map.get(op.id) || { id: op.id }), ...(op.payload || {}) });
      continue;
    }
    if (op.op === 'delete') map.delete(op.id);
  }
  return sortedByCreatedAt(Array.from(map.values()));
}

function enqueueSyncOperation(op) {
  if (!op || !op.table || !op.id || !op.op) return;

  if (op.op === 'update') {
    for (let i = syncQueue.length - 1; i >= 0; i--) {
      const existing = syncQueue[i];
      if (existing.table !== op.table || existing.id !== op.id) continue;
      if (existing.op === 'insert' || existing.op === 'update') {
        existing.payload = { ...(existing.payload || {}), ...(op.payload || {}) };
        persistSyncQueue();
        updateSyncStatusBadge();
        return;
      }
      if (existing.op === 'delete') {
        updateSyncStatusBadge();
        return;
      }
    }
  }

  if (op.op === 'delete') {
    for (let i = syncQueue.length - 1; i >= 0; i--) {
      const existing = syncQueue[i];
      if (existing.table !== op.table || existing.id !== op.id) continue;
      if (existing.op === 'insert' || existing.op === 'update') {
        syncQueue.splice(i, 1);
      } else if (existing.op === 'delete') {
        persistSyncQueue();
        updateSyncStatusBadge();
        return;
      }
    }
  }

  syncQueue.push({ ...op, queued_at: new Date().toISOString() });
  persistSyncQueue();
  updateSyncStatusBadge();
}

async function syncPendingOperations() {
  if (!sbClient || !currentUser || !isOnline() || syncInProgress || !syncQueue.length) {
    updateSyncStatusBadge();
    return;
  }

  syncInProgress = true;
  updateSyncStatusBadge();

  let synced = 0;
  while (syncQueue.length) {
    const item = syncQueue[0];
    try {
      if (item.op === 'insert') {
        const payload = withUserScopePayload(item.table, item.payload || {}, true);
        const { error } = await sbClient.from(item.table).upsert(payload, { onConflict: 'id' });
        if (error) throw error;
      } else if (item.op === 'update') {
        const payload = withUserScopePayload(item.table, item.payload || {});
        const mutation = applyUserScopeToMutation(sbClient.from(item.table).update(payload), item.table, item.id);
        const { error } = await mutation;
        if (error) throw error;
      } else if (item.op === 'delete') {
        const mutation = applyUserScopeToMutation(sbClient.from(item.table).delete(), item.table, item.id);
        const { error } = await mutation;
        if (error) throw error;
      }
      syncQueue.shift();
      synced++;
      persistSyncQueue();
      updateSyncStatusBadge();
    } catch (error) {
      if (isNetworkError(error)) break;
      console.error('Sync failed for queued op', item, error);
      syncQueue.shift();
      persistSyncQueue();
      toast(`Skipped 1 invalid queued change (${item.table})`, 'error');
      updateSyncStatusBadge();
    }
  }

  syncInProgress = false;
  updateSyncStatusBadge();
  if (synced > 0) toast(`Synced ${synced} change(s)`);
}

// ‚îÄ‚îÄ‚îÄ DB helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function dbQuery(table, filters = {}) {
  if (!requireAuthSession()) return [];
  if (sbClient && isOnline()) {
    try {
      let q = applyUserScopeToQuery(sbClient.from(table).select('*'), table);
      for (const [k, v] of Object.entries(filters)) q = q.eq(k, v);
      const { data, error } = await q.order('created_at', { ascending: true });
      if (error) throw error;
      offlineReadNotified = false;
      const rows = applyQueuedOpsToRows(table, data || []);
      if (Object.keys(filters).length === 0) replaceCachedTable(table, rows);
      else mergeCachedRows(table, rows);
      return getCachedRows(table, filters);
    } catch (error) {
      if (!isNetworkError(error)) {
        console.error(error);
        toast('DB error: ' + error.message, 'error');
      } else if (!offlineReadNotified) {
        toast('Offline mode: showing cached data', 'error');
        offlineReadNotified = true;
      }
    }
  }
  return getCachedRows(table, filters);
}

async function dbGetById(table, id) {
  if (!requireAuthSession()) return null;
  const cached = getCachedById(table, id);
  const hasQueuedDelete = syncQueue.some(op => op.table === table && op.id === id && op.op === 'delete');
  if (hasQueuedDelete) return null;
  const hasQueuedLocal = syncQueue.some(op => op.table === table && op.id === id && op.op !== 'delete');
  if (cached && hasQueuedLocal) return cached;

  if (sbClient && isOnline()) {
    try {
      let q = applyUserScopeToQuery(sbClient.from(table).select('*'), table).eq('id', id);
      const { data, error } = await q.single();
      if (error) throw error;
      const rows = applyQueuedOpsToRows(table, data ? [data] : []);
      const row = rows.find(item => item.id === id) || null;
      if (row) upsertCachedRow(table, row);
      return row;
    } catch (error) {
      if (!isNetworkError(error)) toast('DB error: ' + error.message, 'error');
    }
  }
  return cached;
}

async function dbInsert(table, obj) {
  if (!requireAuthSession()) return null;
  const localPayload = withUserScopePayload(table, obj || {}, true);
  const localRow = upsertCachedRow(table, { ...localPayload, id: localPayload?.id || makeClientId() });
  if (!sbClient || !isOnline()) {
    enqueueSyncOperation({ op: 'insert', table, id: localRow.id, payload: localRow });
    return localRow;
  }

  try {
    const payload = withUserScopePayload(table, localRow, true);
    const { data, error } = await sbClient.from(table).upsert(payload, { onConflict: 'id' }).select().single();
    if (error) throw error;
    if (data) upsertCachedRow(table, data);
    return data || localRow;
  } catch (error) {
    if (isNetworkError(error)) {
      enqueueSyncOperation({ op: 'insert', table, id: localRow.id, payload: localRow });
      updateSyncStatusBadge();
      return localRow;
    }
    removeCachedRow(table, localRow.id);
    toast('DB error: ' + error.message, 'error');
    return null;
  }
}

async function dbDelete(table, id) {
  if (!requireAuthSession()) return false;
  const backup = getCachedById(table, id);
  removeCachedRow(table, id);

  if (!sbClient || !isOnline()) {
    enqueueSyncOperation({ op: 'delete', table, id });
    return true;
  }

  try {
    const mutation = applyUserScopeToMutation(sbClient.from(table).delete(), table, id);
    const { error } = await mutation;
    if (error) throw error;
    return true;
  } catch (error) {
    if (isNetworkError(error)) {
      enqueueSyncOperation({ op: 'delete', table, id });
      updateSyncStatusBadge();
      return true;
    }
    if (backup) upsertCachedRow(table, backup);
    toast('Delete error: ' + error.message, 'error');
    return false;
  }
}

async function dbUpdate(table, id, obj) {
  if (!requireAuthSession()) return false;
  const backup = getCachedById(table, id);
  const localPatch = withUserScopePayload(table, obj || {});
  updateCachedRow(table, id, localPatch);

  if (!sbClient || !isOnline()) {
    enqueueSyncOperation({ op: 'update', table, id, payload: localPatch });
    return true;
  }

  try {
    const mutation = applyUserScopeToMutation(sbClient.from(table).update(localPatch), table, id);
    const { error } = await mutation;
    if (error) throw error;
    return true;
  } catch (error) {
    if (isNetworkError(error)) {
      enqueueSyncOperation({ op: 'update', table, id, payload: localPatch });
      updateSyncStatusBadge();
      return true;
    }
    if (backup) upsertCachedRow(table, backup);
    toast('Update error: ' + error.message, 'error');
    return false;
  }
}

// ‚îÄ‚îÄ‚îÄ Navigation ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function showPanel(name) {
  closeSidebarOnMobile();
  document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
  document.querySelector(`#panel-${name}`)?.classList.add('active');
  document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
  const panelTitles = { dashboard:'Dashboard', considerations:'What to Consider', settings:'Settings' };
  document.getElementById('topbarTitle').textContent = panelTitles[name] || 'Dashboard';
  const acts = document.getElementById('topbarActions');
  acts.innerHTML = name === 'dashboard' ? '<button class="btn btn-primary" onclick="openNewTripModal()">+ New Trip</button>' : '';
  if (name === 'dashboard') { document.querySelector('.nav-item').classList.add('active'); loadDashboard(); }
  if (name === 'considerations') { document.querySelectorAll('.nav-item')[1].classList.add('active'); }
  if (name === 'settings') { document.querySelectorAll('.nav-item')[2].classList.add('active'); }
}

function switchTab(name) {
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.tab-panel').forEach(t => t.classList.remove('active'));
  document.querySelector(`.tab[onclick="switchTab('${name}')"]`)?.classList.add('active');
  document.getElementById(`tab-${name}`)?.classList.add('active');
  if (name === 'itinerary') loadDays();
  if (name === 'accommodation') loadAccom();
  if (name === 'transport') loadTransport();
  if (name === 'budget') loadBudget();
  if (name === 'packing') loadPacking();
}

// ‚îÄ‚îÄ‚îÄ Dashboard ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function loadDashboard() {
  const trips = await dbQuery('trips');
  renderSidebar(trips);
  renderTripsGrid(trips);
}

function renderSidebar(trips) {
  const el = document.getElementById('sidebarTrips');
  if (!trips.length) { el.innerHTML = '<div style="padding:8px 12px;font-size:13px;color:rgba(255,255,255,0.3);font-style:italic;">No trips yet</div>'; return; }
  el.innerHTML = trips.map(t => `
    <div class="trip-chip ${t.id === currentTripId ? 'active' : ''}" onclick="openTrip('${safeJsArg(t.id)}')">
      <span class="dot"></span>${safeText(t.flag || '')} ${safeText(t.name || 'Untitled Trip')}
    </div>`).join('');
}

function renderTripsGrid(trips) {
  const el = document.getElementById('tripsGrid');
  if (!trips.length) {
    el.innerHTML = `<div class="empty-state"><div class="e-icon">‚úàÔ∏è</div><h3>No trips yet</h3><p>Create your first trip to start planning your adventure.</p><button class="btn btn-primary" onclick="openNewTripModal()">Create a Trip</button></div>`;
    return;
  }
  el.innerHTML = trips.map(t => {
    const days = t.end_date && t.start_date ? Math.ceil((new Date(t.end_date)-new Date(t.start_date))/(1000*60*60*24))+1 : '?';
    return `<div class="trip-card" onclick="openTrip('${safeJsArg(t.id)}')">
      <div class="trip-card-banner">
        <div class="trip-card-flag">${safeText(t.flag || 'üåç')}</div>
        <div class="trip-card-dest">${safeText(t.destination || 'Unknown destination')}</div>
      </div>
      <div class="trip-card-body">
        <div class="trip-card-name">${safeText(t.name || 'Untitled Trip')}</div>
        <div class="trip-card-dates">${formatDate(t.start_date)} ‚Üí ${formatDate(t.end_date)}</div>
      </div>
      <div class="trip-card-footer">
        <span class="badge badge-forest">${days} days</span>
        <span class="badge badge-gold">${safeText(t.currency || currency)} ${Number(t.budget||0).toLocaleString()}</span>
      </div>
    </div>`;
  }).join('');
}

// ‚îÄ‚îÄ‚îÄ Trip Detail ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function openTrip(tripId) {
  closeSidebarOnMobile();
  currentTripId = tripId;
  expandedDayIds.clear();
  itineraryCategoryFilter = 'all';
  const trips = await dbQuery('trips');
  currentTripData = trips.find(t => t.id === tripId);
  if (!currentTripData) return;

  const days = currentTripData.end_date && currentTripData.start_date
    ? Math.ceil((new Date(currentTripData.end_date)-new Date(currentTripData.start_date))/(1000*60*60*24))+1
    : '?';
  const safeTripId = safeJsArg(tripId);

  document.getElementById('tripHeader').innerHTML = `
    <div>
      <div class="trip-header-eyebrow">${safeText(currentTripData.destination)}</div>
      <div class="trip-header-title">${safeText(currentTripData.flag||'üåç')} ${safeText(currentTripData.name || 'Untitled Trip')}</div>
      <div class="trip-header-meta">${formatDate(currentTripData.start_date)} ‚Üí ${formatDate(currentTripData.end_date)} ¬∑ <span>${days} days</span></div>
      ${currentTripData.notes ? `<div class="trip-header-note">${safeText(currentTripData.notes)}</div>` : ''}
    </div>
    <div class="trip-header-actions">
      <button class="btn btn-primary" onclick="openAddDayModal()">+ Add Day</button>
      <button class="btn btn-ghost" style="color:#fff;border-color:rgba(255,255,255,0.25);" onclick="openEditTripModal('${safeTripId}')">‚úé Edit</button>
      <button class="btn btn-ghost" style="color:#fff;border-color:rgba(255,255,255,0.25);" onclick="deleteTrip('${safeTripId}')">üóë Delete</button>
    </div>`;

  document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
  document.getElementById('panel-trip').classList.add('active');
  document.getElementById('topbarTitle').textContent = currentTripData.name;
  document.getElementById('topbarActions').innerHTML = '';

  // Reset tabs
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.tab-panel').forEach(t => t.classList.remove('active'));
  const firstTab = document.querySelector('.tab');
  if (firstTab) firstTab.classList.add('active');
  document.getElementById('tab-itinerary').classList.add('active');

  renderSidebar(trips);
  loadDays();
}

async function deleteTrip(id) {
  if (!confirm('Delete this trip and all its data?')) return;
  const dayRows = await dbQuery('days', { trip_id: id });
  for (const day of dayRows) {
    const dayActivities = await dbQuery('activities', { day_id: day.id });
    for (const activity of dayActivities) await dbDelete('activities', activity.id);
  }
  const activitiesByTrip = await dbQuery('activities', { trip_id: id });
  for (const activity of activitiesByTrip) await dbDelete('activities', activity.id);
  for (const day of dayRows) await dbDelete('days', day.id);

  const dependentTables = ['accommodations', 'transports', 'expenses', 'packing'];
  for (const table of dependentTables) {
    const rows = await dbQuery(table, { trip_id: id });
    for (const row of rows) await dbDelete(table, row.id);
  }
  await dbDelete('trips', id);
  if (currentTripId === id) {
    currentTripId = null;
    currentTripData = null;
  }
  toast('Trip deleted');
  showPanel('dashboard');
}

// ‚îÄ‚îÄ‚îÄ Days & Activities ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function loadDays() {
  const requestToken = ++loadDaysToken;
  const [days, tripActivitiesRaw] = await Promise.all([
    dbQuery('days', { trip_id: currentTripId }),
    dbQuery('activities', { trip_id: currentTripId })
  ]);
  if (requestToken !== loadDaysToken) return;

  days.sort((a,b) => (a.day_number||0) - (b.day_number||0));
  const container = document.getElementById('daysContainer');
  updateItineraryFilterUI();

  if (!days.length) {
    container.innerHTML = `<div class="empty-state"><div class="e-icon">üìÖ</div><h3>No days added yet</h3><p>Start building your day-by-day itinerary.</p></div>`;
    return;
  }

  const dayIdSet = new Set(days.map(d => d.id));
  let tripActivities = tripActivitiesRaw.filter(a => dayIdSet.has(a.day_id));
  if (!tripActivities.length && dayIdSet.size) {
    const allActivities = await dbQuery('activities');
    if (requestToken !== loadDaysToken) return;
    tripActivities = allActivities.filter(a => dayIdSet.has(a.day_id));
  }

  const activitiesByDay = new Map();
  for (const activity of tripActivities) {
    if (!activitiesByDay.has(activity.day_id)) activitiesByDay.set(activity.day_id, []);
    activitiesByDay.get(activity.day_id).push(activity);
  }
  for (const list of activitiesByDay.values()) {
    list.sort((a, b) => (a.time || '').localeCompare(b.time || ''));
  }

  let html = '';
  const catIcon = { food:'üçú', attraction:'üèõÔ∏è', transport:'üöå', hotel:'üè®', other:'üìå' };
  for (const day of days) {
    const allActivities = activitiesByDay.get(day.id) || [];
    const activities = itineraryCategoryFilter === 'all'
      ? allActivities
      : allActivities.filter(a => a.category === itineraryCategoryFilter);
    if (itineraryCategoryFilter !== 'all' && activities.length === 0) continue;

    const isCollapsed = !expandedDayIds.has(day.id);
    const dayId = String(day.id || '');
    const dayDomId = makeDomId('dayCard-', dayId);
    const dayJsId = safeJsArg(dayId);
    const dayNumberLabel = Number(day.day_number) || 0;
    html += `<div class="day-card ${isCollapsed ? 'collapsed' : ''}" id="${dayDomId}">
      <div class="day-card-head" onclick="toggleDayCollapse('${dayJsId}')">
        <div class="day-head-main">
          <div class="day-toggle">${isCollapsed ? '‚ñ∏' : '‚ñæ'}</div>
          <div>
            <div class="day-label">Day ${dayNumberLabel} ¬∑ ${formatDate(day.date)}</div>
            <div class="day-title">${safeText(day.title || 'Untitled Day')}</div>
          </div>
        </div>
        <div class="day-head-actions">
          <button class="btn btn-sm" style="background:rgba(255,255,255,0.1);color:#fff;border:none;border-radius:6px;" onclick="event.stopPropagation(); openAddActivityModal('${dayJsId}')">+ Activity</button>
          <button class="btn-icon" style="background:rgba(255,255,255,0.07);color:rgba(255,255,255,0.5);border:none;border-radius:6px;font-size:13px;" onclick="event.stopPropagation(); deleteDay('${dayJsId}')">üóë</button>
        </div>
      </div>
      <div class="day-card-body">`;

    if (!activities.length) {
      html += `<div style="padding:20px;text-align:center;color:var(--mist);font-size:14px;font-style:italic;">No activities yet ¬∑ click "+ Activity"</div>`;
    } else {
      for (const a of activities) {
        const cat = normalizeActivityCategory(a.category);
        html += `<div class="activity-row">
          <div class="activity-time">${safeText(a.time || '--:--')}</div>
          <div class="activity-dot cat-${cat}">${catIcon[cat]||'üìå'}</div>
          <div class="activity-info">
            <div class="activity-title">${safeText(a.title || 'Untitled Activity')}</div>
            ${a.description ? `<div class="activity-desc">${safeText(a.description)}</div>` : ''}
            <div class="activity-meta">
              ${a.location ? `<span class="activity-location">üìç ${safeText(a.location)}</span>` : ''}
              ${a.cost ? `<span class="activity-cost">${safeText(currentTripData?.currency||currency)} ${Number(a.cost).toLocaleString()}</span>` : ''}
            </div>
          </div>
          <div class="activity-actions">
            <button class="btn btn-sm btn-secondary" onclick="openEditActivityModal('${safeJsArg(a.id)}')">Edit</button>
            <button class="btn btn-sm btn-danger" onclick="deleteActivity('${safeJsArg(a.id)}')">Remove</button>
          </div>
        </div>`;
      }
    }
    html += `</div></div>`;
  }
  if (!html) {
    container.innerHTML = `<div class="empty-state"><div class="e-icon">üîé</div><h3>No activities in this category</h3><p>Choose another category filter or add an activity.</p></div>`;
    return;
  }
  container.innerHTML = html;
}

function setItineraryFilter(category) {
  itineraryCategoryFilter = category;
  loadDays();
}

function updateItineraryFilterUI() {
  document.querySelectorAll('[data-itinerary-filter]').forEach(btn => {
    const active = btn.getAttribute('data-itinerary-filter') === itineraryCategoryFilter;
    btn.classList.toggle('active', active);
  });
}

function toggleDayCollapse(dayId) {
  const card = document.getElementById(makeDomId('dayCard-', dayId));
  if (!card) return;
  if (expandedDayIds.has(dayId)) {
    expandedDayIds.delete(dayId);
    card.classList.add('collapsed');
  } else {
    expandedDayIds.add(dayId);
    card.classList.remove('collapsed');
  }
  const toggle = card.querySelector('.day-toggle');
  if (toggle) toggle.textContent = expandedDayIds.has(dayId) ? '‚ñæ' : '‚ñ∏';
}

async function deleteDay(id) {
  if (!confirm('Delete this day and all its activities?')) return;
  const activities = await dbQuery('activities', { day_id: id });
  for (const activity of activities) await dbDelete('activities', activity.id);
  await dbDelete('days', id);
  expandedDayIds.delete(id);
  toast('Day removed'); loadDays();
}

async function deleteActivity(id) {
  await dbDelete('activities', id); loadDays();
}

// ‚îÄ‚îÄ‚îÄ Accommodation ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function loadAccom() {
  const rows = await dbQuery('accommodations', { trip_id: currentTripId });
  const el = document.getElementById('accomContainer');
  if (!rows.length) { el.innerHTML = `<div class="empty-state"><div class="e-icon">üè®</div><h3>No accommodation added</h3></div>`; return; }
  el.innerHTML = rows.map(r => `
    <div class="info-card">
      <div class="info-card-left">
        <h3>üè® ${safeText(r.name || 'Untitled')}</h3>
        <p>${safeText(r.address||'')}</p>
        <div class="info-card-meta">
          ${r.check_in?`<span class="meta-pill">Check-in: ${formatDate(r.check_in)}</span>`:''}
          ${r.check_out?`<span class="meta-pill">Check-out: ${formatDate(r.check_out)}</span>`:''}
          ${r.confirmation?`<span class="meta-pill">Conf: ${safeText(r.confirmation)}</span>`:''}
          ${r.cost?`<span class="meta-pill" style="color:var(--terracotta);">${safeText(currentTripData?.currency||currency)} ${Number(r.cost).toLocaleString()}</span>`:''}
        </div>
        ${r.notes?`<p style="margin-top:8px;font-size:13px;color:var(--mist);">${safeText(r.notes)}</p>`:''}
      </div>
      <button class="btn btn-danger btn-sm" onclick="deleteAccom('${safeJsArg(r.id)}')">Remove</button>
    </div>`).join('');
}

async function deleteAccom(id) { await dbDelete('accommodations',id); loadAccom(); }

// ‚îÄ‚îÄ‚îÄ Transport ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function loadTransport() {
  const rows = await dbQuery('transports', { trip_id: currentTripId });
  const el = document.getElementById('transportContainer');
  if (!rows.length) { el.innerHTML = `<div class="empty-state"><div class="e-icon">üöå</div><h3>No transport added</h3></div>`; return; }
  el.innerHTML = rows.map(r => `
    <div class="info-card">
      <div class="info-card-left">
        <h3>${safeText(r.type || 'Transport')}</h3>
        <p>${safeText(r.from_location || '')} ‚Üí ${safeText(r.to_location || '')}</p>
        <div class="info-card-meta">
          ${r.departure?`<span class="meta-pill">Dep: ${safeText(r.departure.replace('T',' '))}</span>`:''}
          ${r.arrival?`<span class="meta-pill">Arr: ${safeText(r.arrival.replace('T',' '))}</span>`:''}
          ${r.operator?`<span class="meta-pill">${safeText(r.operator)}</span>`:''}
          ${r.confirmation?`<span class="meta-pill">Conf: ${safeText(r.confirmation)}</span>`:''}
          ${r.cost?`<span class="meta-pill" style="color:var(--terracotta);">${safeText(currentTripData?.currency||currency)} ${Number(r.cost).toLocaleString()}</span>`:''}
        </div>
        ${r.notes?`<p style="margin-top:8px;font-size:13px;color:var(--mist);">${safeText(r.notes)}</p>`:''}
      </div>
      <button class="btn btn-danger btn-sm" onclick="deleteTransport('${safeJsArg(r.id)}')">Remove</button>
    </div>`).join('');
}
async function deleteTransport(id) { await dbDelete('transports',id); loadTransport(); }

// ‚îÄ‚îÄ‚îÄ Budget ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function loadBudget() {
  const expenses = await dbQuery('expenses', { trip_id: currentTripId });
  const budget = Number(currentTripData?.budget || 0);
  const spent = expenses.reduce((s,e) => s + Number(e.amount||0), 0);
  const pct = budget ? Math.min(100, Math.round(spent/budget*100)) : 0;
  const cur = currentTripData?.currency || currency;

  document.getElementById('budgetOverview').innerHTML = `
    <div class="budget-box">
      <div class="b-label">Total Budget</div>
      <div class="b-val">${safeText(cur)} ${budget.toLocaleString()}</div>
    </div>
    <div class="budget-box">
      <div class="b-label">Total Spent</div>
      <div class="b-val ${spent > budget ? 'over' : ''}">${safeText(cur)} ${spent.toLocaleString()}</div>
      <div class="progress-bar"><div class="progress-fill ${pct > 90 ? 'warn' : ''}" style="width:${pct}%"></div></div>
      <div style="font-size:12px;color:var(--mist);margin-top:6px;font-family:'DM Mono',monospace;">${pct}% used ¬∑ ${safeText(cur)} ${Math.max(0,budget-spent).toLocaleString()} remaining</div>
    </div>`;

  const tbody = document.getElementById('expenseBody');
  if (!expenses.length) { tbody.innerHTML = `<tr><td colspan="5" style="text-align:center;padding:32px;color:var(--mist);font-style:italic;">No expenses recorded yet</td></tr>`; return; }
  tbody.innerHTML = expenses.map(e => `
    <tr>
      <td data-label="Item">${safeText(e.item || '')}</td>
      <td data-label="Category">${safeText(e.category || '')}</td>
      <td data-label="Date">${formatDate(e.date)}</td>
      <td data-label="Amount" style="color:var(--terracotta);font-family:'DM Mono',monospace;">${safeText(cur)} ${Number(e.amount||0).toLocaleString()}</td>
      <td data-label="Action"><button class="btn btn-danger btn-sm" onclick="deleteExpense('${safeJsArg(e.id)}')">‚úï</button></td>
    </tr>`).join('');
}
async function deleteExpense(id) { await dbDelete('expenses',id); loadBudget(); }

// ‚îÄ‚îÄ‚îÄ Packing ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const packCategories = ['üìÑ Documents','üëï Clothing','üîå Electronics','üíä Health','üß¥ Toiletries','üìå Other'];
const defaultItems = {
  'üìÑ Documents': ['Passport','Visa/Entry docs','Travel insurance','Hotel confirmation','Flight tickets','Emergency contacts'],
  'üëï Clothing': ['T-shirts','Pants/Shorts','Underwear','Socks','Walking shoes','Light jacket','Swimwear'],
  'üîå Electronics': ['Phone charger','Power adapter','Portable charger','Camera','Headphones'],
  'üíä Health': ['Prescription meds','Paracetamol','Sunscreen','Insect repellent','Hand sanitizer','First aid kit'],
  'üß¥ Toiletries': ['Toothbrush & paste','Shampoo','Deodorant','Razor','Moisturiser'],
  'üìå Other': ['Reusable water bottle','Snacks','Umbrella','Books/Kindle','Travel pillow']
};

async function loadPacking() {
  let items = await dbQuery('packing', { trip_id: currentTripId });
  // Seed defaults if empty
  if (!items.length) {
    for (const [cat, list] of Object.entries(defaultItems)) {
      for (const item of list) {
        const row = await dbInsert('packing', { trip_id: currentTripId, item, category: cat, packed: false });
        if (row) items.push(row);
      }
    }
  }

  const grouped = {};
  for (const cat of packCategories) grouped[cat] = [];
  for (const i of items) { if (!grouped[i.category]) grouped[i.category] = []; grouped[i.category].push(i); }

  const el = document.getElementById('packingGrid');
  el.innerHTML = packCategories.map(cat => {
    const its = grouped[cat] || [];
    const done = its.filter(i=>i.packed).length;
    return `<div class="checklist-card">
      <h3>${safeText(cat)} <small style="font-size:12px;color:var(--mist);font-family:'DM Mono',monospace;">${done}/${its.length}</small></h3>
      ${its.map(i => `
        <div class="check-item ${i.packed?'checked':''}" onclick="togglePack('${safeJsArg(i.id)}',${!i.packed})">
          <input type="checkbox" ${i.packed?'checked':''} onchange="togglePack('${safeJsArg(i.id)}',this.checked)" onclick="event.stopPropagation()" />
          ${safeText(i.item)}
        </div>`).join('')}
    </div>`;
  }).join('');
}

async function togglePack(id, packed) {
  await dbUpdate('packing', id, { packed });
  loadPacking();
}

// ‚îÄ‚îÄ‚îÄ Modals ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function openModal(id) { document.getElementById(id).classList.add('open'); }
function closeModal(id) { document.getElementById(id).classList.remove('open'); }
document.querySelectorAll('.modal-overlay').forEach(m => m.addEventListener('click', e => { if (e.target === m) m.classList.remove('open'); }));

function closeTripModal() {
  closeModal('modalNewTrip');
  document.getElementById('fTripId').value = '';
}

function openNewTripModal() {
  document.getElementById('fTripId').value = '';
  document.getElementById('fTripName').value = '';
  document.getElementById('fTripDest').value = '';
  document.getElementById('fTripFlag').value = '';
  document.getElementById('fTripStart').value = '';
  document.getElementById('fTripEnd').value = '';
  document.getElementById('fTripBudget').value = '';
  document.getElementById('fTripCurrency').value = currency || 'MYR';
  document.getElementById('fTripNotes').value = '';
  document.getElementById('tripModalTitle').textContent = 'New Trip ‚úàÔ∏è';
  document.getElementById('tripModalSaveBtn').textContent = 'Create Trip';
  openModal('modalNewTrip');
}

async function openEditTripModal(tripId) {
  const trip = await dbGetById('trips', tripId);
  if (!trip) return;
  document.getElementById('fTripId').value = trip.id;
  document.getElementById('fTripName').value = trip.name || '';
  document.getElementById('fTripDest').value = trip.destination || '';
  document.getElementById('fTripFlag').value = trip.flag || '';
  document.getElementById('fTripStart').value = trip.start_date || '';
  document.getElementById('fTripEnd').value = trip.end_date || '';
  document.getElementById('fTripBudget').value = trip.budget || '';
  document.getElementById('fTripCurrency').value = trip.currency || currency || 'MYR';
  document.getElementById('fTripNotes').value = trip.notes || '';
  document.getElementById('tripModalTitle').textContent = 'Edit Trip';
  document.getElementById('tripModalSaveBtn').textContent = 'Save Changes';
  openModal('modalNewTrip');
}

function appendDestinationSeparator() {
  const input = document.getElementById('fTripDest');
  if (!input) return;
  const current = input.value.trim();
  if (!current) {
    input.focus();
    return;
  }
  input.value = current.endsWith('+') || current.endsWith(' +') ? current : `${current} + `;
  input.focus();
}

async function syncTripDaysToRange(tripId, startDate, endDate) {
  if (!startDate || !endDate) return { added: 0 };
  const start = new Date(`${startDate}T00:00:00Z`);
  const end = new Date(`${endDate}T00:00:00Z`);
  if (Number.isNaN(start.getTime()) || Number.isNaN(end.getTime()) || end < start) return { added: 0 };

  const existingDays = await dbQuery('days', { trip_id: tripId });
  const existingByDate = new Map();
  const existingByNumber = new Map();
  for (const day of existingDays) {
    if (day.date && !existingByDate.has(day.date)) existingByDate.set(day.date, day);
    if (day.day_number && !existingByNumber.has(day.day_number)) existingByNumber.set(day.day_number, day);
  }
  const usedDayIds = new Set();

  const dayMs = 24 * 60 * 60 * 1000;
  const count = Math.floor((end.getTime() - start.getTime()) / dayMs) + 1;
  let added = 0;

  for (let i = 0; i < count; i++) {
    const date = new Date(start.getTime() + (i * dayMs)).toISOString().slice(0, 10);
    const dayNumber = i + 1;
    const byDate = existingByDate.get(date);
    const byNumber = existingByNumber.get(dayNumber);
    const existing = (byDate && !usedDayIds.has(byDate.id))
      ? byDate
      : ((byNumber && !usedDayIds.has(byNumber.id)) ? byNumber : null);
    if (existing) {
      usedDayIds.add(existing.id);
      if ((existing.day_number || 0) !== dayNumber || existing.date !== date) {
        await dbUpdate('days', existing.id, { day_number: dayNumber, date });
      }
    } else {
      await dbInsert('days', {
        trip_id: tripId,
        day_number: dayNumber,
        date,
        title: `Day ${dayNumber}`,
        notes: ''
      });
      added++;
    }
  }

  return { added };
}

async function saveTrip() {
  const tripId = document.getElementById('fTripId').value;
  const name = document.getElementById('fTripName').value.trim();
  if (!name) { toast('Please enter a trip name', 'error'); return; }
  const obj = {
    name, destination: document.getElementById('fTripDest').value,
    flag: document.getElementById('fTripFlag').value,
    start_date: document.getElementById('fTripStart').value,
    end_date: document.getElementById('fTripEnd').value,
    budget: document.getElementById('fTripBudget').value || 0,
    currency: document.getElementById('fTripCurrency').value,
    notes: document.getElementById('fTripNotes').value
  };

  if (obj.start_date && obj.end_date && obj.end_date < obj.start_date) {
    toast('End date cannot be before start date', 'error');
    return;
  }

  if (tripId) {
    const ok = await dbUpdate('trips', tripId, obj);
    if (!ok) return;
    const { added } = await syncTripDaysToRange(tripId, obj.start_date, obj.end_date);
    closeTripModal();
    toast(added ? `Trip updated! ${added} day(s) added.` : 'Trip updated!');
    loadDashboard();
    openTrip(tripId);
    return;
  }

  const row = await dbInsert('trips', obj);
  if (!row) return;
  const { added } = await syncTripDaysToRange(row.id, obj.start_date, obj.end_date);
  closeTripModal();
  toast(added ? `Trip created! ${added} day(s) added.` : 'Trip created! ‚úàÔ∏è');
  loadDashboard();
  openTrip(row.id);
}

function openAddDayModal() { openModal('modalAddDay'); }

async function saveDay() {
  const title = document.getElementById('fDayTitle').value.trim();
  if (!title) { toast('Please enter a day title', 'error'); return; }
  const obj = {
    trip_id: currentTripId,
    day_number: parseInt(document.getElementById('fDayNum').value) || 1,
    date: document.getElementById('fDayDate').value,
    title, notes: document.getElementById('fDayNotes').value
  };
  await dbInsert('days', obj);
  closeModal('modalAddDay');
  toast('Day added!');
  ['fDayTitle','fDayNotes','fDayDate'].forEach(id => document.getElementById(id).value = '');
  loadDays();
}

function setActivityFxNote(message, isError = false) {
  const note = document.getElementById('activityFxNote');
  if (!note) return;
  note.textContent = message;
  note.style.color = isError ? 'var(--terracotta)' : 'var(--mist)';
}

function setActivityCostHint(targetCurrency) {
  const hint = document.getElementById('activityCostHint');
  if (!hint) return;
  hint.textContent = `Saved in ${targetCurrency}. Converter works both ways: edit Amount A or Amount B, then tap Convert.`;
}

function getActivityTargetCurrency() {
  return currentTripData?.currency || currency || 'MYR';
}

function setActivityFxDirection(direction) {
  activityFxDirection = direction === 'to' ? 'to' : 'from';
  const btn = document.getElementById('activityFxButton');
  if (btn) btn.textContent = activityFxDirection === 'to' ? 'Convert B -> A' : 'Convert A -> B';
}

function syncActivitySavedCostFromConverter() {
  const tripCurrency = getActivityTargetCurrency();
  const fromCurrency = document.getElementById('fActFromCur').value;
  const toCurrency = document.getElementById('fActToCur').value;
  const fromAmount = Number(document.getElementById('fActFromAmt').value || 0);
  const toAmount = Number(document.getElementById('fActToAmt').value || 0);
  const costInput = document.getElementById('fActCost');
  if (!costInput) return;

  if (fromCurrency === tripCurrency && fromAmount > 0) {
    costInput.value = fromAmount.toFixed(2);
    return;
  }
  if (toCurrency === tripCurrency && toAmount > 0) {
    costInput.value = toAmount.toFixed(2);
  }
}

function populateActivityCurrencySelects(targetCurrency) {
  const fromSelect = document.getElementById('fActFromCur');
  const toSelect = document.getElementById('fActToCur');
  if (!fromSelect || !toSelect) return;
  const options = FX_CURRENCIES.map(c => `<option value="${c}">${c}</option>`).join('');
  fromSelect.innerHTML = options;
  toSelect.innerHTML = options;

  const fallback = FX_CURRENCIES.includes(targetCurrency) ? targetCurrency : 'MYR';
  fromSelect.value = fallback;
  toSelect.value = fallback === 'USD' ? 'MYR' : 'USD';
  if (toSelect.value === fallback) toSelect.value = 'EUR';
  setActivityFxDirection('from');
}

async function convertActivityCost(forcedDirection = null) {
  const direction = forcedDirection || activityFxDirection || 'from';
  const fromCurrency = document.getElementById('fActFromCur').value;
  const toCurrency = document.getElementById('fActToCur').value;
  const fromInput = document.getElementById('fActFromAmt');
  const toInput = document.getElementById('fActToAmt');

  const sourceCurrency = direction === 'to' ? toCurrency : fromCurrency;
  const targetCurrency = direction === 'to' ? fromCurrency : toCurrency;
  const sourceAmount = Number(direction === 'to' ? toInput.value : fromInput.value);

  if (!sourceAmount || sourceAmount <= 0) {
    setActivityFxNote(`Enter Amount ${direction === 'to' ? 'B' : 'A'} first.`, true);
    return;
  }

  try {
    const result = await fetchConvertedAmount(sourceAmount, sourceCurrency, targetCurrency);
    const converted = result.converted.toFixed(2);
    if (direction === 'to') fromInput.value = converted;
    else toInput.value = converted;
    setActivityFxNote(formatFxNote(sourceCurrency, targetCurrency, result));
    syncActivitySavedCostFromConverter();
  } catch (error) {
    setActivityFxNote(error.message, true);
  }
}

function openAddActivityModal(dayId) {
  const targetCurrency = currentTripData?.currency || currency || 'MYR';
  populateActivityCurrencySelects(targetCurrency);
  setActivityCostHint(targetCurrency);
  document.getElementById('fActId').value = '';
  document.getElementById('fActDayId').value = dayId;
  document.getElementById('fActTime').value = '';
  document.getElementById('fActCat').value = 'attraction';
  document.getElementById('fActTitle').value = '';
  document.getElementById('fActDesc').value = '';
  document.getElementById('fActLoc').value = '';
  document.getElementById('fActFromAmt').value = '';
  document.getElementById('fActToAmt').value = '';
  document.getElementById('fActCost').value = '';
  setActivityFxNote('');
  document.getElementById('activityFxPanel').open = false;
  document.getElementById('activityModalTitle').textContent = 'Add Activity';
  document.getElementById('activityModalSaveBtn').textContent = 'Add Activity';
  openModal('modalAddActivity');
}

async function openEditActivityModal(id) {
  const activity = await dbGetById('activities', id);
  if (!activity) return;
  const targetCurrency = currentTripData?.currency || currency || 'MYR';
  populateActivityCurrencySelects(targetCurrency);
  setActivityCostHint(targetCurrency);
  document.getElementById('fActId').value = activity.id;
  document.getElementById('fActDayId').value = activity.day_id;
  document.getElementById('fActTime').value = activity.time || '';
  document.getElementById('fActCat').value = activity.category || 'attraction';
  document.getElementById('fActTitle').value = activity.title || '';
  document.getElementById('fActDesc').value = activity.description || '';
  document.getElementById('fActLoc').value = activity.location || '';
  document.getElementById('fActFromCur').value = targetCurrency;
  document.getElementById('fActFromAmt').value = activity.cost || '';
  document.getElementById('fActToAmt').value = '';
  document.getElementById('fActCost').value = activity.cost || '';
  setActivityFxDirection('from');
  setActivityFxNote('');
  document.getElementById('activityFxPanel').open = false;
  document.getElementById('activityModalTitle').textContent = 'Edit Activity';
  document.getElementById('activityModalSaveBtn').textContent = 'Save Changes';
  openModal('modalAddActivity');
}

function closeActivityModal() {
  closeModal('modalAddActivity');
  document.getElementById('fActId').value = '';
  setActivityFxNote('');
}

async function saveActivity() {
  const activityId = document.getElementById('fActId').value;
  const title = document.getElementById('fActTitle').value.trim();
  if (!title) { setActivityFxNote('Activity name is required.', true); return; }
  const tripCurrency = getActivityTargetCurrency();
  const fromCurrency = document.getElementById('fActFromCur').value;
  const toCurrency = document.getElementById('fActToCur').value;
  const fromAmount = Number(document.getElementById('fActFromAmt').value || 0);
  const toAmount = Number(document.getElementById('fActToAmt').value || 0);
  let cost = Number(document.getElementById('fActCost').value || 0);

  if (!cost) {
    if (fromCurrency === tripCurrency && fromAmount > 0) cost = fromAmount;
    else if (toCurrency === tripCurrency && toAmount > 0) cost = toAmount;
    else if (fromAmount > 0) {
      try {
        const result = await fetchConvertedAmount(fromAmount, fromCurrency, tripCurrency);
        cost = Number(result.converted.toFixed(2));
        const source = result.cached ? `${result.date || 'cached'} ¬∑ cached` : result.date;
        setActivityFxNote(`Saved in ${tripCurrency} using ${fromCurrency} rate (${source})`);
      } catch (error) {
        setActivityFxNote(error.message, true);
      }
    } else if (toAmount > 0) {
      try {
        const result = await fetchConvertedAmount(toAmount, toCurrency, tripCurrency);
        cost = Number(result.converted.toFixed(2));
        const source = result.cached ? `${result.date || 'cached'} ¬∑ cached` : result.date;
        setActivityFxNote(`Saved in ${tripCurrency} using ${toCurrency} rate (${source})`);
      } catch (error) {
        setActivityFxNote(error.message, true);
      }
    }
  }
  const normalizedCost = Number.isFinite(cost) && cost > 0 ? cost : 0;

  const obj = {
    trip_id: currentTripId,
    day_id: document.getElementById('fActDayId').value,
    time: document.getElementById('fActTime').value,
    category: document.getElementById('fActCat').value,
    title, description: document.getElementById('fActDesc').value,
    location: document.getElementById('fActLoc').value,
    cost: normalizedCost
  };
  if (activityId) {
    await dbUpdate('activities', activityId, obj);
  } else {
    await dbInsert('activities', obj);
  }
  closeActivityModal();
  ['fActTime','fActTitle','fActDesc','fActLoc','fActFromAmt','fActToAmt','fActCost'].forEach(id => document.getElementById(id).value = '');
  loadDays();
}

function openAddAccomModal() { openModal('modalAddAccom'); }
async function saveAccom() {
  const name = document.getElementById('fAccomName').value.trim();
  if (!name) { toast('Please enter a property name', 'error'); return; }
  await dbInsert('accommodations', { trip_id: currentTripId, name, address: document.getElementById('fAccomAddr').value, check_in: document.getElementById('fAccomIn').value, check_out: document.getElementById('fAccomOut').value, confirmation: document.getElementById('fAccomConf').value, cost: document.getElementById('fAccomCost').value||0, notes: document.getElementById('fAccomNotes').value });
  closeModal('modalAddAccom'); toast('Accommodation saved!'); loadAccom();
}

function openAddTransportModal() { openModal('modalAddTransport'); }
async function saveTransport() {
  await dbInsert('transports', { trip_id: currentTripId, type: document.getElementById('fTransType').value, from_location: document.getElementById('fTransFrom').value, to_location: document.getElementById('fTransTo').value, departure: document.getElementById('fTransDep').value, arrival: document.getElementById('fTransArr').value, operator: document.getElementById('fTransOp').value, confirmation: document.getElementById('fTransConf').value, cost: document.getElementById('fTransCost').value||0, notes: document.getElementById('fTransNotes').value });
  closeModal('modalAddTransport'); toast('Transport saved!'); loadTransport();
}

function setExpenseFxNote(message, isError = false) {
  const note = document.getElementById('expenseFxNote');
  if (!note) return;
  note.textContent = message;
  note.style.color = isError ? 'var(--terracotta)' : 'var(--mist)';
}

function populateExpenseCurrencySelects(targetCurrency) {
  const fromSelect = document.getElementById('fExpFromCur');
  const toSelect = document.getElementById('fExpToCur');
  if (!fromSelect || !toSelect) return;
  const options = FX_CURRENCIES.map(c => `<option value="${c}">${c}</option>`).join('');
  fromSelect.innerHTML = options;
  toSelect.innerHTML = options;

  const fallback = FX_CURRENCIES.includes(targetCurrency) ? targetCurrency : 'MYR';
  fromSelect.value = fallback;
  toSelect.value = fallback;
}

async function fetchConvertedAmount(amount, fromCurrency, toCurrency) {
  if (!Number.isFinite(amount) || amount <= 0) throw new Error('Amount must be greater than 0');
  if (!fromCurrency || !toCurrency) throw new Error('Please choose both currencies');
  if (fromCurrency === toCurrency) {
    return { converted: amount, rate: 1, date: new Date().toISOString().slice(0, 10), cached: false };
  }

  try {
    const endpoint = `${FX_API_BASE}/latest?base=${encodeURIComponent(fromCurrency)}&symbols=${encodeURIComponent(toCurrency)}`;
    const response = await fetch(endpoint);
    if (!response.ok) throw new Error('Unable to fetch live exchange rate');
    const data = await response.json();
    const rate = Number(data?.rates?.[toCurrency]);
    if (!Number.isFinite(rate)) throw new Error('Exchange rate unavailable for selected currency pair');
    saveFxRate(fromCurrency, toCurrency, rate, data.date || '');
    return { converted: amount * rate, rate, date: data.date || '', cached: false };
  } catch (error) {
    const cached = loadFxRate(fromCurrency, toCurrency);
    if (cached) {
      return { converted: amount * cached.rate, rate: cached.rate, date: cached.date || '', cached: true };
    }
    if (!isOnline()) throw new Error('Offline: this currency pair has no cached rate yet');
    throw error;
  }
}

async function convertExpenseAmount() {
  const fromCurrency = document.getElementById('fExpFromCur').value;
  const toCurrency = document.getElementById('fExpToCur').value;
  const sourceAmount = Number(document.getElementById('fExpFromAmt').value);
  if (!sourceAmount || sourceAmount <= 0) {
    setExpenseFxNote('Enter source amount first.', true);
    toast('Enter source amount first', 'error');
    return;
  }

  try {
    const result = await fetchConvertedAmount(sourceAmount, fromCurrency, toCurrency);
    document.getElementById('fExpAmt').value = result.converted.toFixed(2);
    setExpenseFxNote(formatFxNote(fromCurrency, toCurrency, result));
  } catch (error) {
    setExpenseFxNote(error.message, true);
    toast(error.message, 'error');
  }
}

function openAddExpenseModal() {
  const targetCurrency = currentTripData?.currency || currency || 'MYR';
  populateExpenseCurrencySelects(targetCurrency);
  document.getElementById('fExpItem').value = '';
  document.getElementById('fExpDate').value = new Date().toISOString().slice(0, 10);
  document.getElementById('fExpFromAmt').value = '';
  document.getElementById('fExpAmt').value = '';
  document.getElementById('fExpNotes').value = '';
  setExpenseFxNote(`Convert any currency into ${targetCurrency} before saving.`);
  openModal('modalAddExpense');
}

async function saveExpense() {
  const item = document.getElementById('fExpItem').value.trim();
  if (!item) { toast('Please enter an item name', 'error'); return; }
  const fromCurrency = document.getElementById('fExpFromCur').value;
  const toCurrency = document.getElementById('fExpToCur').value;
  const sourceAmount = Number(document.getElementById('fExpFromAmt').value || 0);
  let amount = Number(document.getElementById('fExpAmt').value || 0);

  if (!amount && sourceAmount > 0) {
    try {
      const result = await fetchConvertedAmount(sourceAmount, fromCurrency, toCurrency);
      amount = Number(result.converted.toFixed(2));
      document.getElementById('fExpAmt').value = amount;
      setExpenseFxNote(formatFxNote(fromCurrency, toCurrency, result));
    } catch (error) {
      setExpenseFxNote(error.message, true);
      toast(error.message, 'error');
      return;
    }
  }

  if (!amount || amount <= 0) {
    toast('Please enter or convert an amount first', 'error');
    return;
  }

  await dbInsert('expenses', {
    trip_id: currentTripId,
    item,
    category: document.getElementById('fExpCat').value,
    date: document.getElementById('fExpDate').value,
    amount,
    notes: document.getElementById('fExpNotes').value
  });
  closeModal('modalAddExpense'); toast('Expense recorded!');
  ['fExpItem','fExpDate','fExpFromAmt','fExpAmt','fExpNotes'].forEach(id => document.getElementById(id).value='');
  setExpenseFxNote('');
  loadBudget();
}

function openAddPackingModal() { openModal('modalAddPacking'); }
async function savePacking() {
  const item = document.getElementById('fPackItem').value.trim();
  if (!item) { toast('Item name required', 'error'); return; }
  await dbInsert('packing', { trip_id: currentTripId, item, category: document.getElementById('fPackCat').value, packed: false });
  closeModal('modalAddPacking'); toast('Item added!');
  document.getElementById('fPackItem').value = '';
  loadPacking();
}

// ‚îÄ‚îÄ‚îÄ Utilities ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function formatDate(d) {
  if (!d) return '‚Äî';
  const dt = new Date(d + 'T00:00:00');
  return dt.toLocaleDateString('en-GB', { day:'numeric', month:'short', year:'numeric' });
}

function toast(msg, type = 'success') {
  const el = document.createElement('div');
  el.className = `toast ${type}`;
  el.textContent = msg;
  document.getElementById('toastContainer').appendChild(el);
  setTimeout(() => el.remove(), 3000);
}

// ‚îÄ‚îÄ‚îÄ Boot ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
initApp();
</script>
</body>
</html>
